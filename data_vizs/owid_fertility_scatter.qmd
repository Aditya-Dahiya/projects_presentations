---
title: "OWID Fertility Scatter"
author: "Aditya Dahiya"
date: "2024-07-11"
subtitle: "............................................."
categories:
  - "A4 Size Viz"
  - "Our World in Data"
  - "Public Health"
image: "thumbnails/owid_fertility.png"
format:
  html:
    code-fold: true
editor_options: 
  chunk_output_type: console
execute: 
  error: false
  message: false
  warning: false
  eval: false
filters:
  - social-share
share:
  permalink: "https://aditya-dahiya.github.io/session_presentations/data_vizs.html"
  twitter: true
  linkedin: true
  email: true
  mastodon: true
bibliography: references.bib
---

**Source of the Data:** The fertility rate data is sourced from the United Nations' World Population Prospects (2022) and has been processed and presented by Our World in Data. The dataset provides the average number of live births a hypothetical cohort of women would have at the end of their reproductive period, assuming they experienced the fertility rates of a specific period throughout their lives without mortality impact. The data covers the period from 1950 to 2021 and is measured in live births per woman. Age-specific fertility rates are included, indicating the number of births to women in particular age groups, divided by the number of women in those groups, across annual civil calendar years. This dataset, part of the 27th edition of the official global population estimates, is based on extensive data on population size, fertility, mortality, and international migration for 237 countries or areas. For more information, visit the UN's World Population Prospects page [here](https://population.un.org/wpp/Download/) and [here](https://population.un.org/wpp/Publications/). The data was retrieved on September 9, 2022. Our World in Data processes the data through various steps to ensure accuracy, including standardizing country names, converting units, and calculating derived indicators. Detailed information on their data processing can be found [here](https://population.un.org/wpp/Download/). For citation purposes, use: UN, World Population Prospects (2022) â€“ processed by Our World in Data.

![.....................](owid_fertility_scatter.png){#fig-2}

### How I made these graphics?

Getting the data

```{r}
#| label: setup

# Data Import and Wrangling Tools
library(tidyverse)            # All things tidy
library(owidR)                # Get data from Our World in R

# Final plot tools
library(scales)               # Nice Scales for ggplot2
library(fontawesome)          # Icons display in ggplot2
library(ggtext)               # Markdown text support
library(showtext)             # Display fonts in ggplot2
library(colorspace)           # To lighten and darken colours
library(patchwork)            # Combining plots

search1 <- owidR::owid_search("fertility")

df1 <- owid("children-per-woman-un")

popdf <- owid("population-with-un-projections")

```

Visualization Parameters

```{r}
#| label: parameters2

# Font for titles
font_add_google("Chakra Petch",
  family = "title_font"
) 

# Font for the caption
font_add_google("Saira Semi Condensed",
  family = "caption_font"
) 

# Font for plot text
font_add_google("Changa",
  family = "body_font"
) 

showtext_auto()

# Colour Palette
mypal <- rev(paletteer::paletteer_d("LaCroixColoR::Lime")[c(1,2,4:6)])

# Background Colour
bg_col <- "grey98"
text_col <- "grey10"
text_hil <- "grey25"

# Base Text Size
bts <- 80

plot_title <- "Declining Global Fertility Rates (1950-2020)"

plot_subtitle <- "The fertility rate, representing the average number of live births per woman, has notably declined from 1950 to 2020, driven largely by reductions in middle-income countries such as India and China. This graphic highlights this global trend, while also showing that the poorest and war-torn nations have experienced minimal decline in fertility rates. Nearly half of the world's population now has fertility rates below the replacement level."

data_annotation <- "About the Data: This data on fertility rates, sourced from the United Nations' World Population Prospects (2022) and processed by Our World in Data, spans from 1950 to 2021. It reflects the average number of live births per woman, with age-specific rates, providing insights into global fertility trends across decades."

# Caption stuff for the plot
sysfonts::font_add(
  family = "Font Awesome 6 Brands",
  regular = here::here("docs", "Font Awesome 6 Brands-Regular-400.otf")
)
github <- "&#xf09b"
github_username <- "aditya-dahiya"
xtwitter <- "&#xe61b"
xtwitter_username <- "@adityadahiyaias"
social_caption_1 <- glue::glue("<span style='font-family:\"Font Awesome 6 Brands\";'>{github};</span> <span style='color: {text_hil}'>{github_username}  </span>")
social_caption_2 <- glue::glue("<span style='font-family:\"Font Awesome 6 Brands\";'>{xtwitter};</span> <span style='color: {text_hil}'>{xtwitter_username}</span>")

plot_caption <- paste0(
  "**Data:** United Nations & Our World in Data  |  ",
  "**Code:** ", 
  social_caption_1, 
  " |  **Graphics:** ", 
  social_caption_2
  )
rm(github, github_username, xtwitter, 
   xtwitter_username, social_caption_1, social_caption_2)
```

Data Wrangling

```{r}
#| label: data-wrangling

# A tibble for the fertility levels in each decade
df2 <- df1 |> 
  as_tibble() |> 
  janitor::clean_names() |> 
  rename(fertility = fertility_rate_sex_all_age_all_variant_estimates) |> 
  filter(!is.na(code)) |> 
  filter(entity != "World")


# A tibble of populations for each coutnry in each decade
popdf1 <- popdf |> 
  as_tibble() |> 
  janitor::clean_names() |> 
  filter(!is.na(code)) |> 
  filter(entity != "World") |> 
  mutate(
    population = ifelse(
      is.na(population_sex_all_age_all_variant_estimates),
      population_sex_all_age_all_variant_medium,
      population_sex_all_age_all_variant_estimates
    )
  ) |> 
  select(-c(population_sex_all_age_all_variant_estimates,
            population_sex_all_age_all_variant_medium))


# df2 |> 
#   left_join(popdf1) |> 
#   drop_na() |> 
#   group_by(year) |> 
#   summarise(
#     fertility = weighted.mean(x = fertility, w = population, na.rm = T)
#   ) |> 
#   ggplot(aes(x = year, y = fertility)) +
#   geom_point() +
#   geom_line()

df_continents <- rnaturalearth::ne_countries() |> 
  as_tibble() |> 
  janitor::clean_names() |> 
  select(iso_a3, continent) |> 
  rename(code = iso_a3)

df3 <- df2 |> 
  left_join(popdf1) |>
  left_join(df_continents) |> 
  drop_na() |> 
  filter(year >= 1951 & year <= 2020) |> 
  mutate(
    year = cut(
      year, 
      breaks = seq(1950, 2020, 10), 
      labels = paste0(seq(1950, 2010, 10), "s")
      )
  ) |> 
  group_by(continent, entity, code, year) |> 
  summarise(
    fertility = weighted.mean(fertility, w = population, na.rm = T),
    population = mean(population, na.rm = T)
  )

df4 <- df2 |> 
  left_join(popdf1) |>
  drop_na() |> 
  filter(year >= 1951 & year <= 2020) |> 
  mutate(
    year = cut(
      year, 
      breaks = seq(1950, 2020, 10), 
      labels = paste0(seq(1950, 2010, 10), "s")
      )
  ) |> 
  group_by(year) |> 
  summarise(
    fertility = weighted.mean(fertility, w = population, na.rm = T)
  )


```

Visualization

```{r}
#| label: visualize-1

df3 |> 
  ggplot(
    aes(
      x = year, 
      y = fertility
    )
  ) +
  geom_hline(
    yintercept = 2.1,
    linetype = 3,
    colour = "grey50"
  ) +
  geom_point(
    mapping = aes(
      size = population,
      colour = continent
    ),
    pch = 20,
    alpha = 0.7,
    position = position_jitter(
      width = 0.2,
      height = 0
    )
  ) +
  geom_segment(
    data = df4,
    mapping = aes(
      x = as.numeric(year) - 0.3,
      xend = as.numeric(year) + 0.3,
      y = fertility,
      yend = fertility
    ),
    colour = "black",
    linewidth = 3,
    alpha = 0.2
  ) +
  geom_text(
    data = df4,
    mapping = aes(
      x = year,
      y = fertility,
      label = paste0("TFR: ", round(fertility, 1))
    ),
    colour = "grey10",
    family = "body_font"
  ) +
  scale_y_continuous(
    expand = expansion(0),
    limits = c(1, 8.5),
    breaks = 1:8
  ) +
  paletteer::scale_color_paletteer_d("awtools::spalette") +
  scale_size_continuous(
    range = c(0.2, 10)
  ) +
  guides(
    size = "none",
    colour = guide_legend(
      override.aes = list(
        size = 5
      )
    )
  ) +
  labs(
    title = plot_title,
    subtitle = plot_subtitle,
    caption = plot_caption,
    x = NULL,
    y = "Fertility rate (average children per woman)",
    colour = NULL
  ) +
  theme_minimal(
    base_family = "body_font",
    base_size = 11
  ) +
  theme(
    panel.grid = element_blank(),
    axis.line.y = element_line(
      arrow = arrow(ends = "both", length = unit(2, "mm"))
    ),
    legend.position = "right",
    plot.caption = element_textbox(
      hjust = 0.5,
      family = "caption_font",
      colour = text_hil
    )
  )
```

Adding insets and annotations using [@patchwork]

```{r}
#| label: insets

# QR Code for the plot
url_graphics <- paste0(
  "https://aditya-dahiya.github.io/projects_presentations/projects/",
  # The file name of the current .qmd file
  "owid_fertility",
  ".qmd"
)
# remotes::install_github('coolbutuseless/ggqr')
# library(ggqr)
plot_qr <- ggplot(
  data = NULL, 
  aes(x = 0, y = 0, label = url_graphics)
  ) + 
  ggqr::geom_qr(
    colour = text_hil, 
    fill = bg_col,
    size = 2.2
    ) +
  # labs(caption = "Scan for the Interactive Version") +
  coord_fixed() +
  theme_void() +
  theme(plot.background = element_rect(
    fill = NA, 
    colour = NA
    ),
    plot.caption = element_text(
      hjust = 0.5,
      margin = margin(0,0,0,0, "mm"),
      family = "caption_font",
      size = bts/1.8
    )
  )

plot_data <- ggplot() +
  annotate(
    geom = "text",
    x = 0, y = 0,
    label = str_wrap(data_annotation, 30),
    family = "caption_font",
    colour = text_hil,
    lineheight = 0.3, 
    size = bts / 6,
    hjust = 0
  ) +
  theme_void()

g_full <- g +
  inset_element(
    p = plot_data,
    left = -0.07, right = 0.12,
    top = 0.8, bottom = 0.6,
    align_to = "full",
    clip = FALSE
  ) +
  inset_element(
    p = plot_qr,
    left = 0.025, right = 0.12,
    top = 0.98, bottom = 0.77,
    align_to = "full",
    clip = FALSE
  ) +
  plot_annotation(
    theme = theme(
      plot.background = element_rect(
        fill = "transparent", colour = "transparent"
      ),
      panel.background = element_rect(
        fill = "transparent", colour = "transparent"
      )
    )
  )
```

Save the graphic and a thumbnail

```{r}
#| label: save-plot

ggsave(
  filename = here::here("data_vizs", "a4_owid_fertility.png"),
  plot = g_full,
  width = 297 * 2,
  height = 210 * 2,
  units = "mm",
  bg = bg_col
)

library(magick)
# Saving a thumbnail for the webpage
image_read(here::here("data_vizs", 
                      "a4_owid_fertility.png")) |> 
  image_resize(geometry = "400") |> 
  image_write(here::here("data_vizs", "thumbnails", 
                         "owid_fertility.png"))
```
