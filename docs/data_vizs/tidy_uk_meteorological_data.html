<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aditya Dahiya">
<meta name="dcterms.date" content="2025-10-21">

<title>UK Weather Extremes: A Century of Records – Data Viz Collective</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/social-share-0.1.0/social-share.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/social-share-0.1.0/all.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../site_libs/core-js-2.5.3/shim.min.js"></script>

<script src="../site_libs/react-18.2.0/react.min.js"></script>

<script src="../site_libs/react-18.2.0/react-dom.min.js"></script>

<script src="../site_libs/reactwidget-2.0.0/react-tools.js"></script>

<script src="../site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>

<link href="../site_libs/reactable-0.4.4/reactable.css" rel="stylesheet">

<script src="../site_libs/reactable-binding-0.4.4/reactable.js"></script>



<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../docs/aditya_dahiya_er_sheet.jpg" alt="Data Viz Collective" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Viz Collective</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../presentations.html"> 
<span class="menu-text">Presentations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../data_vizs.html"> 
<span class="menu-text">Data Visualizations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools tools-wide">
    <a href="../index.xml" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-rss"></i></a>
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/Aditya-Dahiya/projects_presentations">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/Aditya-Dahiya/projects_presentations/issues">
            Suggestions / Feedback
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#about-the-data" id="toc-about-the-data" class="nav-link active" data-scroll-target="#about-the-data">About the Data</a>
  <ul class="collapse">
  <li><a href="#how-i-made-this-graphic" id="toc-how-i-made-this-graphic" class="nav-link" data-scroll-target="#how-i-made-this-graphic">How I Made This Graphic</a>
  <ul class="collapse">
  <li><a href="#loading-required-libraries" id="toc-loading-required-libraries" class="nav-link" data-scroll-target="#loading-required-libraries">Loading required libraries</a></li>
  <li><a href="#visualization-parameters" id="toc-visualization-parameters" class="nav-link" data-scroll-target="#visualization-parameters">Visualization Parameters</a></li>
  <li><a href="#exploratory-data-analysis-and-wrangling" id="toc-exploratory-data-analysis-and-wrangling" class="nav-link" data-scroll-target="#exploratory-data-analysis-and-wrangling">Exploratory Data Analysis and Wrangling</a></li>
  <li><a href="#the-plot" id="toc-the-plot" class="nav-link" data-scroll-target="#the-plot">The Plot</a></li>
  <li><a href="#savings-the-thumbnail-for-the-webpage" id="toc-savings-the-thumbnail-for-the-webpage" class="nav-link" data-scroll-target="#savings-the-thumbnail-for-the-webpage">Savings the thumbnail for the webpage</a></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  <li><a href="#attempt-2-add-custom-functions" id="toc-attempt-2-add-custom-functions" class="nav-link" data-scroll-target="#attempt-2-add-custom-functions">Attempt 2: Add custom functions</a></li>
  <li><a href="#create-repelled-marquee-text-plot" id="toc-create-repelled-marquee-text-plot" class="nav-link" data-scroll-target="#create-repelled-marquee-text-plot">Create repelled marquee text plot</a></li>
  </ul></li>
  </ul></li>
  <li>Links</li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/Aditya-Dahiya/projects_presentations/edit/main/data_vizs/tidy_uk_meteorological_data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/Aditya-Dahiya/projects_presentations/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">UK Weather Extremes: A Century of Records</h1>
<p class="subtitle lead">Mapping extreme weather across the UK using Met Office data (1853-2025): {ggrepel} with richly formatted text on maps in R</p>
  <div class="quarto-categories">
    <div class="quarto-category">#TidyTuesday</div>
    <div class="quarto-category">{ggrepel}</div>
    <div class="quarto-category">Maps</div>
    <div class="quarto-category">Repel richtext</div>
    <div class="quarto-category">{marquee}</div>
    <div class="quarto-category">{ggtext}</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Aditya Dahiya </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 21, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="about-the-data" class="level1">
<h1>About the Data</h1>
<p>This dataset features historic meteorological data from 37 weather stations across the United Kingdom, curated from the <a href="https://www.metoffice.gov.uk/">UK Met Office</a>‘s <a href="https://www.metoffice.gov.uk/research/climate/maps-and-data/historic-station-data">historic station data collection</a>. The <a href="https://www.metoffice.gov.uk/">Met Office</a>, established in 1854 as one of the world’s oldest weather services, serves as the UK’s national weather and climate authority. The dataset includes monthly measurements spanning from as early as 1853 to the present, tracking key variables such as maximum and minimum temperatures, air frost days, rainfall, and sunshine duration. Each station’s metadata provides geographic coordinates in <a href="https://epsg.io/4326">EPSG:4326 format</a> and opening dates. The data undergoes basic cleaning with estimated data flags and historical monitoring technique variations removed for simplicity, though these details remain available in the raw source data. Station files are updated monthly, approximately 10 days after month-end, with measurements reflecting the stations’ operational history without adjustments for site changes or instrumentation developments over time. This comprehensive dataset was curated by <a href="https://github.com/jack-davison">Jack Davison</a> for the <a href="https://github.com/rfordatascience/tidytuesday">#TidyTuesday</a> project.</p>
<div id="fig-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="tidy_uk_meteorological_data.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Geographic distribution of UK Met Office weather stations with their record-breaking measurements. Each station marker is labeled with its most extreme climate events: maximum temperature (red), minimum temperature (blue), and highest monthly rainfall (green). Dates in parentheses indicate when these records were set. Station opening years range from 1853 to recent decades, representing one of the most comprehensive historic meteorological datasets in the world and documenting Britain’s climate variability across generations.
</figcaption>
</figure>
</div>
<section id="how-i-made-this-graphic" class="level2">
<h2 class="anchored" data-anchor-id="how-i-made-this-graphic">How I Made This Graphic</h2>
<section id="loading-required-libraries" class="level3">
<h3 class="anchored" data-anchor-id="loading-required-libraries">Loading required libraries</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  tidyverse, <span class="co"># All things tidy</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  scales, <span class="co"># Nice Scales for ggplot2</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  fontawesome, <span class="co"># Icons display in ggplot2</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  ggtext, <span class="co"># Markdown text support for ggplot2</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  showtext, <span class="co"># Display fonts in ggplot2</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  colorspace, <span class="co"># Lighten and Darken colours</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  sf, <span class="co"># for maps</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  patchwork  <span class="co"># Composing Plots</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  sf,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  ggrepel,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  ggtext,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  grid,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  gridtext</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>historic_station_met <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-21/historic_station_met.csv'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>station_meta <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">'https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-10-21/station_meta.csv'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualization-parameters" class="level3">
<h3 class="anchored" data-anchor-id="visualization-parameters">Visualization Parameters</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Font for titles</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">font_add_google</span>(<span class="st">"Saira"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"title_font"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Font for the caption</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">font_add_google</span>(<span class="st">"Saira Condensed"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"body_font"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Font for plot text</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">font_add_google</span>(<span class="st">"Saira Extra Condensed"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"caption_font"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">showtext_auto</span>()</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># A base Colour</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>bg_col <span class="ot">&lt;-</span> <span class="st">"white"</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>seecolor<span class="sc">::</span><span class="fu">print_color</span>(bg_col)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Colour for highlighted text</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>text_hil <span class="ot">&lt;-</span> <span class="st">"grey40"</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>seecolor<span class="sc">::</span><span class="fu">print_color</span>(text_hil)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Colour for the text</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>text_col <span class="ot">&lt;-</span> <span class="st">"grey30"</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>seecolor<span class="sc">::</span><span class="fu">print_color</span>(text_col)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>line_col <span class="ot">&lt;-</span> <span class="st">"grey30"</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Base Text Size</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>bts <span class="ot">&lt;-</span> <span class="dv">180</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the actual colors from chosen palette</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>day_colors <span class="ot">&lt;-</span> paletteer<span class="sc">::</span><span class="fu">paletteer_d</span>(<span class="st">"ghibli::PonyoDark"</span>, <span class="at">n =</span> <span class="dv">7</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(day_colors) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sun"</span>, <span class="st">"Mon"</span>, <span class="st">"Tue"</span>, <span class="st">"Wed"</span>, <span class="st">"Thu"</span>, <span class="st">"Fri"</span>, <span class="st">"Sat"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Caption stuff for the plot</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>sysfonts<span class="sc">::</span><span class="fu">font_add</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"Font Awesome 6 Brands"</span>,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">regular =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"docs"</span>, <span class="st">"Font Awesome 6 Brands-Regular-400.otf"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>github <span class="ot">&lt;-</span> <span class="st">"&amp;#xf09b"</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>github_username <span class="ot">&lt;-</span> <span class="st">"aditya-dahiya"</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>xtwitter <span class="ot">&lt;-</span> <span class="st">"&amp;#xe61b"</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>xtwitter_username <span class="ot">&lt;-</span> <span class="st">"@adityadahiyaias"</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>social_caption_1 <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"&lt;span style='font-family:</span><span class="sc">\"</span><span class="st">Font Awesome 6 Brands</span><span class="sc">\"</span><span class="st">;'&gt;{github};&lt;/span&gt; &lt;span style='color: {text_hil}'&gt;{github_username}  &lt;/span&gt;"</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>social_caption_2 <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"&lt;span style='font-family:</span><span class="sc">\"</span><span class="st">Font Awesome 6 Brands</span><span class="sc">\"</span><span class="st">;'&gt;{xtwitter};&lt;/span&gt; &lt;span style='color: {text_hil}'&gt;{xtwitter_username}&lt;/span&gt;"</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>plot_caption <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"**Data:**  Jack Davison, UK Met Office"</span>,</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">" |  **Code:** "</span>,</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>  social_caption_1,</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">" |  **Graphics:** "</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>  social_caption_2</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>  github, github_username, xtwitter,</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>  xtwitter_username, social_caption_1,</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>  social_caption_2</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text to plot-------------------------------------------------</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>plot_title <span class="ot">&lt;-</span> <span class="st">"UK Weather Extremes:</span><span class="sc">\n</span><span class="st">A Century of Records"</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>plot_subtitle <span class="ot">&lt;-</span> <span class="st">"Visualizing historic meteorological</span><span class="sc">\n</span><span class="st">data from 37 UK Met Office weather</span><span class="sc">\n</span><span class="st">stations (1853-2025).</span><span class="sc">\n</span><span class="st"> </span><span class="sc">\n</span><span class="st">Created with</span><span class="sc">\n</span><span class="st">{ggplot2}, {sf}, and</span><span class="sc">\n</span><span class="st">{ggtext} to map</span><span class="sc">\n</span><span class="st">extreme temperature</span><span class="sc">\n</span><span class="st">and rainfall records</span><span class="sc">\n</span><span class="st">across Britain and</span><span class="sc">\n</span><span class="st">Ireland."</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="fu">str_view</span>(plot_subtitle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="exploratory-data-analysis-and-wrangling" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-and-wrangling">Exploratory Data Analysis and Wrangling</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_load(summarytools)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># historic_station_met |&gt; </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   dfSummary() |&gt; </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   view()</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_unload(summarytools)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>df_tmax <span class="ot">&lt;-</span> historic_station_met <span class="sc">|&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station) <span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">order_by =</span> tmax,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">with_ties =</span> <span class="cn">FALSE</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(tmax,<span class="dv">1</span>), <span class="st">"°C"</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmax_month =</span> <span class="fu">paste0</span>(month.abb[month], <span class="st">" "</span>, year),</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>df_tmin <span class="ot">&lt;-</span> historic_station_met <span class="sc">|&gt;</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station) <span class="sc">|&gt;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">order_by =</span> tmin,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">with_ties =</span> <span class="cn">FALSE</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(tmin,<span class="dv">1</span>), <span class="st">"°C"</span>),</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">tmin_month =</span> <span class="fu">paste0</span>(month.abb[month], <span class="st">" "</span>, year),</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>df_rain <span class="ot">&lt;-</span> historic_station_met <span class="sc">|&gt;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(station) <span class="sc">|&gt;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">order_by =</span> rain,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">with_ties =</span> <span class="cn">FALSE</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">rain =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(rain, <span class="dv">0</span>), <span class="st">" mm"</span>),</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">rain_month =</span> <span class="fu">paste0</span>(month.abb[month], <span class="st">" "</span>, year),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">.keep =</span> <span class="st">"none"</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a map of Stations of UK Met</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>plotdf <span class="ot">&lt;-</span> station_meta <span class="sc">|&gt;</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_tmax) <span class="sc">|&gt;</span> </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_tmin) <span class="sc">|&gt;</span> </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(df_rain) <span class="sc">|&gt;</span> </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lng"</span>, <span class="st">"lat"</span>),</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="st">"EPSG:4326"</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>british_map <span class="ot">&lt;-</span> rnaturalearth<span class="sc">::</span><span class="fu">ne_countries</span>(</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">returnclass =</span> <span class="st">"sf"</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="dv">10</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    iso_a2 <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"GB"</span>, <span class="st">"IE"</span>)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name, iso_a2, geometry)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-plot" class="level3">
<h3 class="anchored" data-anchor-id="the-plot">The Plot</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bts <span class="ot">=</span> <span class="dv">160</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> plotdf <span class="sc">|&gt;</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> british_map,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> name),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey80"</span>, <span class="st">"grey50"</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">9</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.2</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  ggtext<span class="sc">::</span><span class="fu">geom_richtext</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">3</span>, <span class="st">"pt;'&gt;"</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        station_name, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">4</span>, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        opened, <span class="st">")&lt;/span&gt;&lt;br&gt;"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt; color:#D9565CFF;'&gt;"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        tmax, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        tmax_month, <span class="st">")&lt;/span&gt;"</span>,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt;'&gt;   |   &lt;/span&gt;"</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt; color:#1BB6AFFF;'&gt;"</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        tmin, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        tmin_month, <span class="st">")&lt;/span&gt;&lt;br&gt;"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt; color:#0076C0FF;'&gt;"</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        rain, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="dv">6</span>, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        rain_month, <span class="st">")&lt;/span&gt;"</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> geometry</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">"sf_coordinates"</span>,</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.4</span>,</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_col,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.size =</span> <span class="cn">NA</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"richtext"</span>,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="fl">10.5</span>,</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="dv">51</span>,</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts, <span class="st">"pt;'&gt;"</span>,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Met Station"</span>, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Year Opened"</span>, <span class="st">")&lt;/span&gt;&lt;br&gt;"</span>,</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#D9565CFF;'&gt;"</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Max. Temp Ever"</span>, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt;'&gt;   |   &lt;/span&gt;"</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#1BB6AFFF;'&gt;"</span>,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Min. Temp Ever"</span>, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#0076C0FF;'&gt;"</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Max. Recorded Rainfall"</span>, <span class="st">"&lt;/b&gt;"</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.7</span>,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_col,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.size =</span> <span class="cn">NA</span>,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add plot_title and plot_subtitle</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="fl">12.5</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">60.3</span>,</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span>,</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> plot_title,</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> bts  <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"body_font"</span>,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="fl">12.1</span>,</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">58.7</span>,</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> plot_subtitle,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> bts  <span class="sc">/</span> <span class="dv">5</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"body_font"</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="st">"EPSG:27700"</span>,</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">default_crs =</span> <span class="st">"EPSG:4326"</span>,</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">3</span>),</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">clip =</span> <span class="st">"off"</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">48</span>, <span class="dv">62</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> plot_caption,</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_family =</span> <span class="st">"body_font"</span>,</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> bts <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overall</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> text_col,</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>      <span class="at">lineheight =</span> <span class="fl">0.3</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid Lines and Axes Text</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">0.3</span>,</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">1</span>,</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">alpha</span>(text_hil, <span class="fl">0.3</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.length =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_markdown</span>(</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> text_hil,</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> bts <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="st">"mm"</span>)</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data_vizs"</span>,</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidy_uk_meteorological_data.png"</span></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot =</span> g,</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">400</span>,</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">500</span>,</span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">"mm"</span>,</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>  <span class="at">bg =</span> bg_col</span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="savings-the-thumbnail-for-the-webpage" class="level3">
<h3 class="anchored" data-anchor-id="savings-the-thumbnail-for-the-webpage">Savings the thumbnail for the webpage</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving a thumbnail</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Saving a thumbnail for the webpage</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">image_read</span>(here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"data_vizs"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tidy_uk_meteorological_data2.png"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>)) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_resize</span>(<span class="at">geometry =</span> <span class="st">"x400"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">image_write</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"data_vizs"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"thumbnails"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tidy_uk_meteorological_data.png"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="session-info" class="level3">
<h3 class="anchored" data-anchor-id="session-info">Session Info</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sessioninfo<span class="sc">::</span><span class="fu">session_info</span>()<span class="sc">$</span>packages <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(package,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">version =</span> loadedversion,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    date, source</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(package) <span class="sc">|&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">case =</span> <span class="st">"title"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  gt<span class="sc">::</span><span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  gt<span class="sc">::</span><span class="fu">opt_interactive</span>(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_search =</span> <span class="cn">TRUE</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  gtExtras<span class="sc">::</span><span class="fu">gt_theme_espn</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="tbl-session-info" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-session-info-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: R Packages and their versions used in the creation of this page and graphics
</figcaption>
<div aria-describedby="tbl-session-info-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="qksnfuryzm" class=".gt_table" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#qksnfuryzm table {
  font-family: Lato, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#qksnfuryzm thead, #qksnfuryzm tbody, #qksnfuryzm tfoot, #qksnfuryzm tr, #qksnfuryzm td, #qksnfuryzm th {
  border-style: none;
}

#qksnfuryzm p {
  margin: 0;
  padding: 0;
}

#qksnfuryzm .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 3px;
  border-top-color: #FFFFFF;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#qksnfuryzm .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#qksnfuryzm .gt_title {
  color: #333333;
  font-size: 24px;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#qksnfuryzm .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#qksnfuryzm .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qksnfuryzm .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qksnfuryzm .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#qksnfuryzm .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 80%;
  font-weight: bolder;
  text-transform: uppercase;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#qksnfuryzm .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 80%;
  font-weight: bolder;
  text-transform: uppercase;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#qksnfuryzm .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#qksnfuryzm .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#qksnfuryzm .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#qksnfuryzm .gt_spanner_row {
  border-bottom-style: hidden;
}

#qksnfuryzm .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 80%;
  font-weight: bolder;
  text-transform: uppercase;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#qksnfuryzm .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 80%;
  font-weight: bolder;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#qksnfuryzm .gt_from_md > :first-child {
  margin-top: 0;
}

#qksnfuryzm .gt_from_md > :last-child {
  margin-bottom: 0;
}

#qksnfuryzm .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #F6F7F7;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#qksnfuryzm .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 80%;
  font-weight: bolder;
  text-transform: uppercase;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#qksnfuryzm .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#qksnfuryzm .gt_row_group_first td {
  border-top-width: 2px;
}

#qksnfuryzm .gt_row_group_first th {
  border-top-width: 2px;
}

#qksnfuryzm .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qksnfuryzm .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#qksnfuryzm .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#qksnfuryzm .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qksnfuryzm .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#qksnfuryzm .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#qksnfuryzm .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#qksnfuryzm .gt_striped {
  background-color: #FAFAFA;
}

#qksnfuryzm .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#qksnfuryzm .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qksnfuryzm .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qksnfuryzm .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#qksnfuryzm .gt_sourcenote {
  font-size: 12px;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#qksnfuryzm .gt_left {
  text-align: left;
}

#qksnfuryzm .gt_center {
  text-align: center;
}

#qksnfuryzm .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#qksnfuryzm .gt_font_normal {
  font-weight: normal;
}

#qksnfuryzm .gt_font_bold {
  font-weight: bold;
}

#qksnfuryzm .gt_font_italic {
  font-style: italic;
}

#qksnfuryzm .gt_super {
  font-size: 65%;
}

#qksnfuryzm .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#qksnfuryzm .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#qksnfuryzm .gt_indent_1 {
  text-indent: 5px;
}

#qksnfuryzm .gt_indent_2 {
  text-indent: 10px;
}

#qksnfuryzm .gt_indent_3 {
  text-indent: 15px;
}

#qksnfuryzm .gt_indent_4 {
  text-indent: 20px;
}

#qksnfuryzm .gt_indent_5 {
  text-indent: 25px;
}

#qksnfuryzm .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#qksnfuryzm div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>
<div id="qksnfuryzm" class="reactable html-widget" style="width:auto;height:auto;"></div>
<script type="application/json" data-for="qksnfuryzm">{"x":{"tag":{"name":"Reactable","attribs":{"data":{"Package":["DBI","KernSmooth","R6","RColorBrewer","Rcpp","S7","bit","bit64","class","classInt","cli","colorspace","crayon","curl","dichromat","digest","dplyr","e1071","evaluate","farver","fastmap","fontawesome","forcats","generics","ggplot2","ggrepel","ggtext","glue","gridtext","gt","gtExtras","gtable","hms","htmltools","htmlwidgets","janitor","jsonlite","knitr","lifecycle","lubridate","magrittr","pacman","paletteer","patchwork","pillar","pkgconfig","proxy","purrr","readr","rematch2","rlang","rmarkdown","rstudioapi","scales","sessioninfo","sf","showtext","showtextdb","snakecase","stringi","stringr","sysfonts","tibble","tidyr","tidyselect","tidyverse","timechange","tzdb","units","vctrs","vroom","withr","xfun","xml2","yaml"],"Version":["1.2.3","2.23-26","2.6.1","1.1-3","1.0.14","0.2.0","4.6.0","4.6.0-1","7.3-23","0.4-11","3.6.4","2.1-1","1.5.3","6.2.2","2.0-0.1","0.6.37","1.1.4","1.7-16","1.0.5","2.1.2","1.2.0","0.5.3","1.0.0","0.1.4","4.0.0","0.9.6","0.1.2","1.8.0","0.1.5","1.0.0","0.5.0","0.3.6","1.1.4","0.5.8.1","1.6.4","2.2.1","2.0.0","1.50","1.0.4","1.9.4","2.0.3","0.5.1","1.6.0","1.3.0","1.11.1","2.0.3","0.4-27","1.0.4","2.1.5","2.1.2","1.1.6","2.30","0.17.1","1.4.0","1.2.3","1.0-20","0.9-7","3.0","0.11.1","1.8.7","1.5.1","0.8.9","3.2.1","1.3.1","1.2.1","2.0.0","0.3.0","0.5.0","0.8-7","0.6.5","1.6.5","3.0.2","0.52","1.3.8","2.3.10"],"Date":["2024-06-02","2025-01-01","2025-02-15","2022-04-03","2025-01-12","2024-11-07","2025-03-06","2025-01-16","2025-01-01","2025-01-08","2025-02-13","2024-07-26","2024-06-20","2025-03-24","2022-05-02","2024-08-19","2023-11-17","2024-09-16","2025-08-27","2024-05-13","2024-05-15","2024-11-16","2023-01-29","2025-05-09","2025-09-11","2024-09-07","2022-09-16","2024-09-30","2022-09-16","2025-04-05","2023-09-15","2024-10-25","2025-10-17","2024-04-04","2023-12-06","2024-12-22","2025-03-27","2025-03-16","2023-11-07","2024-12-08","2022-03-30","2019-03-11","2024-01-21","2024-09-16","2025-09-17","2019-09-22","2022-06-09","2025-02-05","2024-01-10","2020-05-01","2025-04-11","2025-09-28","2024-10-22","2025-04-24","2025-02-05","2025-03-24","2024-03-02","2020-06-04","2023-08-27","2025-03-27","2023-11-14","2024-03-02","2023-03-20","2024-01-24","2024-03-11","2023-02-22","2024-01-18","2025-03-15","2025-03-11","2023-12-01","2023-12-05","2024-10-28","2025-04-02","2025-03-14","2024-07-26"],"Source":["CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.1)","CRAN (R 4.5.1)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.1)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)","CRAN (R 4.5.0)"]},"columns":[{"id":"Package","name":"Package","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","html":true,"align":"left"},{"id":"Version","name":"Version","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","html":true,"align":"right"},{"id":"Date","name":"Date","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","html":true,"align":"right"},{"id":"Source","name":"Source","type":"character","na":"NA","minWidth":125,"style":"function(rowInfo, colInfo) {\nconst rowIndex = rowInfo.index + 1\n}","html":true,"align":"left"}],"searchable":true,"defaultPageSize":10,"showPageSizeOptions":false,"pageSizeOptions":[10,25,50,100],"paginationType":"numbers","showPagination":true,"showPageInfo":true,"minRows":1,"striped":true,"height":"auto","theme":{"color":"#333333","backgroundColor":"#FFFFFF","stripedColor":"#fafafa","style":{"font-family":"Lato, system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif","fontSize":"16px"},"tableStyle":{"borderTopStyle":"solid","borderTopWidth":"2px","borderTopColor":"#D3D3D3"},"headerStyle":{"fontWeight":"bolder","backgroundColor":"transparent","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"},"groupHeaderStyle":{"fontWeight":"bolder","backgroundColor":"transparent","borderBottomStyle":"solid","borderBottomWidth":"2px","borderBottomColor":"#D3D3D3"},"cellStyle":{"fontWeight":"normal"}},"elementId":"qksnfuryzm","dataKey":"f42556072f1c7421838f49fdc5000944"},"children":[]},"class":"reactR_markup"},"evals":["tag.attribs.columns.0.style","tag.attribs.columns.1.style","tag.attribs.columns.2.style","tag.attribs.columns.3.style"],"jsHooks":[]}</script>
</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="attempt-2-add-custom-functions" class="level3">
<h3 class="anchored" data-anchor-id="attempt-2-add-custom-functions">Attempt 2: Add custom functions</h3>
<p>This code defines <code>geom_marquee_repel()</code>, a specialized ggplot2 geom that combines rich text rendering capabilities from the marquee package with intelligent label positioning from ggrepel. The implementation follows a similar architecture to <code>geom_label_repel()</code> but replaces standard text grobs with marquee’s formatted text grobs, allowing users to create plots with richly styled, non-overlapping labels that include features like bold text, colors, and other formatting options. The geom uses the same repulsion algorithm to automatically adjust label positions, preventing overlaps between labels and data points while respecting plot boundaries and user-defined constraints. <strong>Source:</strong> <a href="https://github.com/slowkow/ggrepel/tree/0bbdee8174712929f297da6f0e4170059b0a9344/R">ggrepel R directory</a> <strong>Credits:</strong> <a href="https://github.com/teunbrand">teunbrand</a></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Name ggplot grid object</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convenience function to name grid objects</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>ggname <span class="ot">&lt;-</span> <span class="cf">function</span>(prefix, grob) {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  grob<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">grobName</span>(grob, prefix)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  grob</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>with_seed_null <span class="ot">&lt;-</span> <span class="cf">function</span>(seed, code) {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(seed)) {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    code</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    withr<span class="sc">::</span><span class="fu">with_seed</span>(seed, code)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>.pt <span class="ot">&lt;-</span> <span class="fl">72.27</span> <span class="sc">/</span> <span class="fl">25.4</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="st">"%||%"</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(a)) a <span class="cf">else</span> b</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' Return a boolean vector of non-empty items.</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xs Vector with a mix of "expression" items, "character" items,</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'  and items from other classes.</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Boolean vector indicating which items are not empty.</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>not_empty <span class="ot">&lt;-</span> <span class="cf">function</span>(xs) {</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(<span class="fu">seq_along</span>(xs), <span class="cf">function</span>(i) {</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.expression</span>(xs[i])) {</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">length</span>(<span class="fu">nchar</span>(xs[i])) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(xs[i] <span class="sc">!=</span> <span class="st">""</span>)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co">#' Return a unit version of the argument.</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x Number or unit object.</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return unit(x, "lines") if number or the unchanged argument if it's already</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co">#'  a unit object.</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>to_unit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't change arg if already unit</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.unit</span>(x)) {</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># NA used to exclude points from repulsion calculations</span></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(x)) {</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unit</span>(x, <span class="st">"lines"</span>)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a><span class="co">#' Parse takes a vector of n lines and returns m expressions.</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a><span class="co">#' See https://github.com/tidyverse/ggplot2/issues/2864 for discussion.</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a><span class="co">#' parse(text = c("alpha", "", "gamma"))</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a><span class="co">#' #&gt; expression(alpha, gamma)</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a><span class="co">#' parse_safe(text = c("alpha", "", "gamma"))</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a><span class="co">#' #&gt; expression(alpha, NA, gamma)</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>parse_safe <span class="ot">&lt;-</span> <span class="cf">function</span>(text) {</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">is.character</span>(text))</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"expression"</span>, <span class="fu">length</span>(text))</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(text)) {</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    expr <span class="ot">&lt;-</span> <span class="fu">parse</span>(<span class="at">text =</span> text[[i]])</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    out[[i]] <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(expr) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NA</span> <span class="cf">else</span> expr[[<span class="dv">1</span>]]</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="co">#' Exclude data points outside the panel ranges</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>exclude_outside <span class="ot">&lt;-</span> <span class="cf">function</span>(data, panel_scales) {</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"x.range"</span> <span class="sc">%in%</span> <span class="fu">names</span>(panel_scales)) {</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    xr <span class="ot">&lt;-</span> panel_scales<span class="sc">$</span>x.range</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    yr <span class="ot">&lt;-</span> panel_scales<span class="sc">$</span>y.range</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    ix <span class="ot">&lt;-</span> <span class="fu">inside</span>(data<span class="sc">$</span>x, xr) <span class="sc">&amp;</span> <span class="fu">inside</span>(data<span class="sc">$</span>y, yr)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data[ix,,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="st">"x_range"</span> <span class="sc">%in%</span> <span class="fu">names</span>(panel_scales)) {</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>    xr <span class="ot">&lt;-</span> panel_scales<span class="sc">$</span>x_range</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>    yr <span class="ot">&lt;-</span> panel_scales<span class="sc">$</span>y_range</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>    ix <span class="ot">&lt;-</span> <span class="fu">inside</span>(data<span class="sc">$</span>x, xr) <span class="sc">&amp;</span> <span class="fu">inside</span>(data<span class="sc">$</span>y, yr)</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> data[ix,,drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>  data</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a><span class="co">#' Exclude data points outside the panel ranges</span></span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>inside <span class="ot">&lt;-</span> <span class="cf">function</span>(x, bounds) {</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.infinite</span>(x) <span class="sc">|</span> (x <span class="sc">&lt;=</span> bounds[<span class="dv">2</span>] <span class="sc">&amp;</span> x <span class="sc">&gt;=</span> bounds[<span class="dv">1</span>])</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a><span class="co">#' @rdname geom_text_repel</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param label.padding Amount of padding around label, as unit or number.</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Defaults to 0.25. (Default unit is lines, but other units can be specified</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a><span class="co">#'   by passing \code{unit(x, "units")}).</span></span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param label.r Radius of rounded corners, as unit or number. Defaults</span></span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a><span class="co">#'   to 0.15. (Default unit is lines, but other units can be specified by</span></span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a><span class="co">#'   passing \code{unit(x, "units")}).</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param label.size Size of label border, in mm.</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>geom_label_repel <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="cn">NULL</span>, <span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">parse =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>    ...,</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.r =</span> <span class="fl">0.15</span>,</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>,</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.iter =</span> <span class="dv">10000</span>,</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="fu">getOption</span>(<span class="st">"ggrepel.max.overlaps"</span>, <span class="at">default =</span> <span class="dv">10</span>),</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>,</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">NA</span>,</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="fu">c</span>(<span class="st">"both"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>),</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>),</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">TRUE</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(nudge_x) <span class="sc">||</span> <span class="sc">!</span><span class="fu">missing</span>(nudge_y)) {</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(position)) {</span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Specify either `position` or `nudge_x`/`nudge_y`"</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    position <span class="ot">&lt;-</span> <span class="fu">position_nudge_repel</span>(nudge_x, nudge_y)</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Warn about limitations of the algorithm</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">abs</span>(data<span class="sc">$</span>angle <span class="sc">%%</span> <span class="dv">90</span>) <span class="sc">&gt;</span> <span class="dv">5</span>)) {</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ggrepel: Repulsion works correctly only for rotation angles multiple of 90 degrees"</span></span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer</span>(</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> mapping,</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> stat,</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> GeomLabelRepel,</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> position,</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> show.legend,</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> inherit.aes,</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>      <span class="at">parse =</span> parse,</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding  =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.padding =</span> <span class="fu">to_unit</span>(label.padding),</span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding  =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.r =</span> <span class="fu">to_unit</span>(label.r),</span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.size =</span> label.size,</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow,</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> na.rm,</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>      <span class="at">force =</span> force,</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>      <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time,</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.iter =</span> max.iter,</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_x =</span> nudge_x,</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_y =</span> nudge_y,</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> xlim,</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylim =</span> ylim,</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> <span class="fu">match.arg</span>(direction),</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> verbose,</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>      ...</span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a><span class="co">#' GeomLabelRepel</span></span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a><span class="co">#' @rdname ggrepel</span></span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a><span class="co">#' @format NULL</span></span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a><span class="co">#' @usage NULL</span></span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso \link[ggplot2]{GeomLabel} from the ggplot2 package.</span></span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>GeomLabelRepel <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GeomLabelRepel"</span>, Geom,</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"label"</span>),</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(</span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">size =</span> <span class="fl">3.88</span>, <span class="at">angle =</span> <span class="dv">0</span>,</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="cn">NA</span>, <span class="at">family =</span> <span class="st">""</span>, <span class="at">fontface =</span> <span class="dv">1</span>, <span class="at">lineheight =</span> <span class="fl">1.2</span>,</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.linetype =</span> <span class="dv">1</span>, <span class="at">segment.colour =</span> <span class="cn">NULL</span>, <span class="at">segment.size =</span> <span class="fl">0.5</span>, <span class="at">segment.alpha =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.curvature =</span> <span class="dv">0</span>, <span class="at">segment.angle =</span> <span class="dv">90</span>, <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.shape =</span> <span class="fl">0.5</span>, <span class="at">segment.square =</span> <span class="cn">TRUE</span>, <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>, <span class="at">segment.debug =</span> <span class="cn">FALSE</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panel =</span> <span class="cf">function</span>(</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>    data, panel_scales, coord,</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>    <span class="at">parse =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.r =</span> <span class="fl">0.15</span>,</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.size =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>,</span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.iter =</span> <span class="dv">10000</span>,</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="dv">10</span>,</span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>,</span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"both"</span>,</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (parse) {</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>label <span class="ot">&lt;-</span> <span class="fu">parse_safe</span>(<span class="fu">as.character</span>(data<span class="sc">$</span>label))</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data<span class="sc">$</span>label) <span class="sc">||</span> <span class="sc">!</span><span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label)))) {</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if needed rename columns using our convention</span></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (this_dim <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)) {</span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>      this_orig <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s_orig"</span>, this_dim)</span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>      this_nudge <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"nudge_%s"</span>, this_dim)</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>this_nudge <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>        data[[this_nudge]] <span class="ot">&lt;-</span> data[[this_dim]]</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (this_orig <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>          data[[this_dim]] <span class="ot">&lt;-</span> data[[this_orig]]</span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>          data[[this_orig]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the nudges to the panel scales.</span></span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> data<span class="sc">$</span>nudge_x, <span class="at">y =</span> data<span class="sc">$</span>nudge_y)</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(nudges, panel_scales)</span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the raw data to the panel scales.</span></span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_scales)</span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The nudge is relative to the data.</span></span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_x <span class="ot">&lt;-</span> nudges<span class="sc">$</span>x <span class="sc">-</span> data<span class="sc">$</span>x</span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_y <span class="ot">&lt;-</span> nudges<span class="sc">$</span>y <span class="sc">-</span> data<span class="sc">$</span>y</span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform limits to panel scales.</span></span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> xlim, <span class="at">y =</span> ylim)</span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(limits, panel_scales)</span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allow Inf.</span></span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>x) <span class="sc">==</span> <span class="fu">length</span>(xlim)) {</span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>x[<span class="fu">is.infinite</span>(xlim)] <span class="ot">&lt;-</span> xlim[<span class="fu">is.infinite</span>(xlim)]</span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>y) <span class="sc">==</span> <span class="fu">length</span>(ylim)) {</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>y[<span class="fu">is.infinite</span>(ylim)] <span class="ot">&lt;-</span> ylim[<span class="fu">is.infinite</span>(ylim)]</span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NAs with defaults.</span></span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>x[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)]</span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>y[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)]</span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert hjust and vjust to numeric if character</span></span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>vjust)) {</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>vjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>vjust, data<span class="sc">$</span>y)</span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>hjust)) {</span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>hjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>hjust, data<span class="sc">$</span>x)</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggname</span>(<span class="st">"geom_label_repel"</span>, <span class="fu">gTree</span>(</span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> limits,</span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> data,</span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>      <span class="at">lab =</span> data<span class="sc">$</span>label,</span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.padding =</span> <span class="fu">to_unit</span>(label.padding),</span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.r =</span> <span class="fu">to_unit</span>(label.r),</span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>      <span class="at">label.size =</span> label.size,</span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow,</span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>      <span class="at">force =</span> force,</span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>      <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time,</span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.iter =</span> max.iter,</span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> direction,</span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> verbose,</span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl =</span> <span class="st">"labelrepeltree"</span></span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_key =</span> draw_key_label</span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a><span class="co">#' grid::makeContent function for the grobTree of textRepelGrob objects</span></span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A grid grobTree.</span></span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>makeContent.labelrepeltree <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each bounding box.</span></span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>  box_padding_x <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>  box_padding_y <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each point.</span></span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x<span class="sc">$</span>point.padding)) {</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>point.padding <span class="ot">=</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>)</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do not create text labels for empty strings.</span></span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>  valid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">not_empty</span>(x<span class="sc">$</span>lab))</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a>  invalid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">not_empty</span>(x<span class="sc">$</span>lab))</span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>  ix <span class="ot">&lt;-</span> <span class="fu">c</span>(valid_strings, invalid_strings)</span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data <span class="ot">&lt;-</span> x<span class="sc">$</span>data[ix,]</span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>lab <span class="ot">&lt;-</span> x<span class="sc">$</span>lab[ix]</span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a dataframe with x1 y1 x2 y2</span></span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>  boxes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>    row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>      x<span class="sc">$</span>lab[i],</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unit</span>(row<span class="sc">$</span>x, <span class="st">"native"</span>) <span class="sc">+</span> x<span class="sc">$</span>label.padding,</span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unit</span>(row<span class="sc">$</span>y, <span class="st">"native"</span>) <span class="sc">+</span> x<span class="sc">$</span>label.padding,</span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontsize   =</span> row<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontfamily =</span> row<span class="sc">$</span>family,</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontface   =</span> row<span class="sc">$</span>fontface,</span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">lineheight =</span> row<span class="sc">$</span>lineheight</span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"text"</span></span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">roundrectGrob</span>(</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>      row<span class="sc">$</span>x, row<span class="sc">$</span>y, <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>      <span class="at">width =</span> <span class="fu">grobWidth</span>(t) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> x<span class="sc">$</span>label.padding,</span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>      <span class="at">height =</span> <span class="fu">grobHeight</span>(t) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> x<span class="sc">$</span>label.padding,</span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>      <span class="at">r =</span> x<span class="sc">$</span>label.r,</span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">lwd =</span> x<span class="sc">$</span>label.size <span class="sc">*</span> .pt),</span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"box"</span></span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">grobWidth</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>    gh <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobHeight</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x1"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">-</span> gw <span class="sc">*</span>       row<span class="sc">$</span>hjust <span class="sc">-</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y1"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">-</span> gh <span class="sc">*</span>       row<span class="sc">$</span>vjust <span class="sc">-</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y,</span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x2"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">+</span> gw <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> row<span class="sc">$</span>hjust) <span class="sc">+</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y2"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">+</span> gh <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> row<span class="sc">$</span>vjust) <span class="sc">+</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the repulsion reproducible if desired.</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>seed) <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(x<span class="sc">$</span>seed)) {</span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>seed <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(.Machine<span class="sc">$</span>integer.max, <span class="dv">1</span>L)</span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The points are represented by circles.</span></span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data<span class="sc">$</span>point.size[<span class="fu">is.na</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beware the magic numbers. I do not understand them.</span></span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I just accept them as necessary to get the code to work.</span></span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>  p_width <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>  p_height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>  p_ratio <span class="ot">&lt;-</span> (p_width <span class="sc">/</span> p_height)</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_ratio <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>    p_ratio <span class="ot">&lt;-</span> p_ratio <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="fl">1.15</span> <span class="sc">*</span> p_ratio))</span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repel overlapping bounding boxes away from each other.</span></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>  repel <span class="ot">&lt;-</span> <span class="fu">with_seed_null</span>(x<span class="sc">$</span>seed, <span class="fu">repel_boxes2</span>(</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_points     =</span> <span class="fu">as.matrix</span>(x<span class="sc">$</span>data[,<span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)]),</span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_size      =</span> point_size,</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_x =</span> point_padding,</span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_y =</span> point_padding,</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxes           =</span> <span class="fu">do.call</span>(rbind, boxes),</span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>x),</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>y),</span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>hjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>vjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_push      =</span> x<span class="sc">$</span>force <span class="sc">*</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull      =</span> x<span class="sc">$</span>force_pull <span class="sc">*</span> <span class="fl">1e-2</span>,</span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_time        =</span> x<span class="sc">$</span>max.time,</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter        =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(x<span class="sc">$</span>max.iter), <span class="fl">1e9</span>, x<span class="sc">$</span>max.iter),</span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_overlaps    =</span> x<span class="sc">$</span>max.overlaps,</span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction       =</span> x<span class="sc">$</span>direction,</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose         =</span> x<span class="sc">$</span>verbose</span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x<span class="sc">$</span>verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(</span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ggrepel: %s unlabeled data points (too many overlaps). Consider increasing 'max.overlaps'"</span>,</span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(repel<span class="sc">$</span>too_many_overlaps)</span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">setChildren</span>(x, grobs))</span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>repel<span class="sc">$</span>too_many_overlaps[i]) {</span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a>      row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>      <span class="fu">makeLabelRepelGrobs</span>(</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>        x<span class="sc">$</span>lab[i],</span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of text bounding boxes.</span></span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>x[i], <span class="st">"native"</span>),</span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>y[i], <span class="st">"native"</span>),</span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of original data points.</span></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>        <span class="at">x.orig =</span> row<span class="sc">$</span>x,</span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>        <span class="at">y.orig =</span> row<span class="sc">$</span>y,</span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.width =</span> boxes[[i]][<span class="st">"x2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"x1"</span>],</span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.height =</span> boxes[[i]][<span class="st">"y2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"y1"</span>],</span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.padding =</span> x<span class="sc">$</span>box.padding,</span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>        <span class="at">label.padding =</span> x<span class="sc">$</span>label.padding,</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.size =</span> point_size[i],</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.padding =</span> x<span class="sc">$</span>point.padding,</span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.curvature =</span> row<span class="sc">$</span>segment.curvature,</span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.angle     =</span> row<span class="sc">$</span>segment.angle,</span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.ncp       =</span> row<span class="sc">$</span>segment.ncp,</span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.shape =</span> row<span class="sc">$</span>segment.shape,</span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.square =</span> row<span class="sc">$</span>segment.square,</span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.squareShape =</span> row<span class="sc">$</span>segment.squareShape,</span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.inflect =</span> row<span class="sc">$</span>segment.inflect,</span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.debug =</span> row<span class="sc">$</span>segment.debug,</span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a>        <span class="at">r =</span> x<span class="sc">$</span>label.r,</span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a>        <span class="at">text.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>colour, row<span class="sc">$</span>alpha),</span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontsize =</span> row<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontfamily =</span> row<span class="sc">$</span>family,</span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontface =</span> row<span class="sc">$</span>fontface,</span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a>          <span class="at">lineheight =</span> row<span class="sc">$</span>lineheight</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a>        <span class="at">rect.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>colour, row<span class="sc">$</span>alpha),</span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>fill, row<span class="sc">$</span>alpha),</span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> x<span class="sc">$</span>label.size <span class="sc">*</span> .pt</span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>segment.colour <span class="sc">%||%</span> row<span class="sc">$</span>colour, row<span class="sc">$</span>segment.alpha <span class="sc">%||%</span> row<span class="sc">$</span>alpha),</span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> row<span class="sc">$</span>segment.size <span class="sc">*</span> .pt,</span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a>          <span class="at">lty =</span> row<span class="sc">$</span>segment.linetype <span class="sc">%||%</span> <span class="dv">1</span></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a>        <span class="at">arrow =</span> x<span class="sc">$</span>arrow,</span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a>        <span class="at">min.segment.length =</span> x<span class="sc">$</span>min.segment.length,</span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> row<span class="sc">$</span>hjust,</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> row<span class="sc">$</span>vjust</span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Put segment grobs before text grobs, rect grobs before text grobs.</span></span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), <span class="fu">lapply</span>(grobs, <span class="st">"[["</span>, <span class="st">"segment"</span>)),</span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(</span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Filter</span>(<span class="fu">Negate</span>(is.null), <span class="fu">lapply</span>(grobs, <span class="st">"[["</span>, <span class="st">"textbox"</span>)),</span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a>      <span class="at">recursive =</span> <span class="cn">FALSE</span>, <span class="at">use.names =</span> <span class="cn">FALSE</span></span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setChildren</span>(x, grobs)</span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a>makeLabelRepelGrobs <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a>    i,</span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a>    label,</span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position of original data points.</span></span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a>    <span class="at">x.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a>    <span class="at">y.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.width =</span> <span class="dv">0</span>,</span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.height =</span> <span class="dv">0</span>,</span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"npc"</span>,</span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>,</span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a>    <span class="at">text.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect.gp =</span> <span class="fu">gpar</span>(<span class="at">fill =</span> <span class="st">"white"</span>),</span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a>    <span class="at">r =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"snpc"</span>),</span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a>    <span class="at">vp =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span></span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(label) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(x))</span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">unit</span>(x, default.units)</span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(y))</span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">unit</span>(y, default.units)</span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.width))</span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>    box.width <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.width, default.units)</span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.height))</span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>    box.height <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.height, default.units)</span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(</span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a>    label,</span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">-</span> box.width <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> hjust),</span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">-</span> box.height <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> vjust),</span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> hjust,</span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> vjust,</span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp =</span> text.gp,</span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"textrepelgrob%s"</span>, i)</span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">roundrectGrob</span>(</span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">-</span> box.width <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> hjust) <span class="sc">-</span> label.padding <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> hjust),</span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">-</span> box.height <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> vjust) <span class="sc">-</span> label.padding <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> vjust),</span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a>    <span class="at">width =</span> <span class="fu">grobWidth</span>(t) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> label.padding,</span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a>    <span class="at">height =</span> <span class="fu">grobHeight</span>(t) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> label.padding,</span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">just =</span> <span class="fu">c</span>(hjust, vjust),</span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">r =</span> r,</span>
<span id="cb7-554"><a href="#cb7-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp =</span> rect.gp,</span>
<span id="cb7-555"><a href="#cb7-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"rectrepelgrob%s"</span>, i)</span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(r), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-563"><a href="#cb7-563" aria-hidden="true" tabindex="-1"></a>  point_pos <span class="ot">&lt;-</span> <span class="fu">c</span>(x.orig, y.orig)</span>
<span id="cb7-564"><a href="#cb7-564" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the coordinates of the intersection between the line from the</span></span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a>  <span class="co"># original data point to the centroid and the rectangle's edges.</span></span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a>  text_box <span class="ot">&lt;-</span> <span class="fu">c</span>(x1, y1, x2, y2)</span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a>  <span class="co">#int &lt;- intersect_line_rectangle(point_pos, center, c(x1, y1, x2, y2))</span></span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a>  int <span class="ot">&lt;-</span> <span class="fu">select_line_connection</span>(point_pos, text_box)</span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the data point is inside the label box.</span></span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a>  point_inside_text <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (text_box[<span class="dv">1</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">1</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">1</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">3</span>] <span class="sc">&amp;&amp;</span></span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a>      text_box[<span class="dv">2</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">2</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">2</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">4</span>]) {</span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a>    point_inside_text <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This seems just fine.</span></span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a>  point.padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(point.padding), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> <span class="fu">intersect_line_circle</span>(int, point_pos, (point.size <span class="sc">+</span> point.padding))</span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-583"><a href="#cb7-583" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the distance between the data point and the edge of the text box.</span></span>
<span id="cb7-584"><a href="#cb7-584" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">1</span>] <span class="sc">-</span> point_pos[<span class="dv">1</span>])</span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">2</span>] <span class="sc">-</span> point_pos[<span class="dv">2</span>])</span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale the unit vector by the minimum segment length.</span></span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (d <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a>    mx <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a>    my <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a>    min.segment.length <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mx <span class="sc">*</span> dx <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (my <span class="sc">*</span> dy <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">textbox =</span> <span class="fu">list</span>(<span class="at">rect =</span> r, <span class="at">text =</span> t))</span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (</span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>point_inside_text <span class="sc">&amp;&amp;</span></span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is greater than minimum.</span></span>
<span id="cb7-601"><a href="#cb7-601" aria-hidden="true" tabindex="-1"></a>    (<span class="sc">!</span><span class="fu">is.na</span>(min.segment.length) <span class="sc">&amp;&amp;</span> <span class="fu">euclid</span>(int, point_int) <span class="sc">&gt;</span> min.segment.length) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-602"><a href="#cb7-602" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is less than from label to point center.</span></span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_int) <span class="sc">&lt;</span> <span class="fu">euclid</span>(int, point_pos) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than point size.</span></span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> point.size <span class="sc">&amp;&amp;</span></span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than from point edge to point center.</span></span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> <span class="fu">euclid</span>(point_int, point_pos)</span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-609"><a href="#cb7-609" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">curveGrob</span>(</span>
<span id="cb7-610"><a href="#cb7-610" aria-hidden="true" tabindex="-1"></a>      <span class="at">x1 =</span> int[<span class="dv">1</span>],</span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a>      <span class="at">y1 =</span> int[<span class="dv">2</span>],</span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a>      <span class="at">x2 =</span> point_int[<span class="dv">1</span>],</span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a>      <span class="at">y2 =</span> point_int[<span class="dv">2</span>],</span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a>      <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a>      <span class="at">curvature =</span> segment.curvature,</span>
<span id="cb7-616"><a href="#cb7-616" aria-hidden="true" tabindex="-1"></a>      <span class="at">angle =</span> segment.angle,</span>
<span id="cb7-617"><a href="#cb7-617" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncp =</span> segment.ncp,</span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> segment.shape,</span>
<span id="cb7-619"><a href="#cb7-619" aria-hidden="true" tabindex="-1"></a>      <span class="at">square =</span> segment.square,</span>
<span id="cb7-620"><a href="#cb7-620" aria-hidden="true" tabindex="-1"></a>      <span class="at">squareShape =</span> segment.squareShape,</span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a>      <span class="at">inflect =</span> segment.inflect,</span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a>      <span class="at">debug =</span> segment.debug,</span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> segment.gp,</span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"segmentrepelgrob%s"</span>, i),</span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow</span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a>    grobs[[<span class="st">"segment"</span>]] <span class="ot">&lt;-</span> s</span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a>  grobs</span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a><span class="co">#' @rdname geom_text_repel</span></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a>geom_marquee_repel <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="cn">NULL</span>, <span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a>    ...,</span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>, <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>,</span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.iter =</span> <span class="dv">10000</span>,</span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="fu">getOption</span>(<span class="st">"ggrepel.max.overlaps"</span>, <span class="at">default =</span> <span class="dv">10</span>),</span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>,</span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-648"><a href="#cb7-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-649"><a href="#cb7-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-650"><a href="#cb7-650" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">NA</span>,</span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="fu">c</span>(<span class="st">"both"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>),</span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>),</span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">TRUE</span></span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a>  rlang<span class="sc">::</span><span class="fu">check_installed</span>(<span class="st">"marquee"</span>, <span class="st">"for rendering rich text."</span>)</span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(nudge_x) <span class="sc">||</span> <span class="sc">!</span><span class="fu">missing</span>(nudge_y)) {</span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(position)) {</span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Specify either `position` or `nudge_x`/`nudge_y`"</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a>    position <span class="ot">&lt;-</span> <span class="fu">position_nudge_repel</span>(nudge_x, nudge_y)</span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Warn about limitations of the algorithm</span></span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">abs</span>(data<span class="sc">$</span>angle <span class="sc">%%</span> <span class="dv">90</span>) <span class="sc">&gt;</span> <span class="dv">5</span>)) {</span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ggrepel: Repulsion works correctly only for rotation angles multiple of 90 degrees"</span></span>
<span id="cb7-667"><a href="#cb7-667" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-668"><a href="#cb7-668" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer</span>(</span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> mapping,</span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> stat,</span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> GeomMarqueeRepel,</span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> position,</span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> show.legend,</span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> inherit.aes,</span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding   =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow,</span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> na.rm,</span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a>      <span class="at">force =</span> force,</span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a>      <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time,</span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.iter =</span> max.iter,</span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_x =</span> nudge_x,</span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_y =</span> nudge_y,</span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> xlim,</span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylim =</span> ylim,</span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> <span class="fu">match.arg</span>(direction),</span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> verbose,</span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a>      ...</span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a><span class="co">#' GeomMarqueeRepel</span></span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a><span class="co">#' @format NULL</span></span>
<span id="cb7-702"><a href="#cb7-702" aria-hidden="true" tabindex="-1"></a><span class="co">#' @usage NULL</span></span>
<span id="cb7-703"><a href="#cb7-703" aria-hidden="true" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb7-704"><a href="#cb7-704" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-705"><a href="#cb7-705" aria-hidden="true" tabindex="-1"></a>GeomMarqueeRepel <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(</span>
<span id="cb7-706"><a href="#cb7-706" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GeomMarqueeRepel"</span>, Geom,</span>
<span id="cb7-707"><a href="#cb7-707" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-708"><a href="#cb7-708" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"label"</span>),</span>
<span id="cb7-709"><a href="#cb7-709" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-710"><a href="#cb7-710" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(</span>
<span id="cb7-711"><a href="#cb7-711" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">3.88</span>, <span class="at">angle =</span> <span class="dv">0</span>,</span>
<span id="cb7-712"><a href="#cb7-712" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="cn">NA</span>, <span class="at">family =</span> <span class="st">""</span>, <span class="at">lineheight =</span> <span class="fl">1.2</span>,</span>
<span id="cb7-713"><a href="#cb7-713" aria-hidden="true" tabindex="-1"></a>    <span class="co"># marquee specific</span></span>
<span id="cb7-714"><a href="#cb7-714" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="cn">NULL</span>, <span class="at">width =</span> <span class="cn">NA</span>,</span>
<span id="cb7-715"><a href="#cb7-715" aria-hidden="true" tabindex="-1"></a>    <span class="co"># repel specific</span></span>
<span id="cb7-716"><a href="#cb7-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>, <span class="at">segment.linetype =</span> <span class="dv">1</span>, <span class="at">segment.colour =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-717"><a href="#cb7-717" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.5</span>, <span class="at">segment.alpha =</span> <span class="cn">NULL</span>, <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-718"><a href="#cb7-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>, <span class="at">segment.ncp =</span> <span class="dv">1</span>, <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-719"><a href="#cb7-719" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>, <span class="at">segment.squareShape =</span> <span class="dv">1</span>, <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-720"><a href="#cb7-720" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span></span>
<span id="cb7-721"><a href="#cb7-721" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-722"><a href="#cb7-722" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-723"><a href="#cb7-723" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panel =</span> <span class="cf">function</span>(</span>
<span id="cb7-724"><a href="#cb7-724" aria-hidden="true" tabindex="-1"></a>    data, panel_params, coord,</span>
<span id="cb7-725"><a href="#cb7-725" aria-hidden="true" tabindex="-1"></a>    <span class="co"># repel specific</span></span>
<span id="cb7-726"><a href="#cb7-726" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>, <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-727"><a href="#cb7-727" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>, <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-728"><a href="#cb7-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>, <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-729"><a href="#cb7-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>, <span class="at">max.iter =</span> <span class="dv">10000</span>, <span class="at">max.overlaps =</span> <span class="dv">10</span>,</span>
<span id="cb7-730"><a href="#cb7-730" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>, <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-731"><a href="#cb7-731" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-732"><a href="#cb7-732" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"both"</span>, <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-733"><a href="#cb7-733" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-734"><a href="#cb7-734" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-735"><a href="#cb7-735" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data<span class="sc">$</span>label) <span class="sc">||</span> <span class="sc">!</span><span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label)))) {</span>
<span id="cb7-736"><a href="#cb7-736" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb7-737"><a href="#cb7-737" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-738"><a href="#cb7-738" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-739"><a href="#cb7-739" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marquee specific processing</span></span>
<span id="cb7-740"><a href="#cb7-740" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> data<span class="sc">$</span>style</span>
<span id="cb7-741"><a href="#cb7-741" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(styles)) {</span>
<span id="cb7-742"><a href="#cb7-742" aria-hidden="true" tabindex="-1"></a>      default <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(</span>
<span id="cb7-743"><a href="#cb7-743" aria-hidden="true" tabindex="-1"></a>        marquee<span class="sc">::</span><span class="fu">classic_style</span>(), <span class="st">"body"</span>,</span>
<span id="cb7-744"><a href="#cb7-744" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> marquee<span class="sc">::</span><span class="fu">trbl</span>(marquee<span class="sc">::</span><span class="fu">rem</span>(<span class="fl">0.1</span>))</span>
<span id="cb7-745"><a href="#cb7-745" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-746"><a href="#cb7-746" aria-hidden="true" tabindex="-1"></a>      styles <span class="ot">&lt;-</span> <span class="fu">rep</span>(default, <span class="fu">nrow</span>(data))</span>
<span id="cb7-747"><a href="#cb7-747" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-748"><a href="#cb7-748" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(styles, <span class="st">"marquee_style_set"</span>)) {</span>
<span id="cb7-749"><a href="#cb7-749" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"`style` must be a marquee_style_set object."</span>)</span>
<span id="cb7-750"><a href="#cb7-750" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-751"><a href="#cb7-751" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(styles,</span>
<span id="cb7-752"><a href="#cb7-752" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"base"</span>,</span>
<span id="cb7-753"><a href="#cb7-753" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">family =</span> data<span class="sc">$</span>family,</span>
<span id="cb7-754"><a href="#cb7-754" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">size   =</span> data<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-755"><a href="#cb7-755" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">lineheight =</span> data<span class="sc">$</span>lineheight,</span>
<span id="cb7-756"><a href="#cb7-756" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">color =</span> <span class="fu">alpha</span>(data<span class="sc">$</span>colour, data<span class="sc">$</span>alpha)</span>
<span id="cb7-757"><a href="#cb7-757" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-758"><a href="#cb7-758" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(styles,</span>
<span id="cb7-759"><a href="#cb7-759" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"body"</span>,</span>
<span id="cb7-760"><a href="#cb7-760" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">background =</span> marquee<span class="sc">::</span><span class="fu">skip_inherit</span>(data<span class="sc">$</span>fill),</span>
<span id="cb7-761"><a href="#cb7-761" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-762"><a href="#cb7-762" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-763"><a href="#cb7-763" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggrepel specific processing</span></span>
<span id="cb7-764"><a href="#cb7-764" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if needed rename columns using our convention</span></span>
<span id="cb7-765"><a href="#cb7-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (this_dim <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)) {</span>
<span id="cb7-766"><a href="#cb7-766" aria-hidden="true" tabindex="-1"></a>      this_orig <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s_orig"</span>, this_dim)</span>
<span id="cb7-767"><a href="#cb7-767" aria-hidden="true" tabindex="-1"></a>      this_nudge <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"nudge_%s"</span>, this_dim)</span>
<span id="cb7-768"><a href="#cb7-768" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>this_nudge <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-769"><a href="#cb7-769" aria-hidden="true" tabindex="-1"></a>        data[[this_nudge]] <span class="ot">&lt;-</span> data[[this_dim]]</span>
<span id="cb7-770"><a href="#cb7-770" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (this_orig <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-771"><a href="#cb7-771" aria-hidden="true" tabindex="-1"></a>          data[[this_dim]] <span class="ot">&lt;-</span> data[[this_orig]]</span>
<span id="cb7-772"><a href="#cb7-772" aria-hidden="true" tabindex="-1"></a>          data[[this_orig]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-773"><a href="#cb7-773" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-774"><a href="#cb7-774" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-775"><a href="#cb7-775" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-776"><a href="#cb7-776" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-777"><a href="#cb7-777" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the nudges to the panel scales.</span></span>
<span id="cb7-778"><a href="#cb7-778" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> data<span class="sc">$</span>nudge_x, <span class="at">y =</span> data<span class="sc">$</span>nudge_y)</span>
<span id="cb7-779"><a href="#cb7-779" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(nudges, panel_params)</span>
<span id="cb7-780"><a href="#cb7-780" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-781"><a href="#cb7-781" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the raw data to the panel scales.</span></span>
<span id="cb7-782"><a href="#cb7-782" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_params)</span>
<span id="cb7-783"><a href="#cb7-783" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-784"><a href="#cb7-784" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The nudge is relative to the data.</span></span>
<span id="cb7-785"><a href="#cb7-785" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_x <span class="ot">&lt;-</span> nudges<span class="sc">$</span>x <span class="sc">-</span> data<span class="sc">$</span>x</span>
<span id="cb7-786"><a href="#cb7-786" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_y <span class="ot">&lt;-</span> nudges<span class="sc">$</span>y <span class="sc">-</span> data<span class="sc">$</span>y</span>
<span id="cb7-787"><a href="#cb7-787" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-788"><a href="#cb7-788" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform limits to panel scales.</span></span>
<span id="cb7-789"><a href="#cb7-789" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> xlim, <span class="at">y =</span> ylim)</span>
<span id="cb7-790"><a href="#cb7-790" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(limits, panel_params)</span>
<span id="cb7-791"><a href="#cb7-791" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-792"><a href="#cb7-792" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allow Inf.</span></span>
<span id="cb7-793"><a href="#cb7-793" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>x) <span class="sc">==</span> <span class="fu">length</span>(xlim)) {</span>
<span id="cb7-794"><a href="#cb7-794" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>x[<span class="fu">is.infinite</span>(xlim)] <span class="ot">&lt;-</span> xlim[<span class="fu">is.infinite</span>(xlim)]</span>
<span id="cb7-795"><a href="#cb7-795" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-796"><a href="#cb7-796" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>y) <span class="sc">==</span> <span class="fu">length</span>(ylim)) {</span>
<span id="cb7-797"><a href="#cb7-797" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>y[<span class="fu">is.infinite</span>(ylim)] <span class="ot">&lt;-</span> ylim[<span class="fu">is.infinite</span>(ylim)]</span>
<span id="cb7-798"><a href="#cb7-798" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-799"><a href="#cb7-799" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-800"><a href="#cb7-800" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NAs with defaults.</span></span>
<span id="cb7-801"><a href="#cb7-801" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>x[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)]</span>
<span id="cb7-802"><a href="#cb7-802" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>y[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)]</span>
<span id="cb7-803"><a href="#cb7-803" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-804"><a href="#cb7-804" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert hjust and vjust to numeric if character</span></span>
<span id="cb7-805"><a href="#cb7-805" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>vjust)) {</span>
<span id="cb7-806"><a href="#cb7-806" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>vjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>vjust, data<span class="sc">$</span>y)</span>
<span id="cb7-807"><a href="#cb7-807" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-808"><a href="#cb7-808" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>hjust)) {</span>
<span id="cb7-809"><a href="#cb7-809" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>hjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>hjust, data<span class="sc">$</span>x)</span>
<span id="cb7-810"><a href="#cb7-810" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-811"><a href="#cb7-811" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-812"><a href="#cb7-812" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb7-813"><a href="#cb7-813" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label))) {</span>
<span id="cb7-814"><a href="#cb7-814" aria-hidden="true" tabindex="-1"></a>      grobs[[i]] <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">marquee_grob</span>(</span>
<span id="cb7-815"><a href="#cb7-815" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> data<span class="sc">$</span>label[i], <span class="at">style =</span> styles[i], <span class="at">force_body_margin =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-816"><a href="#cb7-816" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">width =</span> data<span class="sc">$</span>width[i],</span>
<span id="cb7-817"><a href="#cb7-817" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-818"><a href="#cb7-818" aria-hidden="true" tabindex="-1"></a>        <span class="at">angle =</span> data<span class="sc">$</span>angle[i]</span>
<span id="cb7-819"><a href="#cb7-819" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-820"><a href="#cb7-820" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-821"><a href="#cb7-821" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-822"><a href="#cb7-822" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggname</span>(<span class="st">"geom_marquee_repel"</span>, <span class="fu">gTree</span>(</span>
<span id="cb7-823"><a href="#cb7-823" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> limits, <span class="at">data =</span> data,</span>
<span id="cb7-824"><a href="#cb7-824" aria-hidden="true" tabindex="-1"></a>      <span class="at">grobs =</span> grobs,</span>
<span id="cb7-825"><a href="#cb7-825" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-826"><a href="#cb7-826" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-827"><a href="#cb7-827" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-828"><a href="#cb7-828" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow, <span class="at">force =</span> force, <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-829"><a href="#cb7-829" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time, <span class="at">max.iter =</span> max.iter, <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-830"><a href="#cb7-830" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> direction, <span class="at">seed =</span> seed, <span class="at">verbose =</span> verbose,</span>
<span id="cb7-831"><a href="#cb7-831" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl =</span> <span class="st">"marqueerepeltree"</span></span>
<span id="cb7-832"><a href="#cb7-832" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb7-833"><a href="#cb7-833" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-834"><a href="#cb7-834" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-835"><a href="#cb7-835" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_key =</span> draw_key_label</span>
<span id="cb7-836"><a href="#cb7-836" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-837"><a href="#cb7-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-838"><a href="#cb7-838" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-839"><a href="#cb7-839" aria-hidden="true" tabindex="-1"></a>makeContent.marqueerepeltree <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-840"><a href="#cb7-840" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-841"><a href="#cb7-841" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each bounding box.</span></span>
<span id="cb7-842"><a href="#cb7-842" aria-hidden="true" tabindex="-1"></a>  box_padding_x <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>( x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-843"><a href="#cb7-843" aria-hidden="true" tabindex="-1"></a>  box_padding_y <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-844"><a href="#cb7-844" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-845"><a href="#cb7-845" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each point.</span></span>
<span id="cb7-846"><a href="#cb7-846" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x<span class="sc">$</span>point.padding)) {</span>
<span id="cb7-847"><a href="#cb7-847" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>point.padding <span class="ot">=</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>)</span>
<span id="cb7-848"><a href="#cb7-848" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-849"><a href="#cb7-849" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-850"><a href="#cb7-850" aria-hidden="true" tabindex="-1"></a>  valid_strings   <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">lengths</span>(x<span class="sc">$</span>grobs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb7-851"><a href="#cb7-851" aria-hidden="true" tabindex="-1"></a>  invalid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">lengths</span>(x<span class="sc">$</span>grobs) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb7-852"><a href="#cb7-852" aria-hidden="true" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">c</span>(valid_strings, invalid_strings)</span>
<span id="cb7-853"><a href="#cb7-853" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data  <span class="ot">&lt;-</span> x<span class="sc">$</span>data[ord, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-854"><a href="#cb7-854" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>grobs <span class="ot">&lt;-</span> x<span class="sc">$</span>grobs[ord]</span>
<span id="cb7-855"><a href="#cb7-855" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-856"><a href="#cb7-856" aria-hidden="true" tabindex="-1"></a>  justification <span class="ot">&lt;-</span> <span class="fu">rotate_just</span>(x<span class="sc">$</span>data<span class="sc">$</span>angle, x<span class="sc">$</span>data<span class="sc">$</span>hjust, x<span class="sc">$</span>data<span class="sc">$</span>vjust)</span>
<span id="cb7-857"><a href="#cb7-857" aria-hidden="true" tabindex="-1"></a>  hjust <span class="ot">&lt;-</span> justification<span class="sc">$</span>hjust</span>
<span id="cb7-858"><a href="#cb7-858" aria-hidden="true" tabindex="-1"></a>  vjust <span class="ot">&lt;-</span> justification<span class="sc">$</span>vjust</span>
<span id="cb7-859"><a href="#cb7-859" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-860"><a href="#cb7-860" aria-hidden="true" tabindex="-1"></a>  boxes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-861"><a href="#cb7-861" aria-hidden="true" tabindex="-1"></a>    row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-862"><a href="#cb7-862" aria-hidden="true" tabindex="-1"></a>    grob <span class="ot">&lt;-</span> x<span class="sc">$</span>grobs[[i]]</span>
<span id="cb7-863"><a href="#cb7-863" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>( <span class="fu">grobWidth</span>(grob),  <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-864"><a href="#cb7-864" aria-hidden="true" tabindex="-1"></a>    gh <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobHeight</span>(grob), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-865"><a href="#cb7-865" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb7-866"><a href="#cb7-866" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x1"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">-</span> gw <span class="sc">*</span>       hjust[i] <span class="sc">-</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-867"><a href="#cb7-867" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y1"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">-</span> gh <span class="sc">*</span>       vjust[i] <span class="sc">-</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y,</span>
<span id="cb7-868"><a href="#cb7-868" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x2"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">+</span> gw <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> hjust[i]) <span class="sc">+</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-869"><a href="#cb7-869" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y2"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">+</span> gh <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> vjust[i]) <span class="sc">+</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y</span>
<span id="cb7-870"><a href="#cb7-870" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-871"><a href="#cb7-871" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-872"><a href="#cb7-872" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-873"><a href="#cb7-873" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the repulsion reproducible if desired.</span></span>
<span id="cb7-874"><a href="#cb7-874" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>seed) <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(x<span class="sc">$</span>seed)) {</span>
<span id="cb7-875"><a href="#cb7-875" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>seed <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(.Machine<span class="sc">$</span>integer.max, <span class="dv">1</span>L)</span>
<span id="cb7-876"><a href="#cb7-876" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-877"><a href="#cb7-877" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-878"><a href="#cb7-878" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The points are represented by circles.</span></span>
<span id="cb7-879"><a href="#cb7-879" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data<span class="sc">$</span>point.size[<span class="fu">is.na</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-880"><a href="#cb7-880" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-881"><a href="#cb7-881" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beware the magic numbers. I do not understand them.</span></span>
<span id="cb7-882"><a href="#cb7-882" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I just accept them as necessary to get the code to work.</span></span>
<span id="cb7-883"><a href="#cb7-883" aria-hidden="true" tabindex="-1"></a>  p_width <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-884"><a href="#cb7-884" aria-hidden="true" tabindex="-1"></a>  p_height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-885"><a href="#cb7-885" aria-hidden="true" tabindex="-1"></a>  p_ratio <span class="ot">&lt;-</span> (p_width <span class="sc">/</span> p_height)</span>
<span id="cb7-886"><a href="#cb7-886" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_ratio <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb7-887"><a href="#cb7-887" aria-hidden="true" tabindex="-1"></a>    p_ratio <span class="ot">&lt;-</span> p_ratio <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="fl">1.15</span> <span class="sc">*</span> p_ratio))</span>
<span id="cb7-888"><a href="#cb7-888" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-889"><a href="#cb7-889" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-890"><a href="#cb7-890" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-891"><a href="#cb7-891" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-892"><a href="#cb7-892" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-893"><a href="#cb7-893" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-894"><a href="#cb7-894" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-895"><a href="#cb7-895" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-896"><a href="#cb7-896" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repel overlapping bounding boxes away from each other.</span></span>
<span id="cb7-897"><a href="#cb7-897" aria-hidden="true" tabindex="-1"></a>  repel <span class="ot">&lt;-</span> <span class="fu">with_seed_null</span>(x<span class="sc">$</span>seed, <span class="fu">repel_boxes2</span>(</span>
<span id="cb7-898"><a href="#cb7-898" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_points     =</span> <span class="fu">as.matrix</span>(x<span class="sc">$</span>data[,<span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)]),</span>
<span id="cb7-899"><a href="#cb7-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_size      =</span> point_size,</span>
<span id="cb7-900"><a href="#cb7-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_x =</span> point_padding,</span>
<span id="cb7-901"><a href="#cb7-901" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_y =</span> point_padding,</span>
<span id="cb7-902"><a href="#cb7-902" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxes           =</span> <span class="fu">do.call</span>(rbind, boxes),</span>
<span id="cb7-903"><a href="#cb7-903" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>x),</span>
<span id="cb7-904"><a href="#cb7-904" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>y),</span>
<span id="cb7-905"><a href="#cb7-905" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>hjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-906"><a href="#cb7-906" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>vjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-907"><a href="#cb7-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_push      =</span> x<span class="sc">$</span>force <span class="sc">*</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-908"><a href="#cb7-908" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull      =</span> x<span class="sc">$</span>force_pull <span class="sc">*</span> <span class="fl">1e-2</span>,</span>
<span id="cb7-909"><a href="#cb7-909" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_time        =</span> x<span class="sc">$</span>max.time,</span>
<span id="cb7-910"><a href="#cb7-910" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter        =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(x<span class="sc">$</span>max.iter), <span class="fl">1e9</span>, x<span class="sc">$</span>max.iter),</span>
<span id="cb7-911"><a href="#cb7-911" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_overlaps    =</span> x<span class="sc">$</span>max.overlaps,</span>
<span id="cb7-912"><a href="#cb7-912" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction       =</span> x<span class="sc">$</span>direction,</span>
<span id="cb7-913"><a href="#cb7-913" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose         =</span> x<span class="sc">$</span>verbose</span>
<span id="cb7-914"><a href="#cb7-914" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-915"><a href="#cb7-915" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-916"><a href="#cb7-916" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x<span class="sc">$</span>verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-917"><a href="#cb7-917" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-918"><a href="#cb7-918" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(</span>
<span id="cb7-919"><a href="#cb7-919" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ggrepel: %s unlabeled data points (too many overlaps). Consider increasing 'max.overlaps'"</span>,</span>
<span id="cb7-920"><a href="#cb7-920" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(repel<span class="sc">$</span>too_many_overlaps)</span>
<span id="cb7-921"><a href="#cb7-921" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-922"><a href="#cb7-922" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-923"><a href="#cb7-923" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-924"><a href="#cb7-924" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-925"><a href="#cb7-925" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-926"><a href="#cb7-926" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-927"><a href="#cb7-927" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-928"><a href="#cb7-928" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">setChildren</span>(x, grobs))</span>
<span id="cb7-929"><a href="#cb7-929" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-930"><a href="#cb7-930" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-931"><a href="#cb7-931" aria-hidden="true" tabindex="-1"></a>  width  <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>),  <span class="st">"cm"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-932"><a href="#cb7-932" aria-hidden="true" tabindex="-1"></a>  height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"cm"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-933"><a href="#cb7-933" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> x<span class="sc">$</span>data<span class="sc">$</span>point.size <span class="sc">*</span> .pt <span class="sc">/</span> .stroke <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb7-934"><a href="#cb7-934" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"cm"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-935"><a href="#cb7-935" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-936"><a href="#cb7-936" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-937"><a href="#cb7-937" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>repel<span class="sc">$</span>too_many_overlaps[i]) {</span>
<span id="cb7-938"><a href="#cb7-938" aria-hidden="true" tabindex="-1"></a>      row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-939"><a href="#cb7-939" aria-hidden="true" tabindex="-1"></a>      <span class="fu">makeMarqueeRepelGrobs</span>(</span>
<span id="cb7-940"><a href="#cb7-940" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb7-941"><a href="#cb7-941" aria-hidden="true" tabindex="-1"></a>        x<span class="sc">$</span>grobs[[i]],</span>
<span id="cb7-942"><a href="#cb7-942" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of text bounding boxes.</span></span>
<span id="cb7-943"><a href="#cb7-943" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>x[i], <span class="st">"native"</span>),</span>
<span id="cb7-944"><a href="#cb7-944" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>y[i], <span class="st">"native"</span>),</span>
<span id="cb7-945"><a href="#cb7-945" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of original data points.</span></span>
<span id="cb7-946"><a href="#cb7-946" aria-hidden="true" tabindex="-1"></a>        <span class="at">x.orig =</span> row<span class="sc">$</span>x,</span>
<span id="cb7-947"><a href="#cb7-947" aria-hidden="true" tabindex="-1"></a>        <span class="at">y.orig =</span> row<span class="sc">$</span>y,</span>
<span id="cb7-948"><a href="#cb7-948" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-949"><a href="#cb7-949" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.width =</span> boxes[[i]][<span class="st">"x2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"x1"</span>],</span>
<span id="cb7-950"><a href="#cb7-950" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.height =</span> boxes[[i]][<span class="st">"y2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"y1"</span>],</span>
<span id="cb7-951"><a href="#cb7-951" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.padding =</span> x<span class="sc">$</span>box.padding,</span>
<span id="cb7-952"><a href="#cb7-952" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.size =</span> point_size[i],</span>
<span id="cb7-953"><a href="#cb7-953" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.padding =</span> point_padding,</span>
<span id="cb7-954"><a href="#cb7-954" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.curvature =</span> row<span class="sc">$</span>segment.curvature,</span>
<span id="cb7-955"><a href="#cb7-955" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.angle =</span> row<span class="sc">$</span>segment.angle,</span>
<span id="cb7-956"><a href="#cb7-956" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.ncp =</span> row<span class="sc">$</span>segment.ncp,</span>
<span id="cb7-957"><a href="#cb7-957" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.shape =</span> row<span class="sc">$</span>segment.shape,</span>
<span id="cb7-958"><a href="#cb7-958" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.square =</span> row<span class="sc">$</span>segment.square,</span>
<span id="cb7-959"><a href="#cb7-959" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.squareShape =</span> row<span class="sc">$</span>segment.squareShape,</span>
<span id="cb7-960"><a href="#cb7-960" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.inflect =</span> row<span class="sc">$</span>segment.inflect,</span>
<span id="cb7-961"><a href="#cb7-961" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.debug =</span> row<span class="sc">$</span>segment.debug,</span>
<span id="cb7-962"><a href="#cb7-962" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-963"><a href="#cb7-963" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>segment.colour <span class="sc">%||%</span> row<span class="sc">$</span>colour, row<span class="sc">$</span>segment.alpha <span class="sc">%||%</span> row<span class="sc">$</span>alpha),</span>
<span id="cb7-964"><a href="#cb7-964" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> row<span class="sc">$</span>segment.size <span class="sc">*</span> .pt,</span>
<span id="cb7-965"><a href="#cb7-965" aria-hidden="true" tabindex="-1"></a>          <span class="at">lty =</span> row<span class="sc">$</span>segment.linetype <span class="sc">%||%</span> <span class="dv">1</span></span>
<span id="cb7-966"><a href="#cb7-966" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-967"><a href="#cb7-967" aria-hidden="true" tabindex="-1"></a>        <span class="at">arrow =</span> x<span class="sc">$</span>arrow,</span>
<span id="cb7-968"><a href="#cb7-968" aria-hidden="true" tabindex="-1"></a>        <span class="at">min.segment.length =</span> x<span class="sc">$</span>min.segment.length,</span>
<span id="cb7-969"><a href="#cb7-969" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> row<span class="sc">$</span>hjust,</span>
<span id="cb7-970"><a href="#cb7-970" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> row<span class="sc">$</span>vjust,</span>
<span id="cb7-971"><a href="#cb7-971" aria-hidden="true" tabindex="-1"></a>        <span class="at">dim =</span> <span class="fu">c</span>(width, height)</span>
<span id="cb7-972"><a href="#cb7-972" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-973"><a href="#cb7-973" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-974"><a href="#cb7-974" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-975"><a href="#cb7-975" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">unlist</span>(grobs, <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-976"><a href="#cb7-976" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-977"><a href="#cb7-977" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-978"><a href="#cb7-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setChildren</span>(x, grobs)</span>
<span id="cb7-979"><a href="#cb7-979" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-980"><a href="#cb7-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-981"><a href="#cb7-981" aria-hidden="true" tabindex="-1"></a>makeMarqueeRepelGrobs <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-982"><a href="#cb7-982" aria-hidden="true" tabindex="-1"></a>    i,</span>
<span id="cb7-983"><a href="#cb7-983" aria-hidden="true" tabindex="-1"></a>    label,</span>
<span id="cb7-984"><a href="#cb7-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-985"><a href="#cb7-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-986"><a href="#cb7-986" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position of original data points.</span></span>
<span id="cb7-987"><a href="#cb7-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">x.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-988"><a href="#cb7-988" aria-hidden="true" tabindex="-1"></a>    <span class="at">y.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-989"><a href="#cb7-989" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-990"><a href="#cb7-990" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.width =</span> <span class="dv">0</span>,</span>
<span id="cb7-991"><a href="#cb7-991" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.height =</span> <span class="dv">0</span>,</span>
<span id="cb7-992"><a href="#cb7-992" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"npc"</span>,</span>
<span id="cb7-993"><a href="#cb7-993" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-994"><a href="#cb7-994" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-995"><a href="#cb7-995" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-996"><a href="#cb7-996" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-997"><a href="#cb7-997" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>,</span>
<span id="cb7-998"><a href="#cb7-998" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-999"><a href="#cb7-999" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1000"><a href="#cb7-1000" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-1001"><a href="#cb7-1001" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-1002"><a href="#cb7-1002" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1003"><a href="#cb7-1003" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1004"><a href="#cb7-1004" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1005"><a href="#cb7-1005" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-1006"><a href="#cb7-1006" aria-hidden="true" tabindex="-1"></a>    <span class="at">vp =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1007"><a href="#cb7-1007" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1008"><a href="#cb7-1008" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1009"><a href="#cb7-1009" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1010"><a href="#cb7-1010" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1011"><a href="#cb7-1011" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb7-1012"><a href="#cb7-1012" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-1013"><a href="#cb7-1013" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1014"><a href="#cb7-1014" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(x))</span>
<span id="cb7-1015"><a href="#cb7-1015" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">unit</span>(x, default.units)</span>
<span id="cb7-1016"><a href="#cb7-1016" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(y))</span>
<span id="cb7-1017"><a href="#cb7-1017" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">unit</span>(y, default.units)</span>
<span id="cb7-1018"><a href="#cb7-1018" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.width))</span>
<span id="cb7-1019"><a href="#cb7-1019" aria-hidden="true" tabindex="-1"></a>    box.width <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.width, default.units)</span>
<span id="cb7-1020"><a href="#cb7-1020" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.height))</span>
<span id="cb7-1021"><a href="#cb7-1021" aria-hidden="true" tabindex="-1"></a>    box.height <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.height, default.units)</span>
<span id="cb7-1022"><a href="#cb7-1022" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1023"><a href="#cb7-1023" aria-hidden="true" tabindex="-1"></a>  <span class="co"># browser()</span></span>
<span id="cb7-1024"><a href="#cb7-1024" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1025"><a href="#cb7-1025" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> grid<span class="sc">::</span><span class="fu">editGrob</span>(label, <span class="at">x =</span> x, <span class="at">y =</span> y)</span>
<span id="cb7-1026"><a href="#cb7-1026" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1027"><a href="#cb7-1027" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1028"><a href="#cb7-1028" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1029"><a href="#cb7-1029" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1030"><a href="#cb7-1030" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1031"><a href="#cb7-1031" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1032"><a href="#cb7-1032" aria-hidden="true" tabindex="-1"></a>  point_pos <span class="ot">&lt;-</span> <span class="fu">c</span>(x.orig, y.orig)</span>
<span id="cb7-1033"><a href="#cb7-1033" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1034"><a href="#cb7-1034" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the coordinates of the intersection between the line from the</span></span>
<span id="cb7-1035"><a href="#cb7-1035" aria-hidden="true" tabindex="-1"></a>  <span class="co"># original data point to the centroid and the rectangle's edges.</span></span>
<span id="cb7-1036"><a href="#cb7-1036" aria-hidden="true" tabindex="-1"></a>  text_box <span class="ot">&lt;-</span> <span class="fu">c</span>(x1, y1, x2, y2)</span>
<span id="cb7-1037"><a href="#cb7-1037" aria-hidden="true" tabindex="-1"></a>  <span class="co">#int &lt;- intersect_line_rectangle(point_pos, center, c(x1, y1, x2, y2))</span></span>
<span id="cb7-1038"><a href="#cb7-1038" aria-hidden="true" tabindex="-1"></a>  int <span class="ot">&lt;-</span> <span class="fu">select_line_connection</span>(point_pos, text_box)</span>
<span id="cb7-1039"><a href="#cb7-1039" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1040"><a href="#cb7-1040" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the data point is inside the label box.</span></span>
<span id="cb7-1041"><a href="#cb7-1041" aria-hidden="true" tabindex="-1"></a>  point_inside_text <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb7-1042"><a href="#cb7-1042" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (text_box[<span class="dv">1</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">1</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">1</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">3</span>] <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1043"><a href="#cb7-1043" aria-hidden="true" tabindex="-1"></a>      text_box[<span class="dv">2</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">2</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">2</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">4</span>]) {</span>
<span id="cb7-1044"><a href="#cb7-1044" aria-hidden="true" tabindex="-1"></a>    point_inside_text <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb7-1045"><a href="#cb7-1045" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1046"><a href="#cb7-1046" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1047"><a href="#cb7-1047" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This seems just fine.</span></span>
<span id="cb7-1048"><a href="#cb7-1048" aria-hidden="true" tabindex="-1"></a>  point.padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(point.padding), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-1049"><a href="#cb7-1049" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1050"><a href="#cb7-1050" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> <span class="fu">intersect_line_circle</span>(int <span class="sc">*</span> dim, point_pos <span class="sc">*</span> dim, (point.size <span class="sc">+</span> point.padding))</span>
<span id="cb7-1051"><a href="#cb7-1051" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> point_int <span class="sc">/</span> dim</span>
<span id="cb7-1052"><a href="#cb7-1052" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1053"><a href="#cb7-1053" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the distance between the data point and the edge of the text box.</span></span>
<span id="cb7-1054"><a href="#cb7-1054" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">1</span>] <span class="sc">-</span> point_pos[<span class="dv">1</span>])</span>
<span id="cb7-1055"><a href="#cb7-1055" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">2</span>] <span class="sc">-</span> point_pos[<span class="dv">2</span>])</span>
<span id="cb7-1056"><a href="#cb7-1056" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb7-1057"><a href="#cb7-1057" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1058"><a href="#cb7-1058" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale the unit vector by the minimum segment length.</span></span>
<span id="cb7-1059"><a href="#cb7-1059" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (d <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-1060"><a href="#cb7-1060" aria-hidden="true" tabindex="-1"></a>    mx <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1061"><a href="#cb7-1061" aria-hidden="true" tabindex="-1"></a>    my <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1062"><a href="#cb7-1062" aria-hidden="true" tabindex="-1"></a>    min.segment.length <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mx <span class="sc">*</span> dx <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (my <span class="sc">*</span> dy <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb7-1063"><a href="#cb7-1063" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1064"><a href="#cb7-1064" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1065"><a href="#cb7-1065" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">textbox =</span> label)</span>
<span id="cb7-1066"><a href="#cb7-1066" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1067"><a href="#cb7-1067" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (</span>
<span id="cb7-1068"><a href="#cb7-1068" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>point_inside_text <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1069"><a href="#cb7-1069" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1070"><a href="#cb7-1070" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is greater than minimum.</span></span>
<span id="cb7-1071"><a href="#cb7-1071" aria-hidden="true" tabindex="-1"></a>    (<span class="sc">!</span><span class="fu">is.na</span>(min.segment.length) <span class="sc">&amp;&amp;</span> <span class="fu">euclid</span>(int, point_int) <span class="sc">&gt;</span> min.segment.length) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1072"><a href="#cb7-1072" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is less than from label to point center.</span></span>
<span id="cb7-1073"><a href="#cb7-1073" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_int) <span class="sc">&lt;</span> <span class="fu">euclid</span>(int, point_pos) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1074"><a href="#cb7-1074" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than point size.</span></span>
<span id="cb7-1075"><a href="#cb7-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int <span class="sc">*</span> dim, point_pos <span class="sc">*</span> dim) <span class="sc">&gt;</span> point.size <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1076"><a href="#cb7-1076" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than from point edge to point center.</span></span>
<span id="cb7-1077"><a href="#cb7-1077" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> <span class="fu">euclid</span>(point_int, point_pos)</span>
<span id="cb7-1078"><a href="#cb7-1078" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-1079"><a href="#cb7-1079" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">curveGrob</span>(</span>
<span id="cb7-1080"><a href="#cb7-1080" aria-hidden="true" tabindex="-1"></a>      <span class="at">x1 =</span> int[<span class="dv">1</span>],</span>
<span id="cb7-1081"><a href="#cb7-1081" aria-hidden="true" tabindex="-1"></a>      <span class="at">y1 =</span> int[<span class="dv">2</span>],</span>
<span id="cb7-1082"><a href="#cb7-1082" aria-hidden="true" tabindex="-1"></a>      <span class="at">x2 =</span> point_int[<span class="dv">1</span>],</span>
<span id="cb7-1083"><a href="#cb7-1083" aria-hidden="true" tabindex="-1"></a>      <span class="at">y2 =</span> point_int[<span class="dv">2</span>],</span>
<span id="cb7-1084"><a href="#cb7-1084" aria-hidden="true" tabindex="-1"></a>      <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-1085"><a href="#cb7-1085" aria-hidden="true" tabindex="-1"></a>      <span class="at">curvature =</span> segment.curvature,</span>
<span id="cb7-1086"><a href="#cb7-1086" aria-hidden="true" tabindex="-1"></a>      <span class="at">angle =</span> segment.angle,</span>
<span id="cb7-1087"><a href="#cb7-1087" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncp =</span> segment.ncp,</span>
<span id="cb7-1088"><a href="#cb7-1088" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> segment.shape,</span>
<span id="cb7-1089"><a href="#cb7-1089" aria-hidden="true" tabindex="-1"></a>      <span class="at">square =</span> segment.square,</span>
<span id="cb7-1090"><a href="#cb7-1090" aria-hidden="true" tabindex="-1"></a>      <span class="at">squareShape =</span> segment.squareShape,</span>
<span id="cb7-1091"><a href="#cb7-1091" aria-hidden="true" tabindex="-1"></a>      <span class="at">inflect =</span> segment.inflect,</span>
<span id="cb7-1092"><a href="#cb7-1092" aria-hidden="true" tabindex="-1"></a>      <span class="at">debug =</span> segment.debug,</span>
<span id="cb7-1093"><a href="#cb7-1093" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> segment.gp,</span>
<span id="cb7-1094"><a href="#cb7-1094" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"segmentrepelgrob%s"</span>, i),</span>
<span id="cb7-1095"><a href="#cb7-1095" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow</span>
<span id="cb7-1096"><a href="#cb7-1096" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1097"><a href="#cb7-1097" aria-hidden="true" tabindex="-1"></a>    grobs[[<span class="st">"segment"</span>]] <span class="ot">&lt;-</span> s</span>
<span id="cb7-1098"><a href="#cb7-1098" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1099"><a href="#cb7-1099" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1100"><a href="#cb7-1100" aria-hidden="true" tabindex="-1"></a>  grobs</span>
<span id="cb7-1101"><a href="#cb7-1101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1102"><a href="#cb7-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1103"><a href="#cb7-1103" aria-hidden="true" tabindex="-1"></a><span class="co"># similar to ggplot2:::rotate_just</span></span>
<span id="cb7-1104"><a href="#cb7-1104" aria-hidden="true" tabindex="-1"></a>rotate_just <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">angle =</span> <span class="cn">NULL</span>, <span class="at">hjust =</span> <span class="cn">NULL</span>, <span class="at">vjust =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-1105"><a href="#cb7-1105" aria-hidden="true" tabindex="-1"></a>  angle <span class="ot">&lt;-</span> (angle <span class="sc">%||%</span> <span class="dv">0</span>) <span class="sc">%%</span> <span class="dv">360</span></span>
<span id="cb7-1106"><a href="#cb7-1106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1107"><a href="#cb7-1107" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(hjust)) {</span>
<span id="cb7-1108"><a href="#cb7-1108" aria-hidden="true" tabindex="-1"></a>    hjust <span class="ot">&lt;-</span> <span class="fu">match</span>(hjust, <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"right"</span>)) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-1109"><a href="#cb7-1109" aria-hidden="true" tabindex="-1"></a>    hjust[<span class="fu">is.na</span>(hjust)] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-1110"><a href="#cb7-1110" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1111"><a href="#cb7-1111" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(vjust)) {</span>
<span id="cb7-1112"><a href="#cb7-1112" aria-hidden="true" tabindex="-1"></a>    vjust <span class="ot">&lt;-</span> <span class="fu">match</span>(vjust, <span class="fu">c</span>(<span class="st">"bottom"</span>, <span class="st">"top"</span>)) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-1113"><a href="#cb7-1113" aria-hidden="true" tabindex="-1"></a>    vjust[<span class="fu">is.na</span>(vjust)] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-1114"><a href="#cb7-1114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1115"><a href="#cb7-1115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1116"><a href="#cb7-1116" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">length</span>(angle), <span class="fu">length</span>(hjust), <span class="fu">length</span>(vjust))</span>
<span id="cb7-1117"><a href="#cb7-1117" aria-hidden="true" tabindex="-1"></a>  angle <span class="ot">&lt;-</span> <span class="fu">rep</span>(angle, <span class="at">length.out =</span> size)</span>
<span id="cb7-1118"><a href="#cb7-1118" aria-hidden="true" tabindex="-1"></a>  hjust <span class="ot">&lt;-</span> <span class="fu">rep</span>(hjust, <span class="at">length.out =</span> size)</span>
<span id="cb7-1119"><a href="#cb7-1119" aria-hidden="true" tabindex="-1"></a>  vjust <span class="ot">&lt;-</span> <span class="fu">rep</span>(vjust, <span class="at">length.out =</span> size)</span>
<span id="cb7-1120"><a href="#cb7-1120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1121"><a href="#cb7-1121" aria-hidden="true" tabindex="-1"></a>  case <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(angle, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span>, <span class="dv">180</span>, <span class="dv">270</span>, <span class="dv">360</span>))</span>
<span id="cb7-1122"><a href="#cb7-1122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1123"><a href="#cb7-1123" aria-hidden="true" tabindex="-1"></a>  hnew <span class="ot">&lt;-</span> hjust</span>
<span id="cb7-1124"><a href="#cb7-1124" aria-hidden="true" tabindex="-1"></a>  vnew <span class="ot">&lt;-</span> vjust</span>
<span id="cb7-1125"><a href="#cb7-1125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1126"><a href="#cb7-1126" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">2</span>) <span class="co"># 90 &lt;= x &lt; 180</span></span>
<span id="cb7-1127"><a href="#cb7-1127" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> vjust[is_case]</span>
<span id="cb7-1128"><a href="#cb7-1128" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> hjust[is_case]</span>
<span id="cb7-1129"><a href="#cb7-1129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1130"><a href="#cb7-1130" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">3</span>) <span class="co"># 180 &lt;= x &lt; 270</span></span>
<span id="cb7-1131"><a href="#cb7-1131" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> hjust[is_case]</span>
<span id="cb7-1132"><a href="#cb7-1132" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> vjust[is_case]</span>
<span id="cb7-1133"><a href="#cb7-1133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1134"><a href="#cb7-1134" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">4</span>) <span class="co"># 270 &lt;= x &lt; 360</span></span>
<span id="cb7-1135"><a href="#cb7-1135" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> vjust[is_case]</span>
<span id="cb7-1136"><a href="#cb7-1136" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> hjust[is_case]</span>
<span id="cb7-1137"><a href="#cb7-1137" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1138"><a href="#cb7-1138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">hjust =</span> hnew, <span class="at">vjust =</span> vnew)</span>
<span id="cb7-1139"><a href="#cb7-1139" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1140"><a href="#cb7-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1141"><a href="#cb7-1141" aria-hidden="true" tabindex="-1"></a>GeomMarqueeRepel <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(</span>
<span id="cb7-1142"><a href="#cb7-1142" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GeomMarqueeRepel"</span>, Geom,</span>
<span id="cb7-1143"><a href="#cb7-1143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1144"><a href="#cb7-1144" aria-hidden="true" tabindex="-1"></a>  <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"label"</span>),</span>
<span id="cb7-1145"><a href="#cb7-1145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1146"><a href="#cb7-1146" aria-hidden="true" tabindex="-1"></a>  <span class="at">default_aes =</span> <span class="fu">aes</span>(</span>
<span id="cb7-1147"><a href="#cb7-1147" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">size =</span> <span class="fl">3.88</span>, <span class="at">angle =</span> <span class="dv">0</span>,</span>
<span id="cb7-1148"><a href="#cb7-1148" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="cn">NA</span>, <span class="at">family =</span> <span class="st">""</span>, <span class="at">lineheight =</span> <span class="fl">1.2</span>,</span>
<span id="cb7-1149"><a href="#cb7-1149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># marquee specific</span></span>
<span id="cb7-1150"><a href="#cb7-1150" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> <span class="cn">NULL</span>, <span class="at">width =</span> <span class="cn">NA</span>,</span>
<span id="cb7-1151"><a href="#cb7-1151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># repel specific</span></span>
<span id="cb7-1152"><a href="#cb7-1152" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>, <span class="at">segment.linetype =</span> <span class="dv">1</span>, <span class="at">segment.colour =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1153"><a href="#cb7-1153" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.5</span>, <span class="at">segment.alpha =</span> <span class="cn">NULL</span>, <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-1154"><a href="#cb7-1154" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>, <span class="at">segment.ncp =</span> <span class="dv">1</span>, <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1155"><a href="#cb7-1155" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>, <span class="at">segment.squareShape =</span> <span class="dv">1</span>, <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1156"><a href="#cb7-1156" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span></span>
<span id="cb7-1157"><a href="#cb7-1157" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb7-1158"><a href="#cb7-1158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1159"><a href="#cb7-1159" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_panel =</span> <span class="cf">function</span>(</span>
<span id="cb7-1160"><a href="#cb7-1160" aria-hidden="true" tabindex="-1"></a>    data, panel_params, coord,</span>
<span id="cb7-1161"><a href="#cb7-1161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># repel specific</span></span>
<span id="cb7-1162"><a href="#cb7-1162" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>, <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-1163"><a href="#cb7-1163" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>, <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1164"><a href="#cb7-1164" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>, <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-1165"><a href="#cb7-1165" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>, <span class="at">max.iter =</span> <span class="dv">10000</span>, <span class="at">max.overlaps =</span> <span class="dv">10</span>,</span>
<span id="cb7-1166"><a href="#cb7-1166" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>, <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-1167"><a href="#cb7-1167" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-1168"><a href="#cb7-1168" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"both"</span>, <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-1169"><a href="#cb7-1169" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-1170"><a href="#cb7-1170" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-1171"><a href="#cb7-1171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data<span class="sc">$</span>label) <span class="sc">||</span> <span class="sc">!</span><span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label)))) {</span>
<span id="cb7-1172"><a href="#cb7-1172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>()</span>
<span id="cb7-1173"><a href="#cb7-1173" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1174"><a href="#cb7-1174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1175"><a href="#cb7-1175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Marquee specific processing</span></span>
<span id="cb7-1176"><a href="#cb7-1176" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> data<span class="sc">$</span>style</span>
<span id="cb7-1177"><a href="#cb7-1177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(styles)) {</span>
<span id="cb7-1178"><a href="#cb7-1178" aria-hidden="true" tabindex="-1"></a>      default <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(</span>
<span id="cb7-1179"><a href="#cb7-1179" aria-hidden="true" tabindex="-1"></a>        marquee<span class="sc">::</span><span class="fu">classic_style</span>(), <span class="st">"body"</span>,</span>
<span id="cb7-1180"><a href="#cb7-1180" aria-hidden="true" tabindex="-1"></a>        <span class="at">margin =</span> marquee<span class="sc">::</span><span class="fu">trbl</span>(marquee<span class="sc">::</span><span class="fu">rem</span>(<span class="fl">0.1</span>))</span>
<span id="cb7-1181"><a href="#cb7-1181" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1182"><a href="#cb7-1182" aria-hidden="true" tabindex="-1"></a>      styles <span class="ot">&lt;-</span> <span class="fu">rep</span>(default, <span class="fu">nrow</span>(data))</span>
<span id="cb7-1183"><a href="#cb7-1183" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1184"><a href="#cb7-1184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(styles, <span class="st">"marquee_style_set"</span>)) {</span>
<span id="cb7-1185"><a href="#cb7-1185" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"`style` must be a marquee_style_set object."</span>)</span>
<span id="cb7-1186"><a href="#cb7-1186" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1187"><a href="#cb7-1187" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(styles,</span>
<span id="cb7-1188"><a href="#cb7-1188" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"base"</span>,</span>
<span id="cb7-1189"><a href="#cb7-1189" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">family =</span> data<span class="sc">$</span>family,</span>
<span id="cb7-1190"><a href="#cb7-1190" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">size   =</span> data<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-1191"><a href="#cb7-1191" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">lineheight =</span> data<span class="sc">$</span>lineheight,</span>
<span id="cb7-1192"><a href="#cb7-1192" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">color =</span> <span class="fu">alpha</span>(data<span class="sc">$</span>colour, data<span class="sc">$</span>alpha)</span>
<span id="cb7-1193"><a href="#cb7-1193" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1194"><a href="#cb7-1194" aria-hidden="true" tabindex="-1"></a>    styles <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">modify_style</span>(styles,</span>
<span id="cb7-1195"><a href="#cb7-1195" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"body"</span>,</span>
<span id="cb7-1196"><a href="#cb7-1196" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">background =</span> marquee<span class="sc">::</span><span class="fu">skip_inherit</span>(data<span class="sc">$</span>fill),</span>
<span id="cb7-1197"><a href="#cb7-1197" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1198"><a href="#cb7-1198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1199"><a href="#cb7-1199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggrepel specific processing</span></span>
<span id="cb7-1200"><a href="#cb7-1200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if needed rename columns using our convention</span></span>
<span id="cb7-1201"><a href="#cb7-1201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (this_dim <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)) {</span>
<span id="cb7-1202"><a href="#cb7-1202" aria-hidden="true" tabindex="-1"></a>      this_orig <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s_orig"</span>, this_dim)</span>
<span id="cb7-1203"><a href="#cb7-1203" aria-hidden="true" tabindex="-1"></a>      this_nudge <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"nudge_%s"</span>, this_dim)</span>
<span id="cb7-1204"><a href="#cb7-1204" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span>this_nudge <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-1205"><a href="#cb7-1205" aria-hidden="true" tabindex="-1"></a>        data[[this_nudge]] <span class="ot">&lt;-</span> data[[this_dim]]</span>
<span id="cb7-1206"><a href="#cb7-1206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (this_orig <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-1207"><a href="#cb7-1207" aria-hidden="true" tabindex="-1"></a>          data[[this_dim]] <span class="ot">&lt;-</span> data[[this_orig]]</span>
<span id="cb7-1208"><a href="#cb7-1208" aria-hidden="true" tabindex="-1"></a>          data[[this_orig]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-1209"><a href="#cb7-1209" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb7-1210"><a href="#cb7-1210" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-1211"><a href="#cb7-1211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1212"><a href="#cb7-1212" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1213"><a href="#cb7-1213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the nudges to the panel scales.</span></span>
<span id="cb7-1214"><a href="#cb7-1214" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> data<span class="sc">$</span>nudge_x, <span class="at">y =</span> data<span class="sc">$</span>nudge_y)</span>
<span id="cb7-1215"><a href="#cb7-1215" aria-hidden="true" tabindex="-1"></a>    nudges <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(nudges, panel_params)</span>
<span id="cb7-1216"><a href="#cb7-1216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1217"><a href="#cb7-1217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform the raw data to the panel scales.</span></span>
<span id="cb7-1218"><a href="#cb7-1218" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_params)</span>
<span id="cb7-1219"><a href="#cb7-1219" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1220"><a href="#cb7-1220" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The nudge is relative to the data.</span></span>
<span id="cb7-1221"><a href="#cb7-1221" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_x <span class="ot">&lt;-</span> nudges<span class="sc">$</span>x <span class="sc">-</span> data<span class="sc">$</span>x</span>
<span id="cb7-1222"><a href="#cb7-1222" aria-hidden="true" tabindex="-1"></a>    data<span class="sc">$</span>nudge_y <span class="ot">&lt;-</span> nudges<span class="sc">$</span>y <span class="sc">-</span> data<span class="sc">$</span>y</span>
<span id="cb7-1223"><a href="#cb7-1223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1224"><a href="#cb7-1224" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform limits to panel scales.</span></span>
<span id="cb7-1225"><a href="#cb7-1225" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> xlim, <span class="at">y =</span> ylim)</span>
<span id="cb7-1226"><a href="#cb7-1226" aria-hidden="true" tabindex="-1"></a>    limits <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(limits, panel_params)</span>
<span id="cb7-1227"><a href="#cb7-1227" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1228"><a href="#cb7-1228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allow Inf.</span></span>
<span id="cb7-1229"><a href="#cb7-1229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>x) <span class="sc">==</span> <span class="fu">length</span>(xlim)) {</span>
<span id="cb7-1230"><a href="#cb7-1230" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>x[<span class="fu">is.infinite</span>(xlim)] <span class="ot">&lt;-</span> xlim[<span class="fu">is.infinite</span>(xlim)]</span>
<span id="cb7-1231"><a href="#cb7-1231" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1232"><a href="#cb7-1232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>y) <span class="sc">==</span> <span class="fu">length</span>(ylim)) {</span>
<span id="cb7-1233"><a href="#cb7-1233" aria-hidden="true" tabindex="-1"></a>      limits<span class="sc">$</span>y[<span class="fu">is.infinite</span>(ylim)] <span class="ot">&lt;-</span> ylim[<span class="fu">is.infinite</span>(ylim)]</span>
<span id="cb7-1234"><a href="#cb7-1234" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1235"><a href="#cb7-1235" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1236"><a href="#cb7-1236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NAs with defaults.</span></span>
<span id="cb7-1237"><a href="#cb7-1237" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>x[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)]</span>
<span id="cb7-1238"><a href="#cb7-1238" aria-hidden="true" tabindex="-1"></a>    limits<span class="sc">$</span>y[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)]</span>
<span id="cb7-1239"><a href="#cb7-1239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1240"><a href="#cb7-1240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert hjust and vjust to numeric if character</span></span>
<span id="cb7-1241"><a href="#cb7-1241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>vjust)) {</span>
<span id="cb7-1242"><a href="#cb7-1242" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>vjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>vjust, data<span class="sc">$</span>y)</span>
<span id="cb7-1243"><a href="#cb7-1243" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1244"><a href="#cb7-1244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>hjust)) {</span>
<span id="cb7-1245"><a href="#cb7-1245" aria-hidden="true" tabindex="-1"></a>      data<span class="sc">$</span>hjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>hjust, data<span class="sc">$</span>x)</span>
<span id="cb7-1246"><a href="#cb7-1246" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1247"><a href="#cb7-1247" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1248"><a href="#cb7-1248" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">nrow</span>(data))</span>
<span id="cb7-1249"><a href="#cb7-1249" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label))) {</span>
<span id="cb7-1250"><a href="#cb7-1250" aria-hidden="true" tabindex="-1"></a>      grobs[[i]] <span class="ot">&lt;-</span> marquee<span class="sc">::</span><span class="fu">marquee_grob</span>(</span>
<span id="cb7-1251"><a href="#cb7-1251" aria-hidden="true" tabindex="-1"></a>        <span class="at">text =</span> data<span class="sc">$</span>label[i], <span class="at">style =</span> styles[i], <span class="at">force_body_margin =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-1252"><a href="#cb7-1252" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.5</span>, <span class="at">width =</span> data<span class="sc">$</span>width[i],</span>
<span id="cb7-1253"><a href="#cb7-1253" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1254"><a href="#cb7-1254" aria-hidden="true" tabindex="-1"></a>        <span class="at">angle =</span> data<span class="sc">$</span>angle[i]</span>
<span id="cb7-1255"><a href="#cb7-1255" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1256"><a href="#cb7-1256" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1257"><a href="#cb7-1257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1258"><a href="#cb7-1258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggname</span>(<span class="st">"geom_marquee_repel"</span>, <span class="fu">gTree</span>(</span>
<span id="cb7-1259"><a href="#cb7-1259" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits =</span> limits, <span class="at">data =</span> data,</span>
<span id="cb7-1260"><a href="#cb7-1260" aria-hidden="true" tabindex="-1"></a>      <span class="at">grobs =</span> grobs,</span>
<span id="cb7-1261"><a href="#cb7-1261" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-1262"><a href="#cb7-1262" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-1263"><a href="#cb7-1263" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-1264"><a href="#cb7-1264" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow, <span class="at">force =</span> force, <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-1265"><a href="#cb7-1265" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time, <span class="at">max.iter =</span> max.iter, <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-1266"><a href="#cb7-1266" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> direction, <span class="at">seed =</span> seed, <span class="at">verbose =</span> verbose,</span>
<span id="cb7-1267"><a href="#cb7-1267" aria-hidden="true" tabindex="-1"></a>      <span class="at">cl =</span> <span class="st">"marqueerepeltree"</span></span>
<span id="cb7-1268"><a href="#cb7-1268" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb7-1269"><a href="#cb7-1269" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb7-1270"><a href="#cb7-1270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1271"><a href="#cb7-1271" aria-hidden="true" tabindex="-1"></a>  <span class="at">draw_key =</span> draw_key_label</span>
<span id="cb7-1272"><a href="#cb7-1272" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-1273"><a href="#cb7-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1274"><a href="#cb7-1274" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-1275"><a href="#cb7-1275" aria-hidden="true" tabindex="-1"></a>makeContent.marqueerepeltree <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-1276"><a href="#cb7-1276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1277"><a href="#cb7-1277" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each bounding box.</span></span>
<span id="cb7-1278"><a href="#cb7-1278" aria-hidden="true" tabindex="-1"></a>  box_padding_x <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>( x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1279"><a href="#cb7-1279" aria-hidden="true" tabindex="-1"></a>  box_padding_y <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(x<span class="sc">$</span>box.padding, <span class="st">"npc"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1280"><a href="#cb7-1280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1281"><a href="#cb7-1281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each point.</span></span>
<span id="cb7-1282"><a href="#cb7-1282" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x<span class="sc">$</span>point.padding)) {</span>
<span id="cb7-1283"><a href="#cb7-1283" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>point.padding <span class="ot">=</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>)</span>
<span id="cb7-1284"><a href="#cb7-1284" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1285"><a href="#cb7-1285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1286"><a href="#cb7-1286" aria-hidden="true" tabindex="-1"></a>  valid_strings   <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">lengths</span>(x<span class="sc">$</span>grobs) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb7-1287"><a href="#cb7-1287" aria-hidden="true" tabindex="-1"></a>  invalid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">lengths</span>(x<span class="sc">$</span>grobs) <span class="sc">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb7-1288"><a href="#cb7-1288" aria-hidden="true" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">c</span>(valid_strings, invalid_strings)</span>
<span id="cb7-1289"><a href="#cb7-1289" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data  <span class="ot">&lt;-</span> x<span class="sc">$</span>data[ord, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-1290"><a href="#cb7-1290" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>grobs <span class="ot">&lt;-</span> x<span class="sc">$</span>grobs[ord]</span>
<span id="cb7-1291"><a href="#cb7-1291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1292"><a href="#cb7-1292" aria-hidden="true" tabindex="-1"></a>  justification <span class="ot">&lt;-</span> <span class="fu">rotate_just</span>(x<span class="sc">$</span>data<span class="sc">$</span>angle, x<span class="sc">$</span>data<span class="sc">$</span>hjust, x<span class="sc">$</span>data<span class="sc">$</span>vjust)</span>
<span id="cb7-1293"><a href="#cb7-1293" aria-hidden="true" tabindex="-1"></a>  hjust <span class="ot">&lt;-</span> justification<span class="sc">$</span>hjust</span>
<span id="cb7-1294"><a href="#cb7-1294" aria-hidden="true" tabindex="-1"></a>  vjust <span class="ot">&lt;-</span> justification<span class="sc">$</span>vjust</span>
<span id="cb7-1295"><a href="#cb7-1295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1296"><a href="#cb7-1296" aria-hidden="true" tabindex="-1"></a>  boxes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-1297"><a href="#cb7-1297" aria-hidden="true" tabindex="-1"></a>    row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-1298"><a href="#cb7-1298" aria-hidden="true" tabindex="-1"></a>    grob <span class="ot">&lt;-</span> x<span class="sc">$</span>grobs[[i]]</span>
<span id="cb7-1299"><a href="#cb7-1299" aria-hidden="true" tabindex="-1"></a>    gw <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>( <span class="fu">grobWidth</span>(grob),  <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1300"><a href="#cb7-1300" aria-hidden="true" tabindex="-1"></a>    gh <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobHeight</span>(grob), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1301"><a href="#cb7-1301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb7-1302"><a href="#cb7-1302" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x1"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">-</span> gw <span class="sc">*</span>       hjust[i] <span class="sc">-</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-1303"><a href="#cb7-1303" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y1"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">-</span> gh <span class="sc">*</span>       vjust[i] <span class="sc">-</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y,</span>
<span id="cb7-1304"><a href="#cb7-1304" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x2"</span> <span class="ot">=</span> row<span class="sc">$</span>x <span class="sc">+</span> gw <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> hjust[i]) <span class="sc">+</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-1305"><a href="#cb7-1305" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y2"</span> <span class="ot">=</span> row<span class="sc">$</span>y <span class="sc">+</span> gh <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> vjust[i]) <span class="sc">+</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y</span>
<span id="cb7-1306"><a href="#cb7-1306" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1307"><a href="#cb7-1307" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-1308"><a href="#cb7-1308" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1309"><a href="#cb7-1309" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the repulsion reproducible if desired.</span></span>
<span id="cb7-1310"><a href="#cb7-1310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>seed) <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(x<span class="sc">$</span>seed)) {</span>
<span id="cb7-1311"><a href="#cb7-1311" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>seed <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(.Machine<span class="sc">$</span>integer.max, <span class="dv">1</span>L)</span>
<span id="cb7-1312"><a href="#cb7-1312" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1313"><a href="#cb7-1313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1314"><a href="#cb7-1314" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The points are represented by circles.</span></span>
<span id="cb7-1315"><a href="#cb7-1315" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data<span class="sc">$</span>point.size[<span class="fu">is.na</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-1316"><a href="#cb7-1316" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1317"><a href="#cb7-1317" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beware the magic numbers. I do not understand them.</span></span>
<span id="cb7-1318"><a href="#cb7-1318" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I just accept them as necessary to get the code to work.</span></span>
<span id="cb7-1319"><a href="#cb7-1319" aria-hidden="true" tabindex="-1"></a>  p_width <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1320"><a href="#cb7-1320" aria-hidden="true" tabindex="-1"></a>  p_height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1321"><a href="#cb7-1321" aria-hidden="true" tabindex="-1"></a>  p_ratio <span class="ot">&lt;-</span> (p_width <span class="sc">/</span> p_height)</span>
<span id="cb7-1322"><a href="#cb7-1322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_ratio <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb7-1323"><a href="#cb7-1323" aria-hidden="true" tabindex="-1"></a>    p_ratio <span class="ot">&lt;-</span> p_ratio <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="fl">1.15</span> <span class="sc">*</span> p_ratio))</span>
<span id="cb7-1324"><a href="#cb7-1324" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1325"><a href="#cb7-1325" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-1326"><a href="#cb7-1326" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-1327"><a href="#cb7-1327" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-1328"><a href="#cb7-1328" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-1329"><a href="#cb7-1329" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-1330"><a href="#cb7-1330" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-1331"><a href="#cb7-1331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1332"><a href="#cb7-1332" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repel overlapping bounding boxes away from each other.</span></span>
<span id="cb7-1333"><a href="#cb7-1333" aria-hidden="true" tabindex="-1"></a>  repel <span class="ot">&lt;-</span> <span class="fu">with_seed_null</span>(x<span class="sc">$</span>seed, <span class="fu">repel_boxes2</span>(</span>
<span id="cb7-1334"><a href="#cb7-1334" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_points     =</span> <span class="fu">as.matrix</span>(x<span class="sc">$</span>data[,<span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)]),</span>
<span id="cb7-1335"><a href="#cb7-1335" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_size      =</span> point_size,</span>
<span id="cb7-1336"><a href="#cb7-1336" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_x =</span> point_padding,</span>
<span id="cb7-1337"><a href="#cb7-1337" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_y =</span> point_padding,</span>
<span id="cb7-1338"><a href="#cb7-1338" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxes           =</span> <span class="fu">do.call</span>(rbind, boxes),</span>
<span id="cb7-1339"><a href="#cb7-1339" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>x),</span>
<span id="cb7-1340"><a href="#cb7-1340" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>y),</span>
<span id="cb7-1341"><a href="#cb7-1341" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>hjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1342"><a href="#cb7-1342" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>vjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1343"><a href="#cb7-1343" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_push      =</span> x<span class="sc">$</span>force <span class="sc">*</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-1344"><a href="#cb7-1344" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull      =</span> x<span class="sc">$</span>force_pull <span class="sc">*</span> <span class="fl">1e-2</span>,</span>
<span id="cb7-1345"><a href="#cb7-1345" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_time        =</span> x<span class="sc">$</span>max.time,</span>
<span id="cb7-1346"><a href="#cb7-1346" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter        =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(x<span class="sc">$</span>max.iter), <span class="fl">1e9</span>, x<span class="sc">$</span>max.iter),</span>
<span id="cb7-1347"><a href="#cb7-1347" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_overlaps    =</span> x<span class="sc">$</span>max.overlaps,</span>
<span id="cb7-1348"><a href="#cb7-1348" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction       =</span> x<span class="sc">$</span>direction,</span>
<span id="cb7-1349"><a href="#cb7-1349" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose         =</span> x<span class="sc">$</span>verbose</span>
<span id="cb7-1350"><a href="#cb7-1350" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-1351"><a href="#cb7-1351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1352"><a href="#cb7-1352" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x<span class="sc">$</span>verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-1353"><a href="#cb7-1353" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-1354"><a href="#cb7-1354" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(</span>
<span id="cb7-1355"><a href="#cb7-1355" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ggrepel: %s unlabeled data points (too many overlaps). Consider increasing 'max.overlaps'"</span>,</span>
<span id="cb7-1356"><a href="#cb7-1356" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(repel<span class="sc">$</span>too_many_overlaps)</span>
<span id="cb7-1357"><a href="#cb7-1357" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1358"><a href="#cb7-1358" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1359"><a href="#cb7-1359" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1360"><a href="#cb7-1360" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1361"><a href="#cb7-1361" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-1362"><a href="#cb7-1362" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-1363"><a href="#cb7-1363" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-1364"><a href="#cb7-1364" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">setChildren</span>(x, grobs))</span>
<span id="cb7-1365"><a href="#cb7-1365" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1366"><a href="#cb7-1366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1367"><a href="#cb7-1367" aria-hidden="true" tabindex="-1"></a>  width  <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>),  <span class="st">"cm"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1368"><a href="#cb7-1368" aria-hidden="true" tabindex="-1"></a>  height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"cm"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1369"><a href="#cb7-1369" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> x<span class="sc">$</span>data<span class="sc">$</span>point.size <span class="sc">*</span> .pt <span class="sc">/</span> .stroke <span class="sc">/</span> <span class="dv">20</span></span>
<span id="cb7-1370"><a href="#cb7-1370" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"cm"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1371"><a href="#cb7-1371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1372"><a href="#cb7-1372" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-1373"><a href="#cb7-1373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>repel<span class="sc">$</span>too_many_overlaps[i]) {</span>
<span id="cb7-1374"><a href="#cb7-1374" aria-hidden="true" tabindex="-1"></a>      row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-1375"><a href="#cb7-1375" aria-hidden="true" tabindex="-1"></a>      <span class="fu">makeMarqueeRepelGrobs</span>(</span>
<span id="cb7-1376"><a href="#cb7-1376" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb7-1377"><a href="#cb7-1377" aria-hidden="true" tabindex="-1"></a>        x<span class="sc">$</span>grobs[[i]],</span>
<span id="cb7-1378"><a href="#cb7-1378" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of text bounding boxes.</span></span>
<span id="cb7-1379"><a href="#cb7-1379" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>x[i], <span class="st">"native"</span>),</span>
<span id="cb7-1380"><a href="#cb7-1380" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>y[i], <span class="st">"native"</span>),</span>
<span id="cb7-1381"><a href="#cb7-1381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of original data points.</span></span>
<span id="cb7-1382"><a href="#cb7-1382" aria-hidden="true" tabindex="-1"></a>        <span class="at">x.orig =</span> row<span class="sc">$</span>x,</span>
<span id="cb7-1383"><a href="#cb7-1383" aria-hidden="true" tabindex="-1"></a>        <span class="at">y.orig =</span> row<span class="sc">$</span>y,</span>
<span id="cb7-1384"><a href="#cb7-1384" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-1385"><a href="#cb7-1385" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.width =</span> boxes[[i]][<span class="st">"x2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"x1"</span>],</span>
<span id="cb7-1386"><a href="#cb7-1386" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.height =</span> boxes[[i]][<span class="st">"y2"</span>] <span class="sc">-</span> boxes[[i]][<span class="st">"y1"</span>],</span>
<span id="cb7-1387"><a href="#cb7-1387" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.padding =</span> x<span class="sc">$</span>box.padding,</span>
<span id="cb7-1388"><a href="#cb7-1388" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.size =</span> point_size[i],</span>
<span id="cb7-1389"><a href="#cb7-1389" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.padding =</span> point_padding,</span>
<span id="cb7-1390"><a href="#cb7-1390" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.curvature =</span> row<span class="sc">$</span>segment.curvature,</span>
<span id="cb7-1391"><a href="#cb7-1391" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.angle =</span> row<span class="sc">$</span>segment.angle,</span>
<span id="cb7-1392"><a href="#cb7-1392" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.ncp =</span> row<span class="sc">$</span>segment.ncp,</span>
<span id="cb7-1393"><a href="#cb7-1393" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.shape =</span> row<span class="sc">$</span>segment.shape,</span>
<span id="cb7-1394"><a href="#cb7-1394" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.square =</span> row<span class="sc">$</span>segment.square,</span>
<span id="cb7-1395"><a href="#cb7-1395" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.squareShape =</span> row<span class="sc">$</span>segment.squareShape,</span>
<span id="cb7-1396"><a href="#cb7-1396" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.inflect =</span> row<span class="sc">$</span>segment.inflect,</span>
<span id="cb7-1397"><a href="#cb7-1397" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.debug =</span> row<span class="sc">$</span>segment.debug,</span>
<span id="cb7-1398"><a href="#cb7-1398" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-1399"><a href="#cb7-1399" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>segment.colour <span class="sc">%||%</span> row<span class="sc">$</span>colour, row<span class="sc">$</span>segment.alpha <span class="sc">%||%</span> row<span class="sc">$</span>alpha),</span>
<span id="cb7-1400"><a href="#cb7-1400" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> row<span class="sc">$</span>segment.size <span class="sc">*</span> .pt,</span>
<span id="cb7-1401"><a href="#cb7-1401" aria-hidden="true" tabindex="-1"></a>          <span class="at">lty =</span> row<span class="sc">$</span>segment.linetype <span class="sc">%||%</span> <span class="dv">1</span></span>
<span id="cb7-1402"><a href="#cb7-1402" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-1403"><a href="#cb7-1403" aria-hidden="true" tabindex="-1"></a>        <span class="at">arrow =</span> x<span class="sc">$</span>arrow,</span>
<span id="cb7-1404"><a href="#cb7-1404" aria-hidden="true" tabindex="-1"></a>        <span class="at">min.segment.length =</span> x<span class="sc">$</span>min.segment.length,</span>
<span id="cb7-1405"><a href="#cb7-1405" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> row<span class="sc">$</span>hjust,</span>
<span id="cb7-1406"><a href="#cb7-1406" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> row<span class="sc">$</span>vjust,</span>
<span id="cb7-1407"><a href="#cb7-1407" aria-hidden="true" tabindex="-1"></a>        <span class="at">dim =</span> <span class="fu">c</span>(width, height)</span>
<span id="cb7-1408"><a href="#cb7-1408" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1409"><a href="#cb7-1409" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1410"><a href="#cb7-1410" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-1411"><a href="#cb7-1411" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">unlist</span>(grobs, <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-1412"><a href="#cb7-1412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-1413"><a href="#cb7-1413" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1414"><a href="#cb7-1414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setChildren</span>(x, grobs)</span>
<span id="cb7-1415"><a href="#cb7-1415" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1416"><a href="#cb7-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1417"><a href="#cb7-1417" aria-hidden="true" tabindex="-1"></a>makeMarqueeRepelGrobs <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-1418"><a href="#cb7-1418" aria-hidden="true" tabindex="-1"></a>    i,</span>
<span id="cb7-1419"><a href="#cb7-1419" aria-hidden="true" tabindex="-1"></a>    label,</span>
<span id="cb7-1420"><a href="#cb7-1420" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-1421"><a href="#cb7-1421" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-1422"><a href="#cb7-1422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position of original data points.</span></span>
<span id="cb7-1423"><a href="#cb7-1423" aria-hidden="true" tabindex="-1"></a>    <span class="at">x.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1424"><a href="#cb7-1424" aria-hidden="true" tabindex="-1"></a>    <span class="at">y.orig =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1425"><a href="#cb7-1425" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Width and height of text boxes.</span></span>
<span id="cb7-1426"><a href="#cb7-1426" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.width =</span> <span class="dv">0</span>,</span>
<span id="cb7-1427"><a href="#cb7-1427" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.height =</span> <span class="dv">0</span>,</span>
<span id="cb7-1428"><a href="#cb7-1428" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"npc"</span>,</span>
<span id="cb7-1429"><a href="#cb7-1429" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-1430"><a href="#cb7-1430" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-1431"><a href="#cb7-1431" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-1432"><a href="#cb7-1432" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-1433"><a href="#cb7-1433" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>,</span>
<span id="cb7-1434"><a href="#cb7-1434" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-1435"><a href="#cb7-1435" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1436"><a href="#cb7-1436" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-1437"><a href="#cb7-1437" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-1438"><a href="#cb7-1438" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1439"><a href="#cb7-1439" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1440"><a href="#cb7-1440" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1441"><a href="#cb7-1441" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-1442"><a href="#cb7-1442" aria-hidden="true" tabindex="-1"></a>    <span class="at">vp =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1443"><a href="#cb7-1443" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1444"><a href="#cb7-1444" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1445"><a href="#cb7-1445" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1446"><a href="#cb7-1446" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1447"><a href="#cb7-1447" aria-hidden="true" tabindex="-1"></a>    <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb7-1448"><a href="#cb7-1448" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-1449"><a href="#cb7-1449" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1450"><a href="#cb7-1450" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(x))</span>
<span id="cb7-1451"><a href="#cb7-1451" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">unit</span>(x, default.units)</span>
<span id="cb7-1452"><a href="#cb7-1452" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(y))</span>
<span id="cb7-1453"><a href="#cb7-1453" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">unit</span>(y, default.units)</span>
<span id="cb7-1454"><a href="#cb7-1454" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.width))</span>
<span id="cb7-1455"><a href="#cb7-1455" aria-hidden="true" tabindex="-1"></a>    box.width <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.width, default.units)</span>
<span id="cb7-1456"><a href="#cb7-1456" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(box.height))</span>
<span id="cb7-1457"><a href="#cb7-1457" aria-hidden="true" tabindex="-1"></a>    box.height <span class="ot">&lt;-</span> <span class="fu">unit</span>(box.height, default.units)</span>
<span id="cb7-1458"><a href="#cb7-1458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1459"><a href="#cb7-1459" aria-hidden="true" tabindex="-1"></a>  <span class="co"># browser()</span></span>
<span id="cb7-1460"><a href="#cb7-1460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1461"><a href="#cb7-1461" aria-hidden="true" tabindex="-1"></a>  label <span class="ot">&lt;-</span> grid<span class="sc">::</span><span class="fu">editGrob</span>(label, <span class="at">x =</span> x, <span class="at">y =</span> y)</span>
<span id="cb7-1462"><a href="#cb7-1462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1463"><a href="#cb7-1463" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1464"><a href="#cb7-1464" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobWidth</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1465"><a href="#cb7-1465" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1466"><a href="#cb7-1466" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(y <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">grobHeight</span>(label), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1467"><a href="#cb7-1467" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1468"><a href="#cb7-1468" aria-hidden="true" tabindex="-1"></a>  point_pos <span class="ot">&lt;-</span> <span class="fu">c</span>(x.orig, y.orig)</span>
<span id="cb7-1469"><a href="#cb7-1469" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1470"><a href="#cb7-1470" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the coordinates of the intersection between the line from the</span></span>
<span id="cb7-1471"><a href="#cb7-1471" aria-hidden="true" tabindex="-1"></a>  <span class="co"># original data point to the centroid and the rectangle's edges.</span></span>
<span id="cb7-1472"><a href="#cb7-1472" aria-hidden="true" tabindex="-1"></a>  text_box <span class="ot">&lt;-</span> <span class="fu">c</span>(x1, y1, x2, y2)</span>
<span id="cb7-1473"><a href="#cb7-1473" aria-hidden="true" tabindex="-1"></a>  <span class="co">#int &lt;- intersect_line_rectangle(point_pos, center, c(x1, y1, x2, y2))</span></span>
<span id="cb7-1474"><a href="#cb7-1474" aria-hidden="true" tabindex="-1"></a>  int <span class="ot">&lt;-</span> <span class="fu">select_line_connection</span>(point_pos, text_box)</span>
<span id="cb7-1475"><a href="#cb7-1475" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1476"><a href="#cb7-1476" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the data point is inside the label box.</span></span>
<span id="cb7-1477"><a href="#cb7-1477" aria-hidden="true" tabindex="-1"></a>  point_inside_text <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb7-1478"><a href="#cb7-1478" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (text_box[<span class="dv">1</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">1</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">1</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">3</span>] <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1479"><a href="#cb7-1479" aria-hidden="true" tabindex="-1"></a>      text_box[<span class="dv">2</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">2</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">2</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">4</span>]) {</span>
<span id="cb7-1480"><a href="#cb7-1480" aria-hidden="true" tabindex="-1"></a>    point_inside_text <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb7-1481"><a href="#cb7-1481" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1482"><a href="#cb7-1482" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1483"><a href="#cb7-1483" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This seems just fine.</span></span>
<span id="cb7-1484"><a href="#cb7-1484" aria-hidden="true" tabindex="-1"></a>  point.padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(point.padding), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-1485"><a href="#cb7-1485" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1486"><a href="#cb7-1486" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> <span class="fu">intersect_line_circle</span>(int <span class="sc">*</span> dim, point_pos <span class="sc">*</span> dim, (point.size <span class="sc">+</span> point.padding))</span>
<span id="cb7-1487"><a href="#cb7-1487" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> point_int <span class="sc">/</span> dim</span>
<span id="cb7-1488"><a href="#cb7-1488" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1489"><a href="#cb7-1489" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the distance between the data point and the edge of the text box.</span></span>
<span id="cb7-1490"><a href="#cb7-1490" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">1</span>] <span class="sc">-</span> point_pos[<span class="dv">1</span>])</span>
<span id="cb7-1491"><a href="#cb7-1491" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">2</span>] <span class="sc">-</span> point_pos[<span class="dv">2</span>])</span>
<span id="cb7-1492"><a href="#cb7-1492" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb7-1493"><a href="#cb7-1493" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1494"><a href="#cb7-1494" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale the unit vector by the minimum segment length.</span></span>
<span id="cb7-1495"><a href="#cb7-1495" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (d <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-1496"><a href="#cb7-1496" aria-hidden="true" tabindex="-1"></a>    mx <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1497"><a href="#cb7-1497" aria-hidden="true" tabindex="-1"></a>    my <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1498"><a href="#cb7-1498" aria-hidden="true" tabindex="-1"></a>    min.segment.length <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mx <span class="sc">*</span> dx <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (my <span class="sc">*</span> dy <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb7-1499"><a href="#cb7-1499" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1500"><a href="#cb7-1500" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1501"><a href="#cb7-1501" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">textbox =</span> label)</span>
<span id="cb7-1502"><a href="#cb7-1502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1503"><a href="#cb7-1503" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (</span>
<span id="cb7-1504"><a href="#cb7-1504" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>point_inside_text <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1505"><a href="#cb7-1505" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1506"><a href="#cb7-1506" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is greater than minimum.</span></span>
<span id="cb7-1507"><a href="#cb7-1507" aria-hidden="true" tabindex="-1"></a>    (<span class="sc">!</span><span class="fu">is.na</span>(min.segment.length) <span class="sc">&amp;&amp;</span> <span class="fu">euclid</span>(int, point_int) <span class="sc">&gt;</span> min.segment.length) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1508"><a href="#cb7-1508" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is less than from label to point center.</span></span>
<span id="cb7-1509"><a href="#cb7-1509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_int) <span class="sc">&lt;</span> <span class="fu">euclid</span>(int, point_pos) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1510"><a href="#cb7-1510" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than point size.</span></span>
<span id="cb7-1511"><a href="#cb7-1511" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int <span class="sc">*</span> dim, point_pos <span class="sc">*</span> dim) <span class="sc">&gt;</span> point.size <span class="sc">&amp;&amp;</span></span>
<span id="cb7-1512"><a href="#cb7-1512" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than from point edge to point center.</span></span>
<span id="cb7-1513"><a href="#cb7-1513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> <span class="fu">euclid</span>(point_int, point_pos)</span>
<span id="cb7-1514"><a href="#cb7-1514" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-1515"><a href="#cb7-1515" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">curveGrob</span>(</span>
<span id="cb7-1516"><a href="#cb7-1516" aria-hidden="true" tabindex="-1"></a>      <span class="at">x1 =</span> int[<span class="dv">1</span>],</span>
<span id="cb7-1517"><a href="#cb7-1517" aria-hidden="true" tabindex="-1"></a>      <span class="at">y1 =</span> int[<span class="dv">2</span>],</span>
<span id="cb7-1518"><a href="#cb7-1518" aria-hidden="true" tabindex="-1"></a>      <span class="at">x2 =</span> point_int[<span class="dv">1</span>],</span>
<span id="cb7-1519"><a href="#cb7-1519" aria-hidden="true" tabindex="-1"></a>      <span class="at">y2 =</span> point_int[<span class="dv">2</span>],</span>
<span id="cb7-1520"><a href="#cb7-1520" aria-hidden="true" tabindex="-1"></a>      <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-1521"><a href="#cb7-1521" aria-hidden="true" tabindex="-1"></a>      <span class="at">curvature =</span> segment.curvature,</span>
<span id="cb7-1522"><a href="#cb7-1522" aria-hidden="true" tabindex="-1"></a>      <span class="at">angle =</span> segment.angle,</span>
<span id="cb7-1523"><a href="#cb7-1523" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncp =</span> segment.ncp,</span>
<span id="cb7-1524"><a href="#cb7-1524" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> segment.shape,</span>
<span id="cb7-1525"><a href="#cb7-1525" aria-hidden="true" tabindex="-1"></a>      <span class="at">square =</span> segment.square,</span>
<span id="cb7-1526"><a href="#cb7-1526" aria-hidden="true" tabindex="-1"></a>      <span class="at">squareShape =</span> segment.squareShape,</span>
<span id="cb7-1527"><a href="#cb7-1527" aria-hidden="true" tabindex="-1"></a>      <span class="at">inflect =</span> segment.inflect,</span>
<span id="cb7-1528"><a href="#cb7-1528" aria-hidden="true" tabindex="-1"></a>      <span class="at">debug =</span> segment.debug,</span>
<span id="cb7-1529"><a href="#cb7-1529" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> segment.gp,</span>
<span id="cb7-1530"><a href="#cb7-1530" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"segmentrepelgrob%s"</span>, i),</span>
<span id="cb7-1531"><a href="#cb7-1531" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow</span>
<span id="cb7-1532"><a href="#cb7-1532" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1533"><a href="#cb7-1533" aria-hidden="true" tabindex="-1"></a>    grobs[[<span class="st">"segment"</span>]] <span class="ot">&lt;-</span> s</span>
<span id="cb7-1534"><a href="#cb7-1534" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1535"><a href="#cb7-1535" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1536"><a href="#cb7-1536" aria-hidden="true" tabindex="-1"></a>  grobs</span>
<span id="cb7-1537"><a href="#cb7-1537" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1538"><a href="#cb7-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1539"><a href="#cb7-1539" aria-hidden="true" tabindex="-1"></a><span class="co"># similar to ggplot2:::rotate_just</span></span>
<span id="cb7-1540"><a href="#cb7-1540" aria-hidden="true" tabindex="-1"></a>rotate_just <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">angle =</span> <span class="cn">NULL</span>, <span class="at">hjust =</span> <span class="cn">NULL</span>, <span class="at">vjust =</span> <span class="cn">NULL</span>) {</span>
<span id="cb7-1541"><a href="#cb7-1541" aria-hidden="true" tabindex="-1"></a>  angle <span class="ot">&lt;-</span> (angle <span class="sc">%||%</span> <span class="dv">0</span>) <span class="sc">%%</span> <span class="dv">360</span></span>
<span id="cb7-1542"><a href="#cb7-1542" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1543"><a href="#cb7-1543" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(hjust)) {</span>
<span id="cb7-1544"><a href="#cb7-1544" aria-hidden="true" tabindex="-1"></a>    hjust <span class="ot">&lt;-</span> <span class="fu">match</span>(hjust, <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"right"</span>)) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-1545"><a href="#cb7-1545" aria-hidden="true" tabindex="-1"></a>    hjust[<span class="fu">is.na</span>(hjust)] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-1546"><a href="#cb7-1546" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1547"><a href="#cb7-1547" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(vjust)) {</span>
<span id="cb7-1548"><a href="#cb7-1548" aria-hidden="true" tabindex="-1"></a>    vjust <span class="ot">&lt;-</span> <span class="fu">match</span>(vjust, <span class="fu">c</span>(<span class="st">"bottom"</span>, <span class="st">"top"</span>)) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-1549"><a href="#cb7-1549" aria-hidden="true" tabindex="-1"></a>    vjust[<span class="fu">is.na</span>(vjust)] <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-1550"><a href="#cb7-1550" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1551"><a href="#cb7-1551" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1552"><a href="#cb7-1552" aria-hidden="true" tabindex="-1"></a>  size <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">length</span>(angle), <span class="fu">length</span>(hjust), <span class="fu">length</span>(vjust))</span>
<span id="cb7-1553"><a href="#cb7-1553" aria-hidden="true" tabindex="-1"></a>  angle <span class="ot">&lt;-</span> <span class="fu">rep</span>(angle, <span class="at">length.out =</span> size)</span>
<span id="cb7-1554"><a href="#cb7-1554" aria-hidden="true" tabindex="-1"></a>  hjust <span class="ot">&lt;-</span> <span class="fu">rep</span>(hjust, <span class="at">length.out =</span> size)</span>
<span id="cb7-1555"><a href="#cb7-1555" aria-hidden="true" tabindex="-1"></a>  vjust <span class="ot">&lt;-</span> <span class="fu">rep</span>(vjust, <span class="at">length.out =</span> size)</span>
<span id="cb7-1556"><a href="#cb7-1556" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1557"><a href="#cb7-1557" aria-hidden="true" tabindex="-1"></a>  case <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(angle, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span>, <span class="dv">180</span>, <span class="dv">270</span>, <span class="dv">360</span>))</span>
<span id="cb7-1558"><a href="#cb7-1558" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1559"><a href="#cb7-1559" aria-hidden="true" tabindex="-1"></a>  hnew <span class="ot">&lt;-</span> hjust</span>
<span id="cb7-1560"><a href="#cb7-1560" aria-hidden="true" tabindex="-1"></a>  vnew <span class="ot">&lt;-</span> vjust</span>
<span id="cb7-1561"><a href="#cb7-1561" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1562"><a href="#cb7-1562" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">2</span>) <span class="co"># 90 &lt;= x &lt; 180</span></span>
<span id="cb7-1563"><a href="#cb7-1563" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> vjust[is_case]</span>
<span id="cb7-1564"><a href="#cb7-1564" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> hjust[is_case]</span>
<span id="cb7-1565"><a href="#cb7-1565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1566"><a href="#cb7-1566" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">3</span>) <span class="co"># 180 &lt;= x &lt; 270</span></span>
<span id="cb7-1567"><a href="#cb7-1567" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> hjust[is_case]</span>
<span id="cb7-1568"><a href="#cb7-1568" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> vjust[is_case]</span>
<span id="cb7-1569"><a href="#cb7-1569" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1570"><a href="#cb7-1570" aria-hidden="true" tabindex="-1"></a>  is_case <span class="ot">&lt;-</span> <span class="fu">which</span>(case <span class="sc">==</span> <span class="dv">4</span>) <span class="co"># 270 &lt;= x &lt; 360</span></span>
<span id="cb7-1571"><a href="#cb7-1571" aria-hidden="true" tabindex="-1"></a>  hnew[is_case] <span class="ot">&lt;-</span> vjust[is_case]</span>
<span id="cb7-1572"><a href="#cb7-1572" aria-hidden="true" tabindex="-1"></a>  vnew[is_case] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> hjust[is_case]</span>
<span id="cb7-1573"><a href="#cb7-1573" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1574"><a href="#cb7-1574" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">hjust =</span> hnew, <span class="at">vjust =</span> vnew)</span>
<span id="cb7-1575"><a href="#cb7-1575" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1576"><a href="#cb7-1576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1577"><a href="#cb7-1577" aria-hidden="true" tabindex="-1"></a><span class="co">#' Repulsive textual annotations.</span></span>
<span id="cb7-1578"><a href="#cb7-1578" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1579"><a href="#cb7-1579" aria-hidden="true" tabindex="-1"></a><span class="co">#' \code{geom_text_repel} adds text directly to the plot.</span></span>
<span id="cb7-1580"><a href="#cb7-1580" aria-hidden="true" tabindex="-1"></a><span class="co">#' \code{geom_label_repel} draws a rectangle underneath the text, making it</span></span>
<span id="cb7-1581"><a href="#cb7-1581" aria-hidden="true" tabindex="-1"></a><span class="co">#' easier to read. The text labels repel away from each other and away from</span></span>
<span id="cb7-1582"><a href="#cb7-1582" aria-hidden="true" tabindex="-1"></a><span class="co">#' the data points.</span></span>
<span id="cb7-1583"><a href="#cb7-1583" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1584"><a href="#cb7-1584" aria-hidden="true" tabindex="-1"></a><span class="co">#' These geoms are based on \code{\link[ggplot2]{geom_text}} and</span></span>
<span id="cb7-1585"><a href="#cb7-1585" aria-hidden="true" tabindex="-1"></a><span class="co">#' \code{\link[ggplot2]{geom_label}}. See the documentation for those</span></span>
<span id="cb7-1586"><a href="#cb7-1586" aria-hidden="true" tabindex="-1"></a><span class="co">#' functions for more details. Differences from those functions are noted</span></span>
<span id="cb7-1587"><a href="#cb7-1587" aria-hidden="true" tabindex="-1"></a><span class="co">#' here.</span></span>
<span id="cb7-1588"><a href="#cb7-1588" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1589"><a href="#cb7-1589" aria-hidden="true" tabindex="-1"></a><span class="co">#' Text labels have height and width, but they are physical units, not data</span></span>
<span id="cb7-1590"><a href="#cb7-1590" aria-hidden="true" tabindex="-1"></a><span class="co">#' units. The amount of space they occupy on that plot is not constant in data</span></span>
<span id="cb7-1591"><a href="#cb7-1591" aria-hidden="true" tabindex="-1"></a><span class="co">#' units: when you resize a plot, labels stay the same size, but the size of</span></span>
<span id="cb7-1592"><a href="#cb7-1592" aria-hidden="true" tabindex="-1"></a><span class="co">#' the axes changes. The text labels are repositioned after resizing a plot.</span></span>
<span id="cb7-1593"><a href="#cb7-1593" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1594"><a href="#cb7-1594" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section \code{geom_label_repel}:</span></span>
<span id="cb7-1595"><a href="#cb7-1595" aria-hidden="true" tabindex="-1"></a><span class="co">#' Currently \code{geom_label_repel} does not support the \code{rot} argument</span></span>
<span id="cb7-1596"><a href="#cb7-1596" aria-hidden="true" tabindex="-1"></a><span class="co">#' and is considerably slower than \code{geom_text_repel}. The \code{fill}</span></span>
<span id="cb7-1597"><a href="#cb7-1597" aria-hidden="true" tabindex="-1"></a><span class="co">#' aesthetic controls the background colour of the label.</span></span>
<span id="cb7-1598"><a href="#cb7-1598" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1599"><a href="#cb7-1599" aria-hidden="true" tabindex="-1"></a><span class="co">#' @section Alignment with \code{hjust} or \code{vjust}:</span></span>
<span id="cb7-1600"><a href="#cb7-1600" aria-hidden="true" tabindex="-1"></a><span class="co">#' The arguments \code{hjust} and \code{vjust} are supported, but they only</span></span>
<span id="cb7-1601"><a href="#cb7-1601" aria-hidden="true" tabindex="-1"></a><span class="co">#' control the initial positioning, so repulsive forces may disrupt alignment.</span></span>
<span id="cb7-1602"><a href="#cb7-1602" aria-hidden="true" tabindex="-1"></a><span class="co">#' Alignment with \code{hjust} will be preserved if labels only move up and down</span></span>
<span id="cb7-1603"><a href="#cb7-1603" aria-hidden="true" tabindex="-1"></a><span class="co">#' by using \code{direction="y"}. For \code{vjust}, use \code{direction="x"}.</span></span>
<span id="cb7-1604"><a href="#cb7-1604" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1605"><a href="#cb7-1605" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param mapping Set of aesthetic mappings created by \code{\link[ggplot2]{aes}} or</span></span>
<span id="cb7-1606"><a href="#cb7-1606" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{\link[ggplot2]{aes_}}. If specified and \code{inherit.aes = TRUE} (the</span></span>
<span id="cb7-1607"><a href="#cb7-1607" aria-hidden="true" tabindex="-1"></a><span class="co">#'   default), is combined with the default mapping at the top level of the</span></span>
<span id="cb7-1608"><a href="#cb7-1608" aria-hidden="true" tabindex="-1"></a><span class="co">#'   plot. You only need to supply \code{mapping} if there isn't a mapping</span></span>
<span id="cb7-1609"><a href="#cb7-1609" aria-hidden="true" tabindex="-1"></a><span class="co">#'   defined for the plot.</span></span>
<span id="cb7-1610"><a href="#cb7-1610" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data A data frame. If specified, overrides the default data frame</span></span>
<span id="cb7-1611"><a href="#cb7-1611" aria-hidden="true" tabindex="-1"></a><span class="co">#'   defined at the top level of the plot.</span></span>
<span id="cb7-1612"><a href="#cb7-1612" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param stat The statistical transformation to use on the data for this</span></span>
<span id="cb7-1613"><a href="#cb7-1613" aria-hidden="true" tabindex="-1"></a><span class="co">#'    layer, as a string.</span></span>
<span id="cb7-1614"><a href="#cb7-1614" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param position Position adjustment, either as a string, or the result of</span></span>
<span id="cb7-1615"><a href="#cb7-1615" aria-hidden="true" tabindex="-1"></a><span class="co">#'  a call to a position adjustment function.</span></span>
<span id="cb7-1616"><a href="#cb7-1616" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param parse If TRUE, the labels will be parsed into expressions and</span></span>
<span id="cb7-1617"><a href="#cb7-1617" aria-hidden="true" tabindex="-1"></a><span class="co">#'   displayed as described in ?plotmath</span></span>
<span id="cb7-1618"><a href="#cb7-1618" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param na.rm If \code{FALSE} (the default), removes missing values with</span></span>
<span id="cb7-1619"><a href="#cb7-1619" aria-hidden="true" tabindex="-1"></a><span class="co">#'    a warning.  If \code{TRUE} silently removes missing values.</span></span>
<span id="cb7-1620"><a href="#cb7-1620" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param show.legend logical. Should this layer be included in the legends?</span></span>
<span id="cb7-1621"><a href="#cb7-1621" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{NA}, the default, includes if any aesthetics are mapped.</span></span>
<span id="cb7-1622"><a href="#cb7-1622" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{FALSE} never includes, and \code{TRUE} always includes.</span></span>
<span id="cb7-1623"><a href="#cb7-1623" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param inherit.aes If \code{FALSE}, overrides the default aesthetics,</span></span>
<span id="cb7-1624"><a href="#cb7-1624" aria-hidden="true" tabindex="-1"></a><span class="co">#'   rather than combining with them. This is most useful for helper functions</span></span>
<span id="cb7-1625"><a href="#cb7-1625" aria-hidden="true" tabindex="-1"></a><span class="co">#'   that define both data and aesthetics and shouldn't inherit behaviour from</span></span>
<span id="cb7-1626"><a href="#cb7-1626" aria-hidden="true" tabindex="-1"></a><span class="co">#'   the default plot specification, e.g. \code{\link[ggplot2]{borders}}.</span></span>
<span id="cb7-1627"><a href="#cb7-1627" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... other arguments passed on to \code{\link[ggplot2]{layer}}. There are</span></span>
<span id="cb7-1628"><a href="#cb7-1628" aria-hidden="true" tabindex="-1"></a><span class="co">#'   three types of arguments you can use here:</span></span>
<span id="cb7-1629"><a href="#cb7-1629" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1630"><a href="#cb7-1630" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \itemize{</span></span>
<span id="cb7-1631"><a href="#cb7-1631" aria-hidden="true" tabindex="-1"></a><span class="co">#'     \item Aesthetics: to set an aesthetic to a fixed value, like</span></span>
<span id="cb7-1632"><a href="#cb7-1632" aria-hidden="true" tabindex="-1"></a><span class="co">#'        \code{colour = "red"} or \code{size = 3}.</span></span>
<span id="cb7-1633"><a href="#cb7-1633" aria-hidden="true" tabindex="-1"></a><span class="co">#'     \item Other arguments to the layer, for example you override the</span></span>
<span id="cb7-1634"><a href="#cb7-1634" aria-hidden="true" tabindex="-1"></a><span class="co">#'       default \code{stat} associated with the layer.</span></span>
<span id="cb7-1635"><a href="#cb7-1635" aria-hidden="true" tabindex="-1"></a><span class="co">#'     \item Other arguments passed on to the stat.</span></span>
<span id="cb7-1636"><a href="#cb7-1636" aria-hidden="true" tabindex="-1"></a><span class="co">#'   }</span></span>
<span id="cb7-1637"><a href="#cb7-1637" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nudge_x,nudge_y Horizontal and vertical adjustments to nudge the</span></span>
<span id="cb7-1638"><a href="#cb7-1638" aria-hidden="true" tabindex="-1"></a><span class="co">#'   starting position of each text label. The units for \code{nudge_x} and</span></span>
<span id="cb7-1639"><a href="#cb7-1639" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{nudge_y} are the same as for the data units on the x-axis and y-axis.</span></span>
<span id="cb7-1640"><a href="#cb7-1640" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xlim,ylim Limits for the x and y axes. Text labels will be constrained</span></span>
<span id="cb7-1641"><a href="#cb7-1641" aria-hidden="true" tabindex="-1"></a><span class="co">#'   to these limits. By default, text labels are constrained to the entire plot</span></span>
<span id="cb7-1642"><a href="#cb7-1642" aria-hidden="true" tabindex="-1"></a><span class="co">#'   area.</span></span>
<span id="cb7-1643"><a href="#cb7-1643" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param box.padding Amount of padding around bounding box, as unit or number.</span></span>
<span id="cb7-1644"><a href="#cb7-1644" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Defaults to 0.25. (Default unit is lines, but other units can be specified</span></span>
<span id="cb7-1645"><a href="#cb7-1645" aria-hidden="true" tabindex="-1"></a><span class="co">#'   by passing \code{unit(x, "units")}).</span></span>
<span id="cb7-1646"><a href="#cb7-1646" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param point.padding Amount of padding around labeled point, as unit or</span></span>
<span id="cb7-1647"><a href="#cb7-1647" aria-hidden="true" tabindex="-1"></a><span class="co">#'   number. Defaults to 0. (Default unit is lines, but other units can be</span></span>
<span id="cb7-1648"><a href="#cb7-1648" aria-hidden="true" tabindex="-1"></a><span class="co">#'   specified by passing \code{unit(x, "units")}).</span></span>
<span id="cb7-1649"><a href="#cb7-1649" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param min.segment.length Skip drawing segments shorter than this, as unit or</span></span>
<span id="cb7-1650"><a href="#cb7-1650" aria-hidden="true" tabindex="-1"></a><span class="co">#'   number. Defaults to 0.5. (Default unit is lines, but other units can be</span></span>
<span id="cb7-1651"><a href="#cb7-1651" aria-hidden="true" tabindex="-1"></a><span class="co">#'   specified by passing \code{unit(x, "units")}).</span></span>
<span id="cb7-1652"><a href="#cb7-1652" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param arrow specification for arrow heads, as created by \code{\link[grid]{arrow}}</span></span>
<span id="cb7-1653"><a href="#cb7-1653" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force Force of repulsion between overlapping text labels. Defaults</span></span>
<span id="cb7-1654"><a href="#cb7-1654" aria-hidden="true" tabindex="-1"></a><span class="co">#'   to 1.</span></span>
<span id="cb7-1655"><a href="#cb7-1655" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force_pull Force of attraction between a text label and its</span></span>
<span id="cb7-1656"><a href="#cb7-1656" aria-hidden="true" tabindex="-1"></a><span class="co">#'   corresponding data point. Defaults to 1.</span></span>
<span id="cb7-1657"><a href="#cb7-1657" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max.time Maximum number of seconds to try to resolve overlaps.</span></span>
<span id="cb7-1658"><a href="#cb7-1658" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Defaults to 0.5.</span></span>
<span id="cb7-1659"><a href="#cb7-1659" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max.iter Maximum number of iterations to try to resolve overlaps.</span></span>
<span id="cb7-1660"><a href="#cb7-1660" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Defaults to 10000.</span></span>
<span id="cb7-1661"><a href="#cb7-1661" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max.overlaps Exclude text labels when they overlap too many other</span></span>
<span id="cb7-1662"><a href="#cb7-1662" aria-hidden="true" tabindex="-1"></a><span class="co">#'   things. For each text label, we count how many other text labels or other</span></span>
<span id="cb7-1663"><a href="#cb7-1663" aria-hidden="true" tabindex="-1"></a><span class="co">#'   data points it overlaps, and exclude the text label if it has too many overlaps.</span></span>
<span id="cb7-1664"><a href="#cb7-1664" aria-hidden="true" tabindex="-1"></a><span class="co">#'   Defaults to 10.</span></span>
<span id="cb7-1665"><a href="#cb7-1665" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param direction "both", "x", or "y" -- direction in which to adjust position of labels</span></span>
<span id="cb7-1666"><a href="#cb7-1666" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param seed Random seed passed to \code{\link[base]{set.seed}}. Defaults to</span></span>
<span id="cb7-1667"><a href="#cb7-1667" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{NA}, which means that \code{set.seed} will not be called.</span></span>
<span id="cb7-1668"><a href="#cb7-1668" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param verbose If \code{TRUE}, some diagnostics of the repel algorithm are printed</span></span>
<span id="cb7-1669"><a href="#cb7-1669" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1670"><a href="#cb7-1670" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb7-1671"><a href="#cb7-1671" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1672"><a href="#cb7-1672" aria-hidden="true" tabindex="-1"></a><span class="co">#' p &lt;- ggplot(mtcars,</span></span>
<span id="cb7-1673"><a href="#cb7-1673" aria-hidden="true" tabindex="-1"></a><span class="co">#'   aes(wt, mpg, label = rownames(mtcars), colour = factor(cyl))) +</span></span>
<span id="cb7-1674"><a href="#cb7-1674" aria-hidden="true" tabindex="-1"></a><span class="co">#'   geom_point()</span></span>
<span id="cb7-1675"><a href="#cb7-1675" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1676"><a href="#cb7-1676" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Avoid overlaps by repelling text labels</span></span>
<span id="cb7-1677"><a href="#cb7-1677" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel()</span></span>
<span id="cb7-1678"><a href="#cb7-1678" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Labels with background</span></span>
<span id="cb7-1679"><a href="#cb7-1679" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_label_repel()</span></span>
<span id="cb7-1680"><a href="#cb7-1680" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1681"><a href="#cb7-1681" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb7-1682"><a href="#cb7-1682" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(family = "Times New Roman",</span></span>
<span id="cb7-1683"><a href="#cb7-1683" aria-hidden="true" tabindex="-1"></a><span class="co">#'   box.padding = 0.5)</span></span>
<span id="cb7-1684"><a href="#cb7-1684" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1685"><a href="#cb7-1685" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Add aesthetic mappings</span></span>
<span id="cb7-1686"><a href="#cb7-1686" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(aes(alpha=wt, size=mpg))</span></span>
<span id="cb7-1687"><a href="#cb7-1687" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_label_repel(aes(fill=factor(cyl)), colour="white", segment.colour="black")</span></span>
<span id="cb7-1688"><a href="#cb7-1688" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1689"><a href="#cb7-1689" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Draw all line segments</span></span>
<span id="cb7-1690"><a href="#cb7-1690" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(min.segment.length = 0)</span></span>
<span id="cb7-1691"><a href="#cb7-1691" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1692"><a href="#cb7-1692" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Omit short line segments (default behavior)</span></span>
<span id="cb7-1693"><a href="#cb7-1693" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(min.segment.length = 0.5)</span></span>
<span id="cb7-1694"><a href="#cb7-1694" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1695"><a href="#cb7-1695" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Omit all line segments</span></span>
<span id="cb7-1696"><a href="#cb7-1696" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(segment.colour = NA)</span></span>
<span id="cb7-1697"><a href="#cb7-1697" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1698"><a href="#cb7-1698" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Repel just the labels and totally ignore the data points</span></span>
<span id="cb7-1699"><a href="#cb7-1699" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(point.size = NA)</span></span>
<span id="cb7-1700"><a href="#cb7-1700" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1701"><a href="#cb7-1701" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Hide some of the labels, but repel from all data points</span></span>
<span id="cb7-1702"><a href="#cb7-1702" aria-hidden="true" tabindex="-1"></a><span class="co">#' mtcars$label &lt;- rownames(mtcars)</span></span>
<span id="cb7-1703"><a href="#cb7-1703" aria-hidden="true" tabindex="-1"></a><span class="co">#' mtcars$label[1:15] &lt;- ""</span></span>
<span id="cb7-1704"><a href="#cb7-1704" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(data = mtcars, aes(wt, mpg, label = label))</span></span>
<span id="cb7-1705"><a href="#cb7-1705" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1706"><a href="#cb7-1706" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Nudge the starting positions</span></span>
<span id="cb7-1707"><a href="#cb7-1707" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(nudge_x = ifelse(mtcars$cyl == 6, 1, 0),</span></span>
<span id="cb7-1708"><a href="#cb7-1708" aria-hidden="true" tabindex="-1"></a><span class="co">#'                     nudge_y = ifelse(mtcars$cyl == 6, 8, 0))</span></span>
<span id="cb7-1709"><a href="#cb7-1709" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1710"><a href="#cb7-1710" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Change the text size</span></span>
<span id="cb7-1711"><a href="#cb7-1711" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(aes(size = wt))</span></span>
<span id="cb7-1712"><a href="#cb7-1712" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Scale height of text, rather than sqrt(height)</span></span>
<span id="cb7-1713"><a href="#cb7-1713" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(aes(size = wt)) + scale_radius(range = c(3,6))</span></span>
<span id="cb7-1714"><a href="#cb7-1714" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1715"><a href="#cb7-1715" aria-hidden="true" tabindex="-1"></a><span class="co">#' # You can display expressions by setting parse = TRUE.  The</span></span>
<span id="cb7-1716"><a href="#cb7-1716" aria-hidden="true" tabindex="-1"></a><span class="co">#' # details of the display are described in ?plotmath, but note that</span></span>
<span id="cb7-1717"><a href="#cb7-1717" aria-hidden="true" tabindex="-1"></a><span class="co">#' # geom_text_repel uses strings, not expressions.</span></span>
<span id="cb7-1718"><a href="#cb7-1718" aria-hidden="true" tabindex="-1"></a><span class="co">#' p + geom_text_repel(aes(label = paste(wt, "^(", cyl, ")", sep = "")),</span></span>
<span id="cb7-1719"><a href="#cb7-1719" aria-hidden="true" tabindex="-1"></a><span class="co">#'   parse = TRUE)</span></span>
<span id="cb7-1720"><a href="#cb7-1720" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1721"><a href="#cb7-1721" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Add a text annotation</span></span>
<span id="cb7-1722"><a href="#cb7-1722" aria-hidden="true" tabindex="-1"></a><span class="co">#' p +</span></span>
<span id="cb7-1723"><a href="#cb7-1723" aria-hidden="true" tabindex="-1"></a><span class="co">#'   geom_text_repel() +</span></span>
<span id="cb7-1724"><a href="#cb7-1724" aria-hidden="true" tabindex="-1"></a><span class="co">#'   annotate(</span></span>
<span id="cb7-1725"><a href="#cb7-1725" aria-hidden="true" tabindex="-1"></a><span class="co">#'     "text", label = "plot mpg vs. wt",</span></span>
<span id="cb7-1726"><a href="#cb7-1726" aria-hidden="true" tabindex="-1"></a><span class="co">#'     x = 2, y = 15, size = 8, colour = "red"</span></span>
<span id="cb7-1727"><a href="#cb7-1727" aria-hidden="true" tabindex="-1"></a><span class="co">#'   )</span></span>
<span id="cb7-1728"><a href="#cb7-1728" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1729"><a href="#cb7-1729" aria-hidden="true" tabindex="-1"></a><span class="co">#' # Add arrows</span></span>
<span id="cb7-1730"><a href="#cb7-1730" aria-hidden="true" tabindex="-1"></a><span class="co">#' p +</span></span>
<span id="cb7-1731"><a href="#cb7-1731" aria-hidden="true" tabindex="-1"></a><span class="co">#'   geom_point(colour = "red") +</span></span>
<span id="cb7-1732"><a href="#cb7-1732" aria-hidden="true" tabindex="-1"></a><span class="co">#'   geom_text_repel(</span></span>
<span id="cb7-1733"><a href="#cb7-1733" aria-hidden="true" tabindex="-1"></a><span class="co">#'     arrow = arrow(length = unit(0.02, "npc")),</span></span>
<span id="cb7-1734"><a href="#cb7-1734" aria-hidden="true" tabindex="-1"></a><span class="co">#'     box.padding = 1</span></span>
<span id="cb7-1735"><a href="#cb7-1735" aria-hidden="true" tabindex="-1"></a><span class="co">#'   )</span></span>
<span id="cb7-1736"><a href="#cb7-1736" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-1737"><a href="#cb7-1737" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb7-1738"><a href="#cb7-1738" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-1739"><a href="#cb7-1739" aria-hidden="true" tabindex="-1"></a>geom_text_repel <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-1740"><a href="#cb7-1740" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="cn">NULL</span>, <span class="at">data =</span> <span class="cn">NULL</span>, <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"identity"</span>,</span>
<span id="cb7-1741"><a href="#cb7-1741" aria-hidden="true" tabindex="-1"></a>    <span class="at">parse =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1742"><a href="#cb7-1742" aria-hidden="true" tabindex="-1"></a>    ...,</span>
<span id="cb7-1743"><a href="#cb7-1743" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-1744"><a href="#cb7-1744" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-1745"><a href="#cb7-1745" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1746"><a href="#cb7-1746" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1747"><a href="#cb7-1747" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>,</span>
<span id="cb7-1748"><a href="#cb7-1748" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-1749"><a href="#cb7-1749" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1750"><a href="#cb7-1750" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.iter =</span> <span class="dv">10000</span>,</span>
<span id="cb7-1751"><a href="#cb7-1751" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="fu">getOption</span>(<span class="st">"ggrepel.max.overlaps"</span>, <span class="at">default =</span> <span class="dv">10</span>),</span>
<span id="cb7-1752"><a href="#cb7-1752" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>,</span>
<span id="cb7-1753"><a href="#cb7-1753" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-1754"><a href="#cb7-1754" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-1755"><a href="#cb7-1755" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-1756"><a href="#cb7-1756" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1757"><a href="#cb7-1757" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> <span class="cn">NA</span>,</span>
<span id="cb7-1758"><a href="#cb7-1758" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="fu">c</span>(<span class="st">"both"</span>,<span class="st">"y"</span>,<span class="st">"x"</span>),</span>
<span id="cb7-1759"><a href="#cb7-1759" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-1760"><a href="#cb7-1760" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>),</span>
<span id="cb7-1761"><a href="#cb7-1761" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> <span class="cn">TRUE</span></span>
<span id="cb7-1762"><a href="#cb7-1762" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-1763"><a href="#cb7-1763" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(nudge_x) <span class="sc">||</span> <span class="sc">!</span><span class="fu">missing</span>(nudge_y)) {</span>
<span id="cb7-1764"><a href="#cb7-1764" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(position)) {</span>
<span id="cb7-1765"><a href="#cb7-1765" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Specify either `position` or `nudge_x`/`nudge_y`"</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-1766"><a href="#cb7-1766" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-1767"><a href="#cb7-1767" aria-hidden="true" tabindex="-1"></a>    position <span class="ot">&lt;-</span> <span class="fu">position_nudge_repel</span>(nudge_x, nudge_y)</span>
<span id="cb7-1768"><a href="#cb7-1768" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1769"><a href="#cb7-1769" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Warn about limitations of the algorithm</span></span>
<span id="cb7-1770"><a href="#cb7-1770" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">abs</span>(data<span class="sc">$</span>angle <span class="sc">%%</span> <span class="dv">90</span>) <span class="sc">&gt;</span> <span class="dv">5</span>)) {</span>
<span id="cb7-1771"><a href="#cb7-1771" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-1772"><a href="#cb7-1772" aria-hidden="true" tabindex="-1"></a>      <span class="st">"ggrepel: Repulsion works correctly only for rotation angles multiple of 90 degrees"</span></span>
<span id="cb7-1773"><a href="#cb7-1773" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1774"><a href="#cb7-1774" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1775"><a href="#cb7-1775" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer</span>(</span>
<span id="cb7-1776"><a href="#cb7-1776" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data,</span>
<span id="cb7-1777"><a href="#cb7-1777" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> mapping,</span>
<span id="cb7-1778"><a href="#cb7-1778" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> stat,</span>
<span id="cb7-1779"><a href="#cb7-1779" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> GeomTextRepel,</span>
<span id="cb7-1780"><a href="#cb7-1780" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> position,</span>
<span id="cb7-1781"><a href="#cb7-1781" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> show.legend,</span>
<span id="cb7-1782"><a href="#cb7-1782" aria-hidden="true" tabindex="-1"></a>    <span class="at">inherit.aes =</span> inherit.aes,</span>
<span id="cb7-1783"><a href="#cb7-1783" aria-hidden="true" tabindex="-1"></a>    <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb7-1784"><a href="#cb7-1784" aria-hidden="true" tabindex="-1"></a>      <span class="at">parse =</span> parse,</span>
<span id="cb7-1785"><a href="#cb7-1785" aria-hidden="true" tabindex="-1"></a>      <span class="at">na.rm =</span> na.rm,</span>
<span id="cb7-1786"><a href="#cb7-1786" aria-hidden="true" tabindex="-1"></a>      <span class="at">box.padding =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-1787"><a href="#cb7-1787" aria-hidden="true" tabindex="-1"></a>      <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-1788"><a href="#cb7-1788" aria-hidden="true" tabindex="-1"></a>      <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-1789"><a href="#cb7-1789" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow,</span>
<span id="cb7-1790"><a href="#cb7-1790" aria-hidden="true" tabindex="-1"></a>      <span class="at">force =</span> force,</span>
<span id="cb7-1791"><a href="#cb7-1791" aria-hidden="true" tabindex="-1"></a>      <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-1792"><a href="#cb7-1792" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.time =</span> max.time,</span>
<span id="cb7-1793"><a href="#cb7-1793" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.iter =</span> max.iter,</span>
<span id="cb7-1794"><a href="#cb7-1794" aria-hidden="true" tabindex="-1"></a>      <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-1795"><a href="#cb7-1795" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_x =</span> nudge_x,</span>
<span id="cb7-1796"><a href="#cb7-1796" aria-hidden="true" tabindex="-1"></a>      <span class="at">nudge_y =</span> nudge_y,</span>
<span id="cb7-1797"><a href="#cb7-1797" aria-hidden="true" tabindex="-1"></a>      <span class="at">xlim =</span> xlim,</span>
<span id="cb7-1798"><a href="#cb7-1798" aria-hidden="true" tabindex="-1"></a>      <span class="at">ylim =</span> ylim,</span>
<span id="cb7-1799"><a href="#cb7-1799" aria-hidden="true" tabindex="-1"></a>      <span class="at">direction =</span> <span class="fu">match.arg</span>(direction),</span>
<span id="cb7-1800"><a href="#cb7-1800" aria-hidden="true" tabindex="-1"></a>      <span class="at">seed =</span> seed,</span>
<span id="cb7-1801"><a href="#cb7-1801" aria-hidden="true" tabindex="-1"></a>      <span class="at">verbose =</span> verbose,</span>
<span id="cb7-1802"><a href="#cb7-1802" aria-hidden="true" tabindex="-1"></a>      ...</span>
<span id="cb7-1803"><a href="#cb7-1803" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1804"><a href="#cb7-1804" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-1805"><a href="#cb7-1805" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-1806"><a href="#cb7-1806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1807"><a href="#cb7-1807" aria-hidden="true" tabindex="-1"></a><span class="co">#' GeomTextRepel</span></span>
<span id="cb7-1808"><a href="#cb7-1808" aria-hidden="true" tabindex="-1"></a><span class="co">#' @rdname ggrepel</span></span>
<span id="cb7-1809"><a href="#cb7-1809" aria-hidden="true" tabindex="-1"></a><span class="co">#' @format NULL</span></span>
<span id="cb7-1810"><a href="#cb7-1810" aria-hidden="true" tabindex="-1"></a><span class="co">#' @usage NULL</span></span>
<span id="cb7-1811"><a href="#cb7-1811" aria-hidden="true" tabindex="-1"></a><span class="co">#' @seealso \link[ggplot2]{GeomText} from the ggplot2 package.</span></span>
<span id="cb7-1812"><a href="#cb7-1812" aria-hidden="true" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb7-1813"><a href="#cb7-1813" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-1814"><a href="#cb7-1814" aria-hidden="true" tabindex="-1"></a>GeomTextRepel <span class="ot">&lt;-</span> <span class="fu">ggproto</span>(<span class="st">"GeomTextRepel"</span>, Geom,</span>
<span id="cb7-1815"><a href="#cb7-1815" aria-hidden="true" tabindex="-1"></a>                         <span class="at">required_aes =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"label"</span>),</span>
<span id="cb7-1816"><a href="#cb7-1816" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb7-1817"><a href="#cb7-1817" aria-hidden="true" tabindex="-1"></a>                         <span class="at">default_aes =</span> <span class="fu">aes</span>(</span>
<span id="cb7-1818"><a href="#cb7-1818" aria-hidden="true" tabindex="-1"></a>                           <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">3.88</span>, <span class="at">angle =</span> <span class="dv">0</span>,</span>
<span id="cb7-1819"><a href="#cb7-1819" aria-hidden="true" tabindex="-1"></a>                           <span class="at">alpha =</span> <span class="cn">NA</span>, <span class="at">family =</span> <span class="st">""</span>, <span class="at">fontface =</span> <span class="dv">1</span>, <span class="at">lineheight =</span> <span class="fl">1.2</span>,</span>
<span id="cb7-1820"><a href="#cb7-1820" aria-hidden="true" tabindex="-1"></a>                           <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-1821"><a href="#cb7-1821" aria-hidden="true" tabindex="-1"></a>                           <span class="at">segment.linetype =</span> <span class="dv">1</span>, <span class="at">segment.colour =</span> <span class="cn">NULL</span>, <span class="at">segment.size =</span> <span class="fl">0.5</span>, <span class="at">segment.alpha =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1822"><a href="#cb7-1822" aria-hidden="true" tabindex="-1"></a>                           <span class="at">segment.curvature =</span> <span class="dv">0</span>, <span class="at">segment.angle =</span> <span class="dv">90</span>, <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-1823"><a href="#cb7-1823" aria-hidden="true" tabindex="-1"></a>                           <span class="at">segment.shape =</span> <span class="fl">0.5</span>, <span class="at">segment.square =</span> <span class="cn">TRUE</span>, <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-1824"><a href="#cb7-1824" aria-hidden="true" tabindex="-1"></a>                           <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>, <span class="at">segment.debug =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1825"><a href="#cb7-1825" aria-hidden="true" tabindex="-1"></a>                           <span class="at">bg.colour =</span> <span class="cn">NA</span>, <span class="at">bg.r =</span> <span class="fl">0.1</span></span>
<span id="cb7-1826"><a href="#cb7-1826" aria-hidden="true" tabindex="-1"></a>                         ),</span>
<span id="cb7-1827"><a href="#cb7-1827" aria-hidden="true" tabindex="-1"></a>                         </span>
<span id="cb7-1828"><a href="#cb7-1828" aria-hidden="true" tabindex="-1"></a>                         <span class="at">draw_panel =</span> <span class="cf">function</span>(</span>
<span id="cb7-1829"><a href="#cb7-1829" aria-hidden="true" tabindex="-1"></a>    data, panel_scales, coord,</span>
<span id="cb7-1830"><a href="#cb7-1830" aria-hidden="true" tabindex="-1"></a>    <span class="at">parse =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1831"><a href="#cb7-1831" aria-hidden="true" tabindex="-1"></a>    <span class="at">na.rm =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-1832"><a href="#cb7-1832" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-1833"><a href="#cb7-1833" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-1834"><a href="#cb7-1834" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1835"><a href="#cb7-1835" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-1836"><a href="#cb7-1836" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">1</span>,</span>
<span id="cb7-1837"><a href="#cb7-1837" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="dv">1</span>,</span>
<span id="cb7-1838"><a href="#cb7-1838" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.time =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-1839"><a href="#cb7-1839" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.iter =</span> <span class="dv">10000</span>,</span>
<span id="cb7-1840"><a href="#cb7-1840" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="dv">10</span>,</span>
<span id="cb7-1841"><a href="#cb7-1841" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_x =</span> <span class="dv">0</span>,</span>
<span id="cb7-1842"><a href="#cb7-1842" aria-hidden="true" tabindex="-1"></a>    <span class="at">nudge_y =</span> <span class="dv">0</span>,</span>
<span id="cb7-1843"><a href="#cb7-1843" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-1844"><a href="#cb7-1844" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb7-1845"><a href="#cb7-1845" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="st">"both"</span>,</span>
<span id="cb7-1846"><a href="#cb7-1846" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="cn">NA</span>,</span>
<span id="cb7-1847"><a href="#cb7-1847" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="fu">getOption</span>(<span class="st">"verbose"</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-1848"><a href="#cb7-1848" aria-hidden="true" tabindex="-1"></a>                         ) {</span>
<span id="cb7-1849"><a href="#cb7-1849" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1850"><a href="#cb7-1850" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (parse) {</span>
<span id="cb7-1851"><a href="#cb7-1851" aria-hidden="true" tabindex="-1"></a>                             data<span class="sc">$</span>label <span class="ot">&lt;-</span> <span class="fu">parse_safe</span>(<span class="fu">as.character</span>(data<span class="sc">$</span>label))</span>
<span id="cb7-1852"><a href="#cb7-1852" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1853"><a href="#cb7-1853" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (<span class="sc">!</span><span class="fu">length</span>(data<span class="sc">$</span>label) <span class="sc">||</span> <span class="sc">!</span><span class="fu">length</span>(<span class="fu">which</span>(<span class="fu">not_empty</span>(data<span class="sc">$</span>label)))) {</span>
<span id="cb7-1854"><a href="#cb7-1854" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">return</span>()</span>
<span id="cb7-1855"><a href="#cb7-1855" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1856"><a href="#cb7-1856" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1857"><a href="#cb7-1857" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># if needed rename columns using our convention</span></span>
<span id="cb7-1858"><a href="#cb7-1858" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">for</span> (this_dim <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)) {</span>
<span id="cb7-1859"><a href="#cb7-1859" aria-hidden="true" tabindex="-1"></a>                             this_orig <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s_orig"</span>, this_dim)</span>
<span id="cb7-1860"><a href="#cb7-1860" aria-hidden="true" tabindex="-1"></a>                             this_nudge <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"nudge_%s"</span>, this_dim)</span>
<span id="cb7-1861"><a href="#cb7-1861" aria-hidden="true" tabindex="-1"></a>                             <span class="cf">if</span> (<span class="sc">!</span>this_nudge <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-1862"><a href="#cb7-1862" aria-hidden="true" tabindex="-1"></a>                               data[[this_nudge]] <span class="ot">&lt;-</span> data[[this_dim]]</span>
<span id="cb7-1863"><a href="#cb7-1863" aria-hidden="true" tabindex="-1"></a>                               <span class="cf">if</span> (this_orig <span class="sc">%in%</span> <span class="fu">colnames</span>(data)) {</span>
<span id="cb7-1864"><a href="#cb7-1864" aria-hidden="true" tabindex="-1"></a>                                 data[[this_dim]] <span class="ot">&lt;-</span> data[[this_orig]]</span>
<span id="cb7-1865"><a href="#cb7-1865" aria-hidden="true" tabindex="-1"></a>                                 data[[this_orig]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb7-1866"><a href="#cb7-1866" aria-hidden="true" tabindex="-1"></a>                               }</span>
<span id="cb7-1867"><a href="#cb7-1867" aria-hidden="true" tabindex="-1"></a>                             }</span>
<span id="cb7-1868"><a href="#cb7-1868" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1869"><a href="#cb7-1869" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1870"><a href="#cb7-1870" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Transform the nudges to the panel scales.</span></span>
<span id="cb7-1871"><a href="#cb7-1871" aria-hidden="true" tabindex="-1"></a>                           nudges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> data<span class="sc">$</span>nudge_x, <span class="at">y =</span> data<span class="sc">$</span>nudge_y)</span>
<span id="cb7-1872"><a href="#cb7-1872" aria-hidden="true" tabindex="-1"></a>                           nudges <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(nudges, panel_scales)</span>
<span id="cb7-1873"><a href="#cb7-1873" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1874"><a href="#cb7-1874" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Transform the raw data to the panel scales.</span></span>
<span id="cb7-1875"><a href="#cb7-1875" aria-hidden="true" tabindex="-1"></a>                           data <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(data, panel_scales)</span>
<span id="cb7-1876"><a href="#cb7-1876" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1877"><a href="#cb7-1877" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># The nudge is relative to the data.</span></span>
<span id="cb7-1878"><a href="#cb7-1878" aria-hidden="true" tabindex="-1"></a>                           data<span class="sc">$</span>nudge_x <span class="ot">&lt;-</span> nudges<span class="sc">$</span>x <span class="sc">-</span> data<span class="sc">$</span>x</span>
<span id="cb7-1879"><a href="#cb7-1879" aria-hidden="true" tabindex="-1"></a>                           data<span class="sc">$</span>nudge_y <span class="ot">&lt;-</span> nudges<span class="sc">$</span>y <span class="sc">-</span> data<span class="sc">$</span>y</span>
<span id="cb7-1880"><a href="#cb7-1880" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1881"><a href="#cb7-1881" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Transform limits to panel scales.</span></span>
<span id="cb7-1882"><a href="#cb7-1882" aria-hidden="true" tabindex="-1"></a>                           limits <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> xlim, <span class="at">y =</span> ylim)</span>
<span id="cb7-1883"><a href="#cb7-1883" aria-hidden="true" tabindex="-1"></a>                           limits <span class="ot">&lt;-</span> coord<span class="sc">$</span><span class="fu">transform</span>(limits, panel_scales)</span>
<span id="cb7-1884"><a href="#cb7-1884" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1885"><a href="#cb7-1885" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Allow Inf.</span></span>
<span id="cb7-1886"><a href="#cb7-1886" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>x) <span class="sc">==</span> <span class="fu">length</span>(xlim)) {</span>
<span id="cb7-1887"><a href="#cb7-1887" aria-hidden="true" tabindex="-1"></a>                             limits<span class="sc">$</span>x[<span class="fu">is.infinite</span>(xlim)] <span class="ot">&lt;-</span> xlim[<span class="fu">is.infinite</span>(xlim)]</span>
<span id="cb7-1888"><a href="#cb7-1888" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1889"><a href="#cb7-1889" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (<span class="fu">length</span>(limits<span class="sc">$</span>y) <span class="sc">==</span> <span class="fu">length</span>(ylim)) {</span>
<span id="cb7-1890"><a href="#cb7-1890" aria-hidden="true" tabindex="-1"></a>                             limits<span class="sc">$</span>y[<span class="fu">is.infinite</span>(ylim)] <span class="ot">&lt;-</span> ylim[<span class="fu">is.infinite</span>(ylim)]</span>
<span id="cb7-1891"><a href="#cb7-1891" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1892"><a href="#cb7-1892" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1893"><a href="#cb7-1893" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Fill NAs with defaults.</span></span>
<span id="cb7-1894"><a href="#cb7-1894" aria-hidden="true" tabindex="-1"></a>                           limits<span class="sc">$</span>x[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>x)]</span>
<span id="cb7-1895"><a href="#cb7-1895" aria-hidden="true" tabindex="-1"></a>                           limits<span class="sc">$</span>y[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)[<span class="fu">is.na</span>(limits<span class="sc">$</span>y)]</span>
<span id="cb7-1896"><a href="#cb7-1896" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1897"><a href="#cb7-1897" aria-hidden="true" tabindex="-1"></a>                           <span class="co"># Convert hjust and vjust to numeric if character</span></span>
<span id="cb7-1898"><a href="#cb7-1898" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>vjust)) {</span>
<span id="cb7-1899"><a href="#cb7-1899" aria-hidden="true" tabindex="-1"></a>                             data<span class="sc">$</span>vjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>vjust, data<span class="sc">$</span>y, data<span class="sc">$</span>x, data<span class="sc">$</span>angle)</span>
<span id="cb7-1900"><a href="#cb7-1900" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1901"><a href="#cb7-1901" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> (<span class="fu">is.character</span>(data<span class="sc">$</span>hjust)) {</span>
<span id="cb7-1902"><a href="#cb7-1902" aria-hidden="true" tabindex="-1"></a>                             data<span class="sc">$</span>hjust <span class="ot">&lt;-</span> <span class="fu">compute_just</span>(data<span class="sc">$</span>hjust, data<span class="sc">$</span>x, data<span class="sc">$</span>y, data<span class="sc">$</span>angle)</span>
<span id="cb7-1903"><a href="#cb7-1903" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb7-1904"><a href="#cb7-1904" aria-hidden="true" tabindex="-1"></a>                           </span>
<span id="cb7-1905"><a href="#cb7-1905" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">ggname</span>(<span class="st">"geom_text_repel"</span>, <span class="fu">gTree</span>(</span>
<span id="cb7-1906"><a href="#cb7-1906" aria-hidden="true" tabindex="-1"></a>                             <span class="at">limits =</span> limits,</span>
<span id="cb7-1907"><a href="#cb7-1907" aria-hidden="true" tabindex="-1"></a>                             <span class="at">data =</span> data,</span>
<span id="cb7-1908"><a href="#cb7-1908" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lab =</span> data<span class="sc">$</span>label,</span>
<span id="cb7-1909"><a href="#cb7-1909" aria-hidden="true" tabindex="-1"></a>                             <span class="at">box.padding =</span> <span class="fu">to_unit</span>(box.padding),</span>
<span id="cb7-1910"><a href="#cb7-1910" aria-hidden="true" tabindex="-1"></a>                             <span class="at">point.padding =</span> <span class="fu">to_unit</span>(point.padding),</span>
<span id="cb7-1911"><a href="#cb7-1911" aria-hidden="true" tabindex="-1"></a>                             <span class="at">min.segment.length =</span> <span class="fu">to_unit</span>(min.segment.length),</span>
<span id="cb7-1912"><a href="#cb7-1912" aria-hidden="true" tabindex="-1"></a>                             <span class="at">arrow =</span> arrow,</span>
<span id="cb7-1913"><a href="#cb7-1913" aria-hidden="true" tabindex="-1"></a>                             <span class="at">force =</span> force,</span>
<span id="cb7-1914"><a href="#cb7-1914" aria-hidden="true" tabindex="-1"></a>                             <span class="at">force_pull =</span> force_pull,</span>
<span id="cb7-1915"><a href="#cb7-1915" aria-hidden="true" tabindex="-1"></a>                             <span class="at">max.time =</span> max.time,</span>
<span id="cb7-1916"><a href="#cb7-1916" aria-hidden="true" tabindex="-1"></a>                             <span class="at">max.iter =</span> max.iter,</span>
<span id="cb7-1917"><a href="#cb7-1917" aria-hidden="true" tabindex="-1"></a>                             <span class="at">max.overlaps =</span> max.overlaps,</span>
<span id="cb7-1918"><a href="#cb7-1918" aria-hidden="true" tabindex="-1"></a>                             <span class="at">direction =</span> direction,</span>
<span id="cb7-1919"><a href="#cb7-1919" aria-hidden="true" tabindex="-1"></a>                             <span class="at">seed =</span> seed,</span>
<span id="cb7-1920"><a href="#cb7-1920" aria-hidden="true" tabindex="-1"></a>                             <span class="at">verbose =</span> verbose,</span>
<span id="cb7-1921"><a href="#cb7-1921" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cl =</span> <span class="st">"textrepeltree"</span></span>
<span id="cb7-1922"><a href="#cb7-1922" aria-hidden="true" tabindex="-1"></a>                           ))</span>
<span id="cb7-1923"><a href="#cb7-1923" aria-hidden="true" tabindex="-1"></a>                         },</span>
<span id="cb7-1924"><a href="#cb7-1924" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-1925"><a href="#cb7-1925" aria-hidden="true" tabindex="-1"></a>    <span class="at">draw_key =</span> draw_key_text</span>
<span id="cb7-1926"><a href="#cb7-1926" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-1927"><a href="#cb7-1927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-1928"><a href="#cb7-1928" aria-hidden="true" tabindex="-1"></a><span class="co">#' grid::makeContent function for the grobTree of textRepelGrob objects</span></span>
<span id="cb7-1929"><a href="#cb7-1929" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A grid grobTree.</span></span>
<span id="cb7-1930"><a href="#cb7-1930" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-1931"><a href="#cb7-1931" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-1932"><a href="#cb7-1932" aria-hidden="true" tabindex="-1"></a>makeContent.textrepeltree <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb7-1933"><a href="#cb7-1933" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1934"><a href="#cb7-1934" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each bounding box.</span></span>
<span id="cb7-1935"><a href="#cb7-1935" aria-hidden="true" tabindex="-1"></a>  box_padding_x <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(x<span class="sc">$</span>box.padding, <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1936"><a href="#cb7-1936" aria-hidden="true" tabindex="-1"></a>  box_padding_y <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(x<span class="sc">$</span>box.padding, <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-1937"><a href="#cb7-1937" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1938"><a href="#cb7-1938" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The padding around each point.</span></span>
<span id="cb7-1939"><a href="#cb7-1939" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(x<span class="sc">$</span>point.padding)) {</span>
<span id="cb7-1940"><a href="#cb7-1940" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>point.padding <span class="ot">=</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>)</span>
<span id="cb7-1941"><a href="#cb7-1941" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1942"><a href="#cb7-1942" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1943"><a href="#cb7-1943" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Do not create text labels for empty strings.</span></span>
<span id="cb7-1944"><a href="#cb7-1944" aria-hidden="true" tabindex="-1"></a>  valid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">not_empty</span>(x<span class="sc">$</span>lab))</span>
<span id="cb7-1945"><a href="#cb7-1945" aria-hidden="true" tabindex="-1"></a>  invalid_strings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">not_empty</span>(x<span class="sc">$</span>lab))</span>
<span id="cb7-1946"><a href="#cb7-1946" aria-hidden="true" tabindex="-1"></a>  ix <span class="ot">&lt;-</span> <span class="fu">c</span>(valid_strings, invalid_strings)</span>
<span id="cb7-1947"><a href="#cb7-1947" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data <span class="ot">&lt;-</span> x<span class="sc">$</span>data[ix,]</span>
<span id="cb7-1948"><a href="#cb7-1948" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>lab <span class="ot">&lt;-</span> x<span class="sc">$</span>lab[ix]</span>
<span id="cb7-1949"><a href="#cb7-1949" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1950"><a href="#cb7-1950" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a dataframe with x1 y1 x2 y2</span></span>
<span id="cb7-1951"><a href="#cb7-1951" aria-hidden="true" tabindex="-1"></a>  boxes <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-1952"><a href="#cb7-1952" aria-hidden="true" tabindex="-1"></a>    row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-1953"><a href="#cb7-1953" aria-hidden="true" tabindex="-1"></a>    tg <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(</span>
<span id="cb7-1954"><a href="#cb7-1954" aria-hidden="true" tabindex="-1"></a>      x<span class="sc">$</span>lab[i],</span>
<span id="cb7-1955"><a href="#cb7-1955" aria-hidden="true" tabindex="-1"></a>      row<span class="sc">$</span>x, row<span class="sc">$</span>y, <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-1956"><a href="#cb7-1956" aria-hidden="true" tabindex="-1"></a>      <span class="at">rot =</span> row<span class="sc">$</span>angle,</span>
<span id="cb7-1957"><a href="#cb7-1957" aria-hidden="true" tabindex="-1"></a>      <span class="at">hjust =</span> row<span class="sc">$</span>hjust,</span>
<span id="cb7-1958"><a href="#cb7-1958" aria-hidden="true" tabindex="-1"></a>      <span class="at">vjust =</span> row<span class="sc">$</span>vjust,</span>
<span id="cb7-1959"><a href="#cb7-1959" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-1960"><a href="#cb7-1960" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontsize   =</span> row<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-1961"><a href="#cb7-1961" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontfamily =</span> row<span class="sc">$</span>family,</span>
<span id="cb7-1962"><a href="#cb7-1962" aria-hidden="true" tabindex="-1"></a>        <span class="at">fontface   =</span> row<span class="sc">$</span>fontface,</span>
<span id="cb7-1963"><a href="#cb7-1963" aria-hidden="true" tabindex="-1"></a>        <span class="at">lineheight =</span> row<span class="sc">$</span>lineheight</span>
<span id="cb7-1964"><a href="#cb7-1964" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-1965"><a href="#cb7-1965" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1966"><a href="#cb7-1966" aria-hidden="true" tabindex="-1"></a>    x1 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">grobX</span>(tg, <span class="st">"west"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1967"><a href="#cb7-1967" aria-hidden="true" tabindex="-1"></a>    x2 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">grobX</span>(tg, <span class="st">"east"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1968"><a href="#cb7-1968" aria-hidden="true" tabindex="-1"></a>    y1 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobY</span>(tg, <span class="st">"south"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1969"><a href="#cb7-1969" aria-hidden="true" tabindex="-1"></a>    y2 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobY</span>(tg, <span class="st">"north"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1970"><a href="#cb7-1970" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(</span>
<span id="cb7-1971"><a href="#cb7-1971" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x1"</span> <span class="ot">=</span> x1 <span class="sc">-</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-1972"><a href="#cb7-1972" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y1"</span> <span class="ot">=</span> y1 <span class="sc">-</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y,</span>
<span id="cb7-1973"><a href="#cb7-1973" aria-hidden="true" tabindex="-1"></a>      <span class="st">"x2"</span> <span class="ot">=</span> x2 <span class="sc">+</span> box_padding_x <span class="sc">+</span> row<span class="sc">$</span>nudge_x,</span>
<span id="cb7-1974"><a href="#cb7-1974" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y2"</span> <span class="ot">=</span> y2 <span class="sc">+</span> box_padding_y <span class="sc">+</span> row<span class="sc">$</span>nudge_y</span>
<span id="cb7-1975"><a href="#cb7-1975" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-1976"><a href="#cb7-1976" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-1977"><a href="#cb7-1977" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1978"><a href="#cb7-1978" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the repulsion reproducible if desired.</span></span>
<span id="cb7-1979"><a href="#cb7-1979" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>seed) <span class="sc">&amp;&amp;</span> <span class="fu">is.na</span>(x<span class="sc">$</span>seed)) {</span>
<span id="cb7-1980"><a href="#cb7-1980" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">$</span>seed <span class="ot">&lt;-</span> <span class="fu">sample.int</span>(.Machine<span class="sc">$</span>integer.max, <span class="dv">1</span>L)</span>
<span id="cb7-1981"><a href="#cb7-1981" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1982"><a href="#cb7-1982" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1983"><a href="#cb7-1983" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The points are represented by circles.</span></span>
<span id="cb7-1984"><a href="#cb7-1984" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>data<span class="sc">$</span>point.size[<span class="fu">is.na</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-1985"><a href="#cb7-1985" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-1986"><a href="#cb7-1986" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Beware the magic numbers. I do not understand them.</span></span>
<span id="cb7-1987"><a href="#cb7-1987" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I just accept them as necessary to get the code to work.</span></span>
<span id="cb7-1988"><a href="#cb7-1988" aria-hidden="true" tabindex="-1"></a>  p_width <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1989"><a href="#cb7-1989" aria-hidden="true" tabindex="-1"></a>  p_height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"npc"</span>), <span class="st">"inch"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-1990"><a href="#cb7-1990" aria-hidden="true" tabindex="-1"></a>  p_ratio <span class="ot">&lt;-</span> (p_width <span class="sc">/</span> p_height)</span>
<span id="cb7-1991"><a href="#cb7-1991" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (p_ratio <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb7-1992"><a href="#cb7-1992" aria-hidden="true" tabindex="-1"></a>    p_ratio <span class="ot">&lt;-</span> p_ratio <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> (<span class="fl">1.15</span> <span class="sc">*</span> p_ratio))</span>
<span id="cb7-1993"><a href="#cb7-1993" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-1994"><a href="#cb7-1994" aria-hidden="true" tabindex="-1"></a>  point_size <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-1995"><a href="#cb7-1995" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>data<span class="sc">$</span>point.size), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-1996"><a href="#cb7-1996" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-1997"><a href="#cb7-1997" aria-hidden="true" tabindex="-1"></a>  point_padding <span class="ot">&lt;-</span> p_ratio <span class="sc">*</span> <span class="fu">convertWidth</span>(</span>
<span id="cb7-1998"><a href="#cb7-1998" aria-hidden="true" tabindex="-1"></a>    <span class="fu">to_unit</span>(x<span class="sc">$</span>point.padding), <span class="st">"native"</span>, <span class="at">valueOnly =</span> <span class="cn">TRUE</span></span>
<span id="cb7-1999"><a href="#cb7-1999" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">/</span> <span class="dv">13</span></span>
<span id="cb7-2000"><a href="#cb7-2000" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2001"><a href="#cb7-2001" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Repel overlapping bounding boxes away from each other.</span></span>
<span id="cb7-2002"><a href="#cb7-2002" aria-hidden="true" tabindex="-1"></a>  repel <span class="ot">&lt;-</span> <span class="fu">with_seed_null</span>(x<span class="sc">$</span>seed, <span class="fu">repel_boxes2</span>(</span>
<span id="cb7-2003"><a href="#cb7-2003" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_points     =</span> <span class="fu">as.matrix</span>(x<span class="sc">$</span>data[,<span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"y"</span>)]),</span>
<span id="cb7-2004"><a href="#cb7-2004" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_size      =</span> point_size,</span>
<span id="cb7-2005"><a href="#cb7-2005" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_x =</span> point_padding,</span>
<span id="cb7-2006"><a href="#cb7-2006" aria-hidden="true" tabindex="-1"></a>    <span class="at">point_padding_y =</span> point_padding,</span>
<span id="cb7-2007"><a href="#cb7-2007" aria-hidden="true" tabindex="-1"></a>    <span class="at">boxes           =</span> <span class="fu">do.call</span>(rbind, boxes),</span>
<span id="cb7-2008"><a href="#cb7-2008" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>x),</span>
<span id="cb7-2009"><a href="#cb7-2009" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylim            =</span> <span class="fu">range</span>(x<span class="sc">$</span>limits<span class="sc">$</span>y),</span>
<span id="cb7-2010"><a href="#cb7-2010" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>hjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2011"><a href="#cb7-2011" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust           =</span> x<span class="sc">$</span>data<span class="sc">$</span>vjust <span class="sc">%||%</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2012"><a href="#cb7-2012" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_push      =</span> x<span class="sc">$</span>force <span class="sc">*</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-2013"><a href="#cb7-2013" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull      =</span> x<span class="sc">$</span>force_pull <span class="sc">*</span> <span class="fl">1e-2</span>,</span>
<span id="cb7-2014"><a href="#cb7-2014" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_time        =</span> x<span class="sc">$</span>max.time,</span>
<span id="cb7-2015"><a href="#cb7-2015" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter        =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(x<span class="sc">$</span>max.iter), <span class="fl">1e9</span>, x<span class="sc">$</span>max.iter),</span>
<span id="cb7-2016"><a href="#cb7-2016" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_overlaps    =</span> x<span class="sc">$</span>max.overlaps,</span>
<span id="cb7-2017"><a href="#cb7-2017" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction       =</span> x<span class="sc">$</span>direction,</span>
<span id="cb7-2018"><a href="#cb7-2018" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose         =</span> x<span class="sc">$</span>verbose</span>
<span id="cb7-2019"><a href="#cb7-2019" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb7-2020"><a href="#cb7-2020" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2021"><a href="#cb7-2021" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x<span class="sc">$</span>verbose <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-2022"><a href="#cb7-2022" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb7-2023"><a href="#cb7-2023" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(</span>
<span id="cb7-2024"><a href="#cb7-2024" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ggrepel: %s unlabeled data points (too many overlaps). Consider increasing 'max.overlaps'"</span>,</span>
<span id="cb7-2025"><a href="#cb7-2025" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(repel<span class="sc">$</span>too_many_overlaps)</span>
<span id="cb7-2026"><a href="#cb7-2026" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-2027"><a href="#cb7-2027" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-2028"><a href="#cb7-2028" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2029"><a href="#cb7-2029" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2030"><a href="#cb7-2030" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(repel<span class="sc">$</span>too_many_overlaps)) {</span>
<span id="cb7-2031"><a href="#cb7-2031" aria-hidden="true" tabindex="-1"></a>    grobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-2032"><a href="#cb7-2032" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-2033"><a href="#cb7-2033" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">setChildren</span>(x, grobs))</span>
<span id="cb7-2034"><a href="#cb7-2034" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2035"><a href="#cb7-2035" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2036"><a href="#cb7-2036" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(valid_strings), <span class="cf">function</span>(i) {</span>
<span id="cb7-2037"><a href="#cb7-2037" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>repel<span class="sc">$</span>too_many_overlaps[i]) {</span>
<span id="cb7-2038"><a href="#cb7-2038" aria-hidden="true" tabindex="-1"></a>      row <span class="ot">&lt;-</span> x<span class="sc">$</span>data[i, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb7-2039"><a href="#cb7-2039" aria-hidden="true" tabindex="-1"></a>      <span class="fu">makeTextRepelGrobs</span>(</span>
<span id="cb7-2040"><a href="#cb7-2040" aria-hidden="true" tabindex="-1"></a>        i,</span>
<span id="cb7-2041"><a href="#cb7-2041" aria-hidden="true" tabindex="-1"></a>        x<span class="sc">$</span>lab[i],</span>
<span id="cb7-2042"><a href="#cb7-2042" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of text bounding boxes.</span></span>
<span id="cb7-2043"><a href="#cb7-2043" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>x[i], <span class="st">"native"</span>),</span>
<span id="cb7-2044"><a href="#cb7-2044" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">unit</span>(repel<span class="sc">$</span>y[i], <span class="st">"native"</span>),</span>
<span id="cb7-2045"><a href="#cb7-2045" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Position of original data points.</span></span>
<span id="cb7-2046"><a href="#cb7-2046" aria-hidden="true" tabindex="-1"></a>        <span class="at">x.orig =</span> row<span class="sc">$</span>x,</span>
<span id="cb7-2047"><a href="#cb7-2047" aria-hidden="true" tabindex="-1"></a>        <span class="at">y.orig =</span> row<span class="sc">$</span>y,</span>
<span id="cb7-2048"><a href="#cb7-2048" aria-hidden="true" tabindex="-1"></a>        <span class="at">rot =</span> row<span class="sc">$</span>angle,</span>
<span id="cb7-2049"><a href="#cb7-2049" aria-hidden="true" tabindex="-1"></a>        <span class="at">box.padding =</span> x<span class="sc">$</span>box.padding,</span>
<span id="cb7-2050"><a href="#cb7-2050" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.size =</span> point_size[i],</span>
<span id="cb7-2051"><a href="#cb7-2051" aria-hidden="true" tabindex="-1"></a>        <span class="at">point.padding =</span> x<span class="sc">$</span>point.padding,</span>
<span id="cb7-2052"><a href="#cb7-2052" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.curvature =</span> row<span class="sc">$</span>segment.curvature,</span>
<span id="cb7-2053"><a href="#cb7-2053" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.angle     =</span> row<span class="sc">$</span>segment.angle,</span>
<span id="cb7-2054"><a href="#cb7-2054" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.ncp       =</span> row<span class="sc">$</span>segment.ncp,</span>
<span id="cb7-2055"><a href="#cb7-2055" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.shape =</span> row<span class="sc">$</span>segment.shape,</span>
<span id="cb7-2056"><a href="#cb7-2056" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.square =</span> row<span class="sc">$</span>segment.square,</span>
<span id="cb7-2057"><a href="#cb7-2057" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.squareShape =</span> row<span class="sc">$</span>segment.squareShape,</span>
<span id="cb7-2058"><a href="#cb7-2058" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.inflect =</span> row<span class="sc">$</span>segment.inflect,</span>
<span id="cb7-2059"><a href="#cb7-2059" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.debug =</span> row<span class="sc">$</span>segment.debug,</span>
<span id="cb7-2060"><a href="#cb7-2060" aria-hidden="true" tabindex="-1"></a>        <span class="at">text.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-2061"><a href="#cb7-2061" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>colour, row<span class="sc">$</span>alpha),</span>
<span id="cb7-2062"><a href="#cb7-2062" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontsize =</span> row<span class="sc">$</span>size <span class="sc">*</span> .pt,</span>
<span id="cb7-2063"><a href="#cb7-2063" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontfamily =</span> row<span class="sc">$</span>family,</span>
<span id="cb7-2064"><a href="#cb7-2064" aria-hidden="true" tabindex="-1"></a>          <span class="at">fontface =</span> row<span class="sc">$</span>fontface,</span>
<span id="cb7-2065"><a href="#cb7-2065" aria-hidden="true" tabindex="-1"></a>          <span class="at">lineheight =</span> row<span class="sc">$</span>lineheight</span>
<span id="cb7-2066"><a href="#cb7-2066" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-2067"><a href="#cb7-2067" aria-hidden="true" tabindex="-1"></a>        <span class="at">segment.gp =</span> <span class="fu">gpar</span>(</span>
<span id="cb7-2068"><a href="#cb7-2068" aria-hidden="true" tabindex="-1"></a>          <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(row<span class="sc">$</span>segment.colour <span class="sc">%||%</span> row<span class="sc">$</span>colour, row<span class="sc">$</span>segment.alpha <span class="sc">%||%</span> row<span class="sc">$</span>alpha),</span>
<span id="cb7-2069"><a href="#cb7-2069" aria-hidden="true" tabindex="-1"></a>          <span class="at">lwd =</span> row<span class="sc">$</span>segment.size <span class="sc">*</span> .pt,</span>
<span id="cb7-2070"><a href="#cb7-2070" aria-hidden="true" tabindex="-1"></a>          <span class="at">lty =</span> row<span class="sc">$</span>segment.linetype <span class="sc">%||%</span> <span class="dv">1</span></span>
<span id="cb7-2071"><a href="#cb7-2071" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-2072"><a href="#cb7-2072" aria-hidden="true" tabindex="-1"></a>        <span class="at">arrow =</span> x<span class="sc">$</span>arrow,</span>
<span id="cb7-2073"><a href="#cb7-2073" aria-hidden="true" tabindex="-1"></a>        <span class="at">min.segment.length =</span> x<span class="sc">$</span>min.segment.length,</span>
<span id="cb7-2074"><a href="#cb7-2074" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> row<span class="sc">$</span>hjust,</span>
<span id="cb7-2075"><a href="#cb7-2075" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> row<span class="sc">$</span>vjust,</span>
<span id="cb7-2076"><a href="#cb7-2076" aria-hidden="true" tabindex="-1"></a>        <span class="at">bg.colour =</span> <span class="fu">alpha</span>(row<span class="sc">$</span>bg.colour, row<span class="sc">$</span>alpha),</span>
<span id="cb7-2077"><a href="#cb7-2077" aria-hidden="true" tabindex="-1"></a>        <span class="at">bg.r =</span> row<span class="sc">$</span>bg.r</span>
<span id="cb7-2078"><a href="#cb7-2078" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-2079"><a href="#cb7-2079" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-2080"><a href="#cb7-2080" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb7-2081"><a href="#cb7-2081" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2082"><a href="#cb7-2082" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">unlist</span>(grobs, <span class="at">recursive =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-2083"><a href="#cb7-2083" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(grobs) <span class="ot">&lt;-</span> <span class="st">"gList"</span></span>
<span id="cb7-2084"><a href="#cb7-2084" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2085"><a href="#cb7-2085" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Put segment grobs before text grobs.</span></span>
<span id="cb7-2086"><a href="#cb7-2086" aria-hidden="true" tabindex="-1"></a>  grob_names <span class="ot">&lt;-</span> <span class="fu">sapply</span>(grobs, <span class="st">"[["</span>, <span class="st">"name"</span>)</span>
<span id="cb7-2087"><a href="#cb7-2087" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> grobs[<span class="fu">order</span>(<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"^segment"</span>, grob_names))]</span>
<span id="cb7-2088"><a href="#cb7-2088" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2089"><a href="#cb7-2089" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setChildren</span>(x, grobs)</span>
<span id="cb7-2090"><a href="#cb7-2090" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2091"><a href="#cb7-2091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2092"><a href="#cb7-2092" aria-hidden="true" tabindex="-1"></a>makeTextRepelGrobs <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-2093"><a href="#cb7-2093" aria-hidden="true" tabindex="-1"></a>    i,</span>
<span id="cb7-2094"><a href="#cb7-2094" aria-hidden="true" tabindex="-1"></a>    label,</span>
<span id="cb7-2095"><a href="#cb7-2095" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position of text bounding boxes.</span></span>
<span id="cb7-2096"><a href="#cb7-2096" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-2097"><a href="#cb7-2097" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-2098"><a href="#cb7-2098" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Position of original data points.</span></span>
<span id="cb7-2099"><a href="#cb7-2099" aria-hidden="true" tabindex="-1"></a>    <span class="at">x.orig =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2100"><a href="#cb7-2100" aria-hidden="true" tabindex="-1"></a>    <span class="at">y.orig =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2101"><a href="#cb7-2101" aria-hidden="true" tabindex="-1"></a>    <span class="at">rot =</span> <span class="dv">0</span>,</span>
<span id="cb7-2102"><a href="#cb7-2102" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"npc"</span>,</span>
<span id="cb7-2103"><a href="#cb7-2103" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.25</span>,</span>
<span id="cb7-2104"><a href="#cb7-2104" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.size =</span> <span class="dv">1</span>,</span>
<span id="cb7-2105"><a href="#cb7-2105" aria-hidden="true" tabindex="-1"></a>    <span class="at">point.padding =</span> <span class="fl">1e-6</span>,</span>
<span id="cb7-2106"><a href="#cb7-2106" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.curvature =</span> <span class="dv">0</span>,</span>
<span id="cb7-2107"><a href="#cb7-2107" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.angle =</span> <span class="dv">90</span>,</span>
<span id="cb7-2108"><a href="#cb7-2108" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.ncp =</span> <span class="dv">1</span>,</span>
<span id="cb7-2109"><a href="#cb7-2109" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.shape =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2110"><a href="#cb7-2110" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.square =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-2111"><a href="#cb7-2111" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.squareShape =</span> <span class="dv">1</span>,</span>
<span id="cb7-2112"><a href="#cb7-2112" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.inflect =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-2113"><a href="#cb7-2113" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.debug =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-2114"><a href="#cb7-2114" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2115"><a href="#cb7-2115" aria-hidden="true" tabindex="-1"></a>    <span class="at">text.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-2116"><a href="#cb7-2116" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.gp =</span> <span class="fu">gpar</span>(),</span>
<span id="cb7-2117"><a href="#cb7-2117" aria-hidden="true" tabindex="-1"></a>    <span class="at">vp =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2118"><a href="#cb7-2118" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrow =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2119"><a href="#cb7-2119" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2120"><a href="#cb7-2120" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2121"><a href="#cb7-2121" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb7-2122"><a href="#cb7-2122" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg.colour =</span> <span class="cn">NA</span>,</span>
<span id="cb7-2123"><a href="#cb7-2123" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg.r =</span> .<span class="dv">1</span></span>
<span id="cb7-2124"><a href="#cb7-2124" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-2125"><a href="#cb7-2125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">length</span>(label) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb7-2126"><a href="#cb7-2126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2127"><a href="#cb7-2127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(x))</span>
<span id="cb7-2128"><a href="#cb7-2128" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">unit</span>(x, default.units)</span>
<span id="cb7-2129"><a href="#cb7-2129" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(y))</span>
<span id="cb7-2130"><a href="#cb7-2130" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">unit</span>(y, default.units)</span>
<span id="cb7-2131"><a href="#cb7-2131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2132"><a href="#cb7-2132" aria-hidden="true" tabindex="-1"></a>  <span class="co"># support any angle by converting to -360..360</span></span>
<span id="cb7-2133"><a href="#cb7-2133" aria-hidden="true" tabindex="-1"></a>  rot <span class="ot">&lt;-</span> rot <span class="sc">%%</span> <span class="dv">360</span></span>
<span id="cb7-2134"><a href="#cb7-2134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2135"><a href="#cb7-2135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Instead of the width and height of the Grob we use the dimensions of the</span></span>
<span id="cb7-2136"><a href="#cb7-2136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># character string which are independent of rotation, matching those of</span></span>
<span id="cb7-2137"><a href="#cb7-2137" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a textGrob built with rot = 0.</span></span>
<span id="cb7-2138"><a href="#cb7-2138" aria-hidden="true" tabindex="-1"></a>  <span class="co"># To support rotation height and width need to be expressed in units that</span></span>
<span id="cb7-2139"><a href="#cb7-2139" aria-hidden="true" tabindex="-1"></a>  <span class="co"># are consistent on x and y axes, such as "char".</span></span>
<span id="cb7-2140"><a href="#cb7-2140" aria-hidden="true" tabindex="-1"></a>  string.height <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">stringHeight</span>(label), <span class="st">"char"</span>)</span>
<span id="cb7-2141"><a href="#cb7-2141" aria-hidden="true" tabindex="-1"></a>  string.width <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">stringWidth</span>(label), <span class="st">"char"</span>)</span>
<span id="cb7-2142"><a href="#cb7-2142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2143"><a href="#cb7-2143" aria-hidden="true" tabindex="-1"></a>  rot_radians <span class="ot">&lt;-</span> rot <span class="sc">*</span> pi <span class="sc">/</span> <span class="dv">180</span></span>
<span id="cb7-2144"><a href="#cb7-2144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2145"><a href="#cb7-2145" aria-hidden="true" tabindex="-1"></a>  x_adj <span class="ot">&lt;-</span> x <span class="sc">-</span> <span class="fu">cos</span>(rot_radians) <span class="sc">*</span> string.width <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> hjust) <span class="sc">+</span></span>
<span id="cb7-2146"><a href="#cb7-2146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sin</span>(rot_radians) <span class="sc">*</span> string.height <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> vjust)</span>
<span id="cb7-2147"><a href="#cb7-2147" aria-hidden="true" tabindex="-1"></a>  y_adj <span class="ot">&lt;-</span> y <span class="sc">-</span> <span class="fu">cos</span>(rot_radians) <span class="sc">*</span> string.height <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> vjust) <span class="sc">-</span></span>
<span id="cb7-2148"><a href="#cb7-2148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sin</span>(rot_radians) <span class="sc">*</span> string.width <span class="sc">*</span> (<span class="fl">0.5</span> <span class="sc">-</span> hjust)</span>
<span id="cb7-2149"><a href="#cb7-2149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2150"><a href="#cb7-2150" aria-hidden="true" tabindex="-1"></a>  grobs <span class="ot">&lt;-</span> <span class="fu">shadowtextGrob</span>(</span>
<span id="cb7-2151"><a href="#cb7-2151" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> label,</span>
<span id="cb7-2152"><a href="#cb7-2152" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x_adj,</span>
<span id="cb7-2153"><a href="#cb7-2153" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y_adj,</span>
<span id="cb7-2154"><a href="#cb7-2154" aria-hidden="true" tabindex="-1"></a>    <span class="at">rot =</span> rot,</span>
<span id="cb7-2155"><a href="#cb7-2155" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-2156"><a href="#cb7-2156" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> hjust,</span>
<span id="cb7-2157"><a href="#cb7-2157" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> vjust,</span>
<span id="cb7-2158"><a href="#cb7-2158" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp =</span> text.gp,</span>
<span id="cb7-2159"><a href="#cb7-2159" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"textrepelgrob%s"</span>, i),</span>
<span id="cb7-2160"><a href="#cb7-2160" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg.colour =</span> bg.colour,</span>
<span id="cb7-2161"><a href="#cb7-2161" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg.r =</span> bg.r</span>
<span id="cb7-2162"><a href="#cb7-2162" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-2163"><a href="#cb7-2163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the regular textgrob will always be the last one</span></span>
<span id="cb7-2164"><a href="#cb7-2164" aria-hidden="true" tabindex="-1"></a>  tg <span class="ot">&lt;-</span> grobs[[<span class="fu">length</span>(grobs)]]</span>
<span id="cb7-2165"><a href="#cb7-2165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2166"><a href="#cb7-2166" aria-hidden="true" tabindex="-1"></a>  x1 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">grobX</span>(tg, <span class="st">"west"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2167"><a href="#cb7-2167" aria-hidden="true" tabindex="-1"></a>  x2 <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">grobX</span>(tg, <span class="st">"east"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2168"><a href="#cb7-2168" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobY</span>(tg, <span class="st">"south"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2169"><a href="#cb7-2169" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">grobY</span>(tg, <span class="st">"north"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2170"><a href="#cb7-2170" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2171"><a href="#cb7-2171" aria-hidden="true" tabindex="-1"></a>  point_pos <span class="ot">&lt;-</span> <span class="fu">c</span>(x.orig, y.orig)</span>
<span id="cb7-2172"><a href="#cb7-2172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2173"><a href="#cb7-2173" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get the coordinates of the intersection between the line from the</span></span>
<span id="cb7-2174"><a href="#cb7-2174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># original data point to the centroid and the rectangle's edges.</span></span>
<span id="cb7-2175"><a href="#cb7-2175" aria-hidden="true" tabindex="-1"></a>  extra_padding_x <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">"lines"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-2176"><a href="#cb7-2176" aria-hidden="true" tabindex="-1"></a>  extra_padding_y <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(<span class="fu">unit</span>(<span class="fl">0.25</span>, <span class="st">"lines"</span>), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-2177"><a href="#cb7-2177" aria-hidden="true" tabindex="-1"></a>  text_box <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-2178"><a href="#cb7-2178" aria-hidden="true" tabindex="-1"></a>    x1 <span class="sc">-</span> extra_padding_x, y1 <span class="sc">-</span> extra_padding_y,</span>
<span id="cb7-2179"><a href="#cb7-2179" aria-hidden="true" tabindex="-1"></a>    x2 <span class="sc">+</span> extra_padding_x, y2 <span class="sc">+</span> extra_padding_y</span>
<span id="cb7-2180"><a href="#cb7-2180" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-2181"><a href="#cb7-2181" aria-hidden="true" tabindex="-1"></a>  <span class="co">#int &lt;- intersect_line_rectangle(point_pos, center, text_box)</span></span>
<span id="cb7-2182"><a href="#cb7-2182" aria-hidden="true" tabindex="-1"></a>  int <span class="ot">&lt;-</span> <span class="fu">select_line_connection</span>(point_pos, text_box)</span>
<span id="cb7-2183"><a href="#cb7-2183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2184"><a href="#cb7-2184" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the data point is inside the label box.</span></span>
<span id="cb7-2185"><a href="#cb7-2185" aria-hidden="true" tabindex="-1"></a>  point_inside_text <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb7-2186"><a href="#cb7-2186" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (text_box[<span class="dv">1</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">1</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">1</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">3</span>] <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2187"><a href="#cb7-2187" aria-hidden="true" tabindex="-1"></a>      text_box[<span class="dv">2</span>] <span class="sc">&lt;=</span> point_pos[<span class="dv">2</span>] <span class="sc">&amp;&amp;</span> point_pos[<span class="dv">2</span>] <span class="sc">&lt;=</span> text_box[<span class="dv">4</span>]) {</span>
<span id="cb7-2188"><a href="#cb7-2188" aria-hidden="true" tabindex="-1"></a>    point_inside_text <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb7-2189"><a href="#cb7-2189" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2190"><a href="#cb7-2190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2191"><a href="#cb7-2191" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This seems just fine.</span></span>
<span id="cb7-2192"><a href="#cb7-2192" aria-hidden="true" tabindex="-1"></a>  point.padding <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(<span class="fu">to_unit</span>(point.padding), <span class="st">"native"</span>, <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb7-2193"><a href="#cb7-2193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2194"><a href="#cb7-2194" aria-hidden="true" tabindex="-1"></a>  point_int <span class="ot">&lt;-</span> <span class="fu">intersect_line_circle</span>(int, point_pos, (point.size <span class="sc">+</span> point.padding))</span>
<span id="cb7-2195"><a href="#cb7-2195" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2196"><a href="#cb7-2196" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute the distance between the data point and the edge of the text box.</span></span>
<span id="cb7-2197"><a href="#cb7-2197" aria-hidden="true" tabindex="-1"></a>  dx <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">1</span>] <span class="sc">-</span> point_int[<span class="dv">1</span>])</span>
<span id="cb7-2198"><a href="#cb7-2198" aria-hidden="true" tabindex="-1"></a>  dy <span class="ot">&lt;-</span> <span class="fu">abs</span>(int[<span class="dv">2</span>] <span class="sc">-</span> point_int[<span class="dv">2</span>])</span>
<span id="cb7-2199"><a href="#cb7-2199" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(dx <span class="sc">*</span> dx <span class="sc">+</span> dy <span class="sc">*</span> dy)</span>
<span id="cb7-2200"><a href="#cb7-2200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2201"><a href="#cb7-2201" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Scale the unit vector by the minimum segment length.</span></span>
<span id="cb7-2202"><a href="#cb7-2202" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (d <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb7-2203"><a href="#cb7-2203" aria-hidden="true" tabindex="-1"></a>    mx <span class="ot">&lt;-</span> <span class="fu">convertWidth</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2204"><a href="#cb7-2204" aria-hidden="true" tabindex="-1"></a>    my <span class="ot">&lt;-</span> <span class="fu">convertHeight</span>(min.segment.length, <span class="st">"native"</span>, <span class="cn">TRUE</span>)</span>
<span id="cb7-2205"><a href="#cb7-2205" aria-hidden="true" tabindex="-1"></a>    min.segment.length <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((mx <span class="sc">*</span> dx <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (my <span class="sc">*</span> dy <span class="sc">/</span> d) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb7-2206"><a href="#cb7-2206" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2207"><a href="#cb7-2207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2208"><a href="#cb7-2208" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (</span>
<span id="cb7-2209"><a href="#cb7-2209" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>point_inside_text <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2210"><a href="#cb7-2210" aria-hidden="true" tabindex="-1"></a>    d <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2211"><a href="#cb7-2211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is greater than minimum.</span></span>
<span id="cb7-2212"><a href="#cb7-2212" aria-hidden="true" tabindex="-1"></a>    (<span class="sc">!</span><span class="fu">is.na</span>(min.segment.length) <span class="sc">&amp;&amp;</span> <span class="fu">euclid</span>(int, point_int) <span class="sc">&gt;</span> min.segment.length) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2213"><a href="#cb7-2213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point edge is less than from label to point center.</span></span>
<span id="cb7-2214"><a href="#cb7-2214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_int) <span class="sc">&lt;</span> <span class="fu">euclid</span>(int, point_pos) <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2215"><a href="#cb7-2215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than point size.</span></span>
<span id="cb7-2216"><a href="#cb7-2216" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> point.size <span class="sc">&amp;&amp;</span></span>
<span id="cb7-2217"><a href="#cb7-2217" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Distance from label to point center is greater than from point edge to point center.</span></span>
<span id="cb7-2218"><a href="#cb7-2218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">euclid</span>(int, point_pos) <span class="sc">&gt;</span> <span class="fu">euclid</span>(point_int, point_pos)</span>
<span id="cb7-2219"><a href="#cb7-2219" aria-hidden="true" tabindex="-1"></a>  ) {</span>
<span id="cb7-2220"><a href="#cb7-2220" aria-hidden="true" tabindex="-1"></a>    s <span class="ot">&lt;-</span> <span class="fu">curveGrob</span>(</span>
<span id="cb7-2221"><a href="#cb7-2221" aria-hidden="true" tabindex="-1"></a>      <span class="at">x1 =</span> int[<span class="dv">1</span>],</span>
<span id="cb7-2222"><a href="#cb7-2222" aria-hidden="true" tabindex="-1"></a>      <span class="at">y1 =</span> int[<span class="dv">2</span>],</span>
<span id="cb7-2223"><a href="#cb7-2223" aria-hidden="true" tabindex="-1"></a>      <span class="at">x2 =</span> point_int[<span class="dv">1</span>],</span>
<span id="cb7-2224"><a href="#cb7-2224" aria-hidden="true" tabindex="-1"></a>      <span class="at">y2 =</span> point_int[<span class="dv">2</span>],</span>
<span id="cb7-2225"><a href="#cb7-2225" aria-hidden="true" tabindex="-1"></a>      <span class="at">default.units =</span> <span class="st">"native"</span>,</span>
<span id="cb7-2226"><a href="#cb7-2226" aria-hidden="true" tabindex="-1"></a>      <span class="at">curvature =</span> segment.curvature,</span>
<span id="cb7-2227"><a href="#cb7-2227" aria-hidden="true" tabindex="-1"></a>      <span class="at">angle =</span> segment.angle,</span>
<span id="cb7-2228"><a href="#cb7-2228" aria-hidden="true" tabindex="-1"></a>      <span class="at">ncp =</span> segment.ncp,</span>
<span id="cb7-2229"><a href="#cb7-2229" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape =</span> segment.shape,</span>
<span id="cb7-2230"><a href="#cb7-2230" aria-hidden="true" tabindex="-1"></a>      <span class="at">square =</span> segment.square,</span>
<span id="cb7-2231"><a href="#cb7-2231" aria-hidden="true" tabindex="-1"></a>      <span class="at">squareShape =</span> segment.squareShape,</span>
<span id="cb7-2232"><a href="#cb7-2232" aria-hidden="true" tabindex="-1"></a>      <span class="at">inflect =</span> segment.inflect,</span>
<span id="cb7-2233"><a href="#cb7-2233" aria-hidden="true" tabindex="-1"></a>      <span class="at">debug =</span> segment.debug,</span>
<span id="cb7-2234"><a href="#cb7-2234" aria-hidden="true" tabindex="-1"></a>      <span class="at">gp =</span> segment.gp,</span>
<span id="cb7-2235"><a href="#cb7-2235" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="fu">sprintf</span>(<span class="st">"segmentrepelgrob%s"</span>, i),</span>
<span id="cb7-2236"><a href="#cb7-2236" aria-hidden="true" tabindex="-1"></a>      <span class="at">arrow =</span> arrow</span>
<span id="cb7-2237"><a href="#cb7-2237" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-2238"><a href="#cb7-2238" aria-hidden="true" tabindex="-1"></a>    grobs[[s<span class="sc">$</span>name]] <span class="ot">&lt;-</span> s</span>
<span id="cb7-2239"><a href="#cb7-2239" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2240"><a href="#cb7-2240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2241"><a href="#cb7-2241" aria-hidden="true" tabindex="-1"></a>  grobs</span>
<span id="cb7-2242"><a href="#cb7-2242" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2243"><a href="#cb7-2243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2244"><a href="#cb7-2244" aria-hidden="true" tabindex="-1"></a><span class="co"># copied from ggplot2</span></span>
<span id="cb7-2245"><a href="#cb7-2245" aria-hidden="true" tabindex="-1"></a>compute_just <span class="ot">&lt;-</span> <span class="cf">function</span>(just, a, <span class="at">b =</span> a, <span class="at">angle =</span> <span class="dv">0</span>) {</span>
<span id="cb7-2246"><a href="#cb7-2246" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  As justification direction is relative to the text, not the plotting area</span></span>
<span id="cb7-2247"><a href="#cb7-2247" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  we need to swap x and y if text direction is rotated so that hjust is</span></span>
<span id="cb7-2248"><a href="#cb7-2248" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  applied along y and vjust along x.</span></span>
<span id="cb7-2249"><a href="#cb7-2249" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">grepl</span>(<span class="st">"outward|inward"</span>, just))) {</span>
<span id="cb7-2250"><a href="#cb7-2250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure all angles are in -360...+360</span></span>
<span id="cb7-2251"><a href="#cb7-2251" aria-hidden="true" tabindex="-1"></a>    angle <span class="ot">&lt;-</span> angle <span class="sc">%%</span> <span class="dv">360</span></span>
<span id="cb7-2252"><a href="#cb7-2252" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure correct behaviour for angles in -360...+360</span></span>
<span id="cb7-2253"><a href="#cb7-2253" aria-hidden="true" tabindex="-1"></a>    angle <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(angle <span class="sc">&gt;</span> <span class="dv">180</span>, angle <span class="sc">-</span> <span class="dv">360</span>, angle)</span>
<span id="cb7-2254"><a href="#cb7-2254" aria-hidden="true" tabindex="-1"></a>    angle <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(angle <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">180</span>, angle <span class="sc">+</span> <span class="dv">360</span>, angle)</span>
<span id="cb7-2255"><a href="#cb7-2255" aria-hidden="true" tabindex="-1"></a>    rotated_forward <span class="ot">&lt;-</span></span>
<span id="cb7-2256"><a href="#cb7-2256" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"outward|inward"</span>, just) <span class="sc">&amp;</span> (angle <span class="sc">&gt;</span> <span class="dv">45</span> <span class="sc">&amp;</span> angle <span class="sc">&lt;</span> <span class="dv">135</span>)</span>
<span id="cb7-2257"><a href="#cb7-2257" aria-hidden="true" tabindex="-1"></a>    rotated_backwards <span class="ot">&lt;-</span></span>
<span id="cb7-2258"><a href="#cb7-2258" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"outward|inward"</span>, just) <span class="sc">&amp;</span> (angle <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">45</span> <span class="sc">&amp;</span> angle <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">135</span>)</span>
<span id="cb7-2259"><a href="#cb7-2259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2260"><a href="#cb7-2260" aria-hidden="true" tabindex="-1"></a>    ab <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(rotated_forward <span class="sc">|</span> rotated_backwards, b, a)</span>
<span id="cb7-2261"><a href="#cb7-2261" aria-hidden="true" tabindex="-1"></a>    just_swap <span class="ot">&lt;-</span> rotated_backwards <span class="sc">|</span> <span class="fu">abs</span>(angle) <span class="sc">&gt;</span> <span class="dv">135</span></span>
<span id="cb7-2262"><a href="#cb7-2262" aria-hidden="true" tabindex="-1"></a>    inward <span class="ot">&lt;-</span></span>
<span id="cb7-2263"><a href="#cb7-2263" aria-hidden="true" tabindex="-1"></a>      (just <span class="sc">==</span> <span class="st">"inward"</span> <span class="sc">&amp;</span> <span class="sc">!</span>just_swap <span class="sc">|</span> just <span class="sc">==</span> <span class="st">"outward"</span> <span class="sc">&amp;</span> just_swap)</span>
<span id="cb7-2264"><a href="#cb7-2264" aria-hidden="true" tabindex="-1"></a>    just[inward] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"left"</span>, <span class="st">"middle"</span>, <span class="st">"right"</span>)[<span class="fu">just_dir</span>(ab[inward])]</span>
<span id="cb7-2265"><a href="#cb7-2265" aria-hidden="true" tabindex="-1"></a>    outward <span class="ot">&lt;-</span></span>
<span id="cb7-2266"><a href="#cb7-2266" aria-hidden="true" tabindex="-1"></a>      (just <span class="sc">==</span> <span class="st">"outward"</span> <span class="sc">&amp;</span> <span class="sc">!</span>just_swap) <span class="sc">|</span> (just <span class="sc">==</span> <span class="st">"inward"</span> <span class="sc">&amp;</span> just_swap)</span>
<span id="cb7-2267"><a href="#cb7-2267" aria-hidden="true" tabindex="-1"></a>    just[outward] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"right"</span>, <span class="st">"middle"</span>, <span class="st">"left"</span>)[<span class="fu">just_dir</span>(ab[outward])]</span>
<span id="cb7-2268"><a href="#cb7-2268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2269"><a href="#cb7-2269" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2270"><a href="#cb7-2270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2271"><a href="#cb7-2271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unname</span>(<span class="fu">c</span>(<span class="at">left =</span> <span class="dv">0</span>, <span class="at">center =</span> <span class="fl">0.5</span>, <span class="at">right =</span> <span class="dv">1</span>,</span>
<span id="cb7-2272"><a href="#cb7-2272" aria-hidden="true" tabindex="-1"></a>           <span class="at">bottom =</span> <span class="dv">0</span>, <span class="at">middle =</span> <span class="fl">0.5</span>, <span class="at">top =</span> <span class="dv">1</span>)[just])</span>
<span id="cb7-2273"><a href="#cb7-2273" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2274"><a href="#cb7-2274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2275"><a href="#cb7-2275" aria-hidden="true" tabindex="-1"></a><span class="co"># copied from ggplot2</span></span>
<span id="cb7-2276"><a href="#cb7-2276" aria-hidden="true" tabindex="-1"></a>just_dir <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">tol =</span> <span class="fl">0.001</span>) {</span>
<span id="cb7-2277"><a href="#cb7-2277" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">2</span>L, <span class="fu">length</span>(x))</span>
<span id="cb7-2278"><a href="#cb7-2278" aria-hidden="true" tabindex="-1"></a>  out[x <span class="sc">&lt;</span> <span class="fl">0.5</span> <span class="sc">-</span> tol] <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb7-2279"><a href="#cb7-2279" aria-hidden="true" tabindex="-1"></a>  out[x <span class="sc">&gt;</span> <span class="fl">0.5</span> <span class="sc">+</span> tol] <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb7-2280"><a href="#cb7-2280" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb7-2281"><a href="#cb7-2281" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2282"><a href="#cb7-2282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2283"><a href="#cb7-2283" aria-hidden="true" tabindex="-1"></a><span class="co"># Adapted from shadowtext, at the time of writing located at:</span></span>
<span id="cb7-2284"><a href="#cb7-2284" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/GuangchuangYu/shadowtext/blob/325d25919b28ccd4184c6363c11c8c26e822dd95/R/shadowtext-grob.R#L28</span></span>
<span id="cb7-2285"><a href="#cb7-2285" aria-hidden="true" tabindex="-1"></a><span class="co"># This function was modified to always return a gList,</span></span>
<span id="cb7-2286"><a href="#cb7-2286" aria-hidden="true" tabindex="-1"></a><span class="co"># whether bg.colour is NA or not.</span></span>
<span id="cb7-2287"><a href="#cb7-2287" aria-hidden="true" tabindex="-1"></a><span class="co"># Each background textgrob is made to have a unique name, otherwise</span></span>
<span id="cb7-2288"><a href="#cb7-2288" aria-hidden="true" tabindex="-1"></a><span class="co"># it can mess up the plotting order.</span></span>
<span id="cb7-2289"><a href="#cb7-2289" aria-hidden="true" tabindex="-1"></a>shadowtextGrob <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb7-2290"><a href="#cb7-2290" aria-hidden="true" tabindex="-1"></a>    label, <span class="at">x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>), <span class="at">y =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"npc"</span>),</span>
<span id="cb7-2291"><a href="#cb7-2291" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="cn">NULL</span>, <span class="at">vjust =</span> <span class="cn">NULL</span>, <span class="at">rot =</span> <span class="dv">0</span>, <span class="at">check.overlap =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-2292"><a href="#cb7-2292" aria-hidden="true" tabindex="-1"></a>    <span class="at">default.units =</span> <span class="st">"npc"</span>, <span class="at">name =</span> <span class="cn">NULL</span>, <span class="at">gp =</span> <span class="fu">gpar</span>(<span class="at">col=</span><span class="st">"white"</span>), <span class="at">vp =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-2293"><a href="#cb7-2293" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg.colour =</span> <span class="st">"black"</span>, <span class="at">bg.r =</span> <span class="fl">0.1</span></span>
<span id="cb7-2294"><a href="#cb7-2294" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb7-2295"><a href="#cb7-2295" aria-hidden="true" tabindex="-1"></a>  upperGrob <span class="ot">&lt;-</span> <span class="fu">textGrob</span>(</span>
<span id="cb7-2296"><a href="#cb7-2296" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> label, <span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">hjust =</span> hjust,</span>
<span id="cb7-2297"><a href="#cb7-2297" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> vjust, <span class="at">rot =</span> rot, <span class="at">default.units =</span> default.units,</span>
<span id="cb7-2298"><a href="#cb7-2298" aria-hidden="true" tabindex="-1"></a>    <span class="at">check.overlap =</span> check.overlap, <span class="at">name =</span> name, <span class="at">gp =</span> gp, <span class="at">vp =</span> vp</span>
<span id="cb7-2299"><a href="#cb7-2299" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-2300"><a href="#cb7-2300" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-2301"><a href="#cb7-2301" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.na</span>(bg.colour)) {</span>
<span id="cb7-2302"><a href="#cb7-2302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gList</span>(upperGrob)</span>
<span id="cb7-2303"><a href="#cb7-2303" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-2304"><a href="#cb7-2304" aria-hidden="true" tabindex="-1"></a>    gp<span class="sc">$</span>col <span class="ot">&lt;-</span> bg.colour</span>
<span id="cb7-2305"><a href="#cb7-2305" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2306"><a href="#cb7-2306" aria-hidden="true" tabindex="-1"></a>    theta <span class="ot">&lt;-</span> <span class="fu">seq</span>(pi<span class="sc">/</span><span class="dv">8</span>, <span class="dv">2</span><span class="sc">*</span>pi, <span class="at">length.out=</span><span class="dv">16</span>)</span>
<span id="cb7-2307"><a href="#cb7-2307" aria-hidden="true" tabindex="-1"></a>    char <span class="ot">&lt;-</span> <span class="st">"X"</span></span>
<span id="cb7-2308"><a href="#cb7-2308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># char &lt;- substring(label[1], 1, 1)</span></span>
<span id="cb7-2309"><a href="#cb7-2309" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> bg.r[<span class="dv">1</span>]</span>
<span id="cb7-2310"><a href="#cb7-2310" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2311"><a href="#cb7-2311" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(x)) {</span>
<span id="cb7-2312"><a href="#cb7-2312" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">&lt;-</span> <span class="fu">unit</span>(x, default.units)</span>
<span id="cb7-2313"><a href="#cb7-2313" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-2314"><a href="#cb7-2314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.unit</span>(y)) {</span>
<span id="cb7-2315"><a href="#cb7-2315" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">unit</span>(y, default.units)</span>
<span id="cb7-2316"><a href="#cb7-2316" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-2317"><a href="#cb7-2317" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2318"><a href="#cb7-2318" aria-hidden="true" tabindex="-1"></a>    bgList <span class="ot">&lt;-</span> <span class="fu">lapply</span>(theta, <span class="cf">function</span>(i) {</span>
<span id="cb7-2319"><a href="#cb7-2319" aria-hidden="true" tabindex="-1"></a>      x <span class="ot">&lt;-</span> x <span class="sc">+</span> <span class="fu">unit</span>(<span class="fu">cos</span>(i) <span class="sc">*</span> r, <span class="st">"strheight"</span>, <span class="at">data =</span> char)</span>
<span id="cb7-2320"><a href="#cb7-2320" aria-hidden="true" tabindex="-1"></a>      y <span class="ot">&lt;-</span> y <span class="sc">+</span> <span class="fu">unit</span>(<span class="fu">sin</span>(i) <span class="sc">*</span> r, <span class="st">"strheight"</span>, <span class="at">data =</span> char)</span>
<span id="cb7-2321"><a href="#cb7-2321" aria-hidden="true" tabindex="-1"></a>      <span class="fu">textGrob</span>(</span>
<span id="cb7-2322"><a href="#cb7-2322" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> label, <span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">hjust =</span> hjust,</span>
<span id="cb7-2323"><a href="#cb7-2323" aria-hidden="true" tabindex="-1"></a>        <span class="at">vjust =</span> vjust, <span class="at">rot =</span> rot, <span class="at">default.units =</span> default.units,</span>
<span id="cb7-2324"><a href="#cb7-2324" aria-hidden="true" tabindex="-1"></a>        <span class="at">check.overlap =</span> check.overlap, <span class="at">name =</span> <span class="fu">paste0</span>(name, <span class="st">"-shadowtext"</span>, i), <span class="at">gp =</span> gp, <span class="at">vp =</span> vp</span>
<span id="cb7-2325"><a href="#cb7-2325" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb7-2326"><a href="#cb7-2326" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-2327"><a href="#cb7-2327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-2328"><a href="#cb7-2328" aria-hidden="true" tabindex="-1"></a>    <span class="fu">do.call</span>(gList, <span class="fu">c</span>(bgList, <span class="fu">list</span>(upperGrob)))</span>
<span id="cb7-2329"><a href="#cb7-2329" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-2330"><a href="#cb7-2330" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2331"><a href="#cb7-2331" aria-hidden="true" tabindex="-1"></a><span class="co"># Generated by using Rcpp::compileAttributes() -&gt; do not edit by hand</span></span>
<span id="cb7-2332"><a href="#cb7-2332" aria-hidden="true" tabindex="-1"></a><span class="co"># Generator token: 10BE3573-1514-4C36-9D1C-5A225CD40393</span></span>
<span id="cb7-2333"><a href="#cb7-2333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2334"><a href="#cb7-2334" aria-hidden="true" tabindex="-1"></a><span class="co">#' Euclidean distance between two points.</span></span>
<span id="cb7-2335"><a href="#cb7-2335" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A point.</span></span>
<span id="cb7-2336"><a href="#cb7-2336" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A point.</span></span>
<span id="cb7-2337"><a href="#cb7-2337" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return The distance between two points.</span></span>
<span id="cb7-2338"><a href="#cb7-2338" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2339"><a href="#cb7-2339" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2340"><a href="#cb7-2340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2341"><a href="#cb7-2341" aria-hidden="true" tabindex="-1"></a><span class="co">#' Squared Euclidean distance between two points.</span></span>
<span id="cb7-2342"><a href="#cb7-2342" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A point.</span></span>
<span id="cb7-2343"><a href="#cb7-2343" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A point.</span></span>
<span id="cb7-2344"><a href="#cb7-2344" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return The distance between two points.</span></span>
<span id="cb7-2345"><a href="#cb7-2345" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2346"><a href="#cb7-2346" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2347"><a href="#cb7-2347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2348"><a href="#cb7-2348" aria-hidden="true" tabindex="-1"></a><span class="co">#' Move a box into the area specificied by x limits and y limits.</span></span>
<span id="cb7-2349"><a href="#cb7-2349" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2350"><a href="#cb7-2350" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xlim A Point with limits on the x axis like \code{c(xmin, xmax)}</span></span>
<span id="cb7-2351"><a href="#cb7-2351" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ylim A Point with limits on the y axis like \code{c(xmin, xmax)}</span></span>
<span id="cb7-2352"><a href="#cb7-2352" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force Magnitude of the force (defaults to \code{1e-6})</span></span>
<span id="cb7-2353"><a href="#cb7-2353" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2354"><a href="#cb7-2354" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2355"><a href="#cb7-2355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2356"><a href="#cb7-2356" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the coordinates of the center of a box.</span></span>
<span id="cb7-2357"><a href="#cb7-2357" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2358"><a href="#cb7-2358" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2359"><a href="#cb7-2359" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2360"><a href="#cb7-2360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2361"><a href="#cb7-2361" aria-hidden="true" tabindex="-1"></a><span class="co">#' Test if a box overlaps another box.</span></span>
<span id="cb7-2362"><a href="#cb7-2362" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2363"><a href="#cb7-2363" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2364"><a href="#cb7-2364" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2365"><a href="#cb7-2365" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2366"><a href="#cb7-2366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2367"><a href="#cb7-2367" aria-hidden="true" tabindex="-1"></a><span class="co">#' Test if a box overlaps another box.</span></span>
<span id="cb7-2368"><a href="#cb7-2368" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2369"><a href="#cb7-2369" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2370"><a href="#cb7-2370" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2371"><a href="#cb7-2371" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2372"><a href="#cb7-2372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2373"><a href="#cb7-2373" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute the repulsion force upon point \code{a} from point \code{b}.</span></span>
<span id="cb7-2374"><a href="#cb7-2374" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-2375"><a href="#cb7-2375" aria-hidden="true" tabindex="-1"></a><span class="co">#' The force decays with the squared distance between the points, similar</span></span>
<span id="cb7-2376"><a href="#cb7-2376" aria-hidden="true" tabindex="-1"></a><span class="co">#' to the force of repulsion between magnets.</span></span>
<span id="cb7-2377"><a href="#cb7-2377" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-2378"><a href="#cb7-2378" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A point like \code{c(x, y)}</span></span>
<span id="cb7-2379"><a href="#cb7-2379" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A point like \code{c(x, y)}</span></span>
<span id="cb7-2380"><a href="#cb7-2380" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force Magnitude of the force (defaults to \code{1e-6})</span></span>
<span id="cb7-2381"><a href="#cb7-2381" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param direction direction in which to exert force, either "both", "x", or "y"</span></span>
<span id="cb7-2382"><a href="#cb7-2382" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2383"><a href="#cb7-2383" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2384"><a href="#cb7-2384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2385"><a href="#cb7-2385" aria-hidden="true" tabindex="-1"></a><span class="co">#' Compute the spring force upon point \code{a} from point \code{b}.</span></span>
<span id="cb7-2386"><a href="#cb7-2386" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-2387"><a href="#cb7-2387" aria-hidden="true" tabindex="-1"></a><span class="co">#' The force increases with the distance between the points, similar</span></span>
<span id="cb7-2388"><a href="#cb7-2388" aria-hidden="true" tabindex="-1"></a><span class="co">#' to Hooke's law for springs.</span></span>
<span id="cb7-2389"><a href="#cb7-2389" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-2390"><a href="#cb7-2390" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A point like \code{c(x, y)}</span></span>
<span id="cb7-2391"><a href="#cb7-2391" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A point like \code{c(x, y)}</span></span>
<span id="cb7-2392"><a href="#cb7-2392" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force Magnitude of the force (defaults to \code{1e-6})</span></span>
<span id="cb7-2393"><a href="#cb7-2393" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param direction direction in which to exert force, either "both", "x", or "y"</span></span>
<span id="cb7-2394"><a href="#cb7-2394" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2395"><a href="#cb7-2395" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb7-2396"><a href="#cb7-2396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2397"><a href="#cb7-2397" aria-hidden="true" tabindex="-1"></a><span class="co">#' Euclidean distance between two points.</span></span>
<span id="cb7-2398"><a href="#cb7-2398" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param a A numeric vector.</span></span>
<span id="cb7-2399"><a href="#cb7-2399" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A numeric vector.</span></span>
<span id="cb7-2400"><a href="#cb7-2400" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return The distance between two points.</span></span>
<span id="cb7-2401"><a href="#cb7-2401" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2402"><a href="#cb7-2402" aria-hidden="true" tabindex="-1"></a>euclid <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb7-2403"><a href="#cb7-2403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_euclid'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, a, b)</span>
<span id="cb7-2404"><a href="#cb7-2404" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2405"><a href="#cb7-2405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2406"><a href="#cb7-2406" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get the coordinates of the center of a box.</span></span>
<span id="cb7-2407"><a href="#cb7-2407" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A box like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2408"><a href="#cb7-2408" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2409"><a href="#cb7-2409" aria-hidden="true" tabindex="-1"></a>centroid <span class="ot">&lt;-</span> <span class="cf">function</span>(b, hjust, vjust) {</span>
<span id="cb7-2410"><a href="#cb7-2410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_centroid'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, b, hjust, vjust)</span>
<span id="cb7-2411"><a href="#cb7-2411" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2412"><a href="#cb7-2412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2413"><a href="#cb7-2413" aria-hidden="true" tabindex="-1"></a><span class="co">#' Find the intersections between a line and a rectangle.</span></span>
<span id="cb7-2414"><a href="#cb7-2414" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param c A circle like \code{c(x, y, r)}</span></span>
<span id="cb7-2415"><a href="#cb7-2415" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param r A rectangle like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2416"><a href="#cb7-2416" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2417"><a href="#cb7-2417" aria-hidden="true" tabindex="-1"></a>intersect_circle_rectangle <span class="ot">&lt;-</span> <span class="cf">function</span>(c, r) {</span>
<span id="cb7-2418"><a href="#cb7-2418" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_intersect_circle_rectangle'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, c, r)</span>
<span id="cb7-2419"><a href="#cb7-2419" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2420"><a href="#cb7-2420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2421"><a href="#cb7-2421" aria-hidden="true" tabindex="-1"></a><span class="co">#' Find the intersection between a line and a circle.</span></span>
<span id="cb7-2422"><a href="#cb7-2422" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p1 A point on the line like \code{c(x, y)}</span></span>
<span id="cb7-2423"><a href="#cb7-2423" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p2 A point at the circle's center</span></span>
<span id="cb7-2424"><a href="#cb7-2424" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param r The circle's radius</span></span>
<span id="cb7-2425"><a href="#cb7-2425" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2426"><a href="#cb7-2426" aria-hidden="true" tabindex="-1"></a>intersect_line_circle <span class="ot">&lt;-</span> <span class="cf">function</span>(p1, p2, r) {</span>
<span id="cb7-2427"><a href="#cb7-2427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_intersect_line_circle'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, p1, p2, r)</span>
<span id="cb7-2428"><a href="#cb7-2428" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2429"><a href="#cb7-2429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2430"><a href="#cb7-2430" aria-hidden="true" tabindex="-1"></a><span class="co">#' Find the intersections between a line and a rectangle.</span></span>
<span id="cb7-2431"><a href="#cb7-2431" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p1 A point like \code{c(x, y)}</span></span>
<span id="cb7-2432"><a href="#cb7-2432" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param p2 A point like \code{c(x, y)}</span></span>
<span id="cb7-2433"><a href="#cb7-2433" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param b A rectangle like \code{c(x1, y1, x2, y2)}</span></span>
<span id="cb7-2434"><a href="#cb7-2434" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2435"><a href="#cb7-2435" aria-hidden="true" tabindex="-1"></a>intersect_line_rectangle <span class="ot">&lt;-</span> <span class="cf">function</span>(p1, p2, b) {</span>
<span id="cb7-2436"><a href="#cb7-2436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_intersect_line_rectangle'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, p1, p2, b)</span>
<span id="cb7-2437"><a href="#cb7-2437" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2438"><a href="#cb7-2438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2439"><a href="#cb7-2439" aria-hidden="true" tabindex="-1"></a>select_line_connection <span class="ot">&lt;-</span> <span class="cf">function</span>(p1, b) {</span>
<span id="cb7-2440"><a href="#cb7-2440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_select_line_connection'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, p1, b)</span>
<span id="cb7-2441"><a href="#cb7-2441" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2442"><a href="#cb7-2442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2443"><a href="#cb7-2443" aria-hidden="true" tabindex="-1"></a>approximately_equal <span class="ot">&lt;-</span> <span class="cf">function</span>(x1, x2) {</span>
<span id="cb7-2444"><a href="#cb7-2444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_approximately_equal'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, x1, x2)</span>
<span id="cb7-2445"><a href="#cb7-2445" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-2446"><a href="#cb7-2446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2447"><a href="#cb7-2447" aria-hidden="true" tabindex="-1"></a><span class="co">#' Adjust the layout of a list of potentially overlapping boxes.</span></span>
<span id="cb7-2448"><a href="#cb7-2448" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data_points A numeric matrix with rows representing points like</span></span>
<span id="cb7-2449"><a href="#cb7-2449" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{rbind(c(x, y), c(x, y), ...)}</span></span>
<span id="cb7-2450"><a href="#cb7-2450" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param point_size A numeric vector representing the sizes of data points.</span></span>
<span id="cb7-2451"><a href="#cb7-2451" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param point_padding_x Padding around each data point on the x axis.</span></span>
<span id="cb7-2452"><a href="#cb7-2452" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param point_padding_y Padding around each data point on the y axis.</span></span>
<span id="cb7-2453"><a href="#cb7-2453" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param boxes A numeric matrix with rows representing boxes like</span></span>
<span id="cb7-2454"><a href="#cb7-2454" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{rbind(c(x1, y1, x2, y2), c(x1, y1, x2, y2), ...)}</span></span>
<span id="cb7-2455"><a href="#cb7-2455" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xlim A numeric vector representing the limits on the x axis like</span></span>
<span id="cb7-2456"><a href="#cb7-2456" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{c(xmin, xmax)}</span></span>
<span id="cb7-2457"><a href="#cb7-2457" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ylim A numeric vector representing the limits on the y axis like</span></span>
<span id="cb7-2458"><a href="#cb7-2458" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \code{c(ymin, ymax)}</span></span>
<span id="cb7-2459"><a href="#cb7-2459" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param force Magnitude of the force (defaults to \code{1e-6})</span></span>
<span id="cb7-2460"><a href="#cb7-2460" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max_time Maximum number of seconds to try to resolve overlaps</span></span>
<span id="cb7-2461"><a href="#cb7-2461" aria-hidden="true" tabindex="-1"></a><span class="co">#'   (defaults to 0.1)</span></span>
<span id="cb7-2462"><a href="#cb7-2462" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max_iter Maximum number of iterations to try to resolve overlaps</span></span>
<span id="cb7-2463"><a href="#cb7-2463" aria-hidden="true" tabindex="-1"></a><span class="co">#'   (defaults to 2000)</span></span>
<span id="cb7-2464"><a href="#cb7-2464" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb7-2465"><a href="#cb7-2465" aria-hidden="true" tabindex="-1"></a>repel_boxes2 <span class="ot">&lt;-</span> <span class="cf">function</span>(data_points, point_size, point_padding_x, point_padding_y, boxes, xlim, ylim, hjust, vjust, <span class="at">force_push =</span> <span class="fl">1e-7</span>, <span class="at">force_pull =</span> <span class="fl">1e-7</span>, <span class="at">max_time =</span> <span class="fl">0.1</span>, <span class="at">max_overlaps =</span> <span class="dv">10</span>, <span class="at">max_iter =</span> <span class="dv">2000</span>L, <span class="at">direction =</span> <span class="st">"both"</span>, <span class="at">verbose =</span> <span class="dv">0</span>L) {</span>
<span id="cb7-2466"><a href="#cb7-2466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">'_ggrepel_repel_boxes2'</span>, <span class="at">PACKAGE =</span> <span class="st">'ggrepel'</span>, data_points, point_size, point_padding_x, point_padding_y, boxes, xlim, ylim, hjust, vjust, force_push, force_pull, max_time, max_overlaps, max_iter, direction, verbose)</span>
<span id="cb7-2467"><a href="#cb7-2467" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-repelled-marquee-text-plot" class="level3">
<h3 class="anchored" data-anchor-id="create-repelled-marquee-text-plot">Create repelled marquee text plot</h3>
<p>This map leverages <a href="https://github.com/slowkow/ggrepel"><code>geom_marquee_repel()</code></a> to create richly formatted, non-overlapping labels for 37 UK Met Office weather stations, each displaying the station name, opening year, and three color-coded climate extremes (maximum temperature in red, minimum temperature in teal, and maximum rainfall in blue). The implementation uses <a href="https://github.com/r-lib/marquee"><code>marquee::marquee_glue()</code></a> to construct markdown-formatted labels with custom colors and bold text, while the repulsion algorithm (controlled by <code>force = 5</code> and <code>force_pull = 0.5</code> parameters) automatically positions these labels to avoid overlaps with both the data points and each other. The styling is managed through <a href="https://github.com/r-lib/marquee"><code>marquee::classic_style()</code></a>, which sets a condensed, lightweight font with custom line height and center alignment, while <a href="https://ggplot2.tidyverse.org/reference/ggsf.html"><code>ggplot2::geom_sf()</code></a> renders the base map and weather station points. Additional annotations are added using <a href="https://github.com/wilkelab/ggtext"><code>ggtext::element_markdown()</code></a> for the caption and <a href="https://ggplot2.tidyverse.org/reference/annotate.html"><code>annotate()</code></a> with <code>geom = "richtext"</code> for the legend. This combination of <a href="https://github.com/r-lib/marquee"><strong>{marquee}</strong></a>’s rich text capabilities and <a href="https://github.com/slowkow/ggrepel"><strong>{ggrepel}</strong></a>’s intelligent positioning creates a clean, readable visualization that would be difficult to achieve with standard <a href="https://ggplot2.tidyverse.org/"><strong>{ggplot2}</strong></a> text geoms, especially given the density of information and the geographic constraints of the map.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>bts <span class="ot">=</span> <span class="dv">140</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plot_subtitle <span class="ot">&lt;-</span> <span class="st">"Visualizing historic meteorological</span><span class="sc">\n</span><span class="st">data from 37 UK Met Office weather</span><span class="sc">\n</span><span class="st">stations (1853-2025).</span><span class="sc">\n</span><span class="st"> </span><span class="sc">\n</span><span class="st">Created by combining</span><span class="sc">\n</span><span class="st">{ggplot2}, {ggrepel}, and</span><span class="sc">\n</span><span class="st">{marquee} + {ggtext} to</span><span class="sc">\n</span><span class="st">display extreme</span><span class="sc">\n</span><span class="st">temperature and</span><span class="sc">\n</span><span class="st">rainfall records</span><span class="sc">\n</span><span class="st">across Britain."</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> plotdf <span class="sc">|&gt;</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> british_map,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">fill =</span> name),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">0.3</span>,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey80"</span>, <span class="st">"grey50"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">6</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_col,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.9</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">pch =</span> <span class="dv">20</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_marquee_repel</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">label =</span> marquee<span class="sc">::</span><span class="fu">marquee_glue</span>(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"### {#4d4d4d {station_name}} "</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"{#4d4d4d ({opened})} </span><span class="sc">\n</span><span class="st"> "</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"{#D9565CFF **{tmax}**} ({tmax_month}) </span><span class="sc">\n</span><span class="st"> </span><span class="sc">\n</span><span class="st">  "</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"{#1BB6AFFF **{tmin}**} ({tmin_month})  </span><span class="sc">\n</span><span class="st"> </span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"{#0076C0FF **{rain}**} ({rain_month})"</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">geometry =</span> geometry</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">"sf_coordinates"</span>,</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">force =</span> <span class="dv">5</span>,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">force_pull =</span> <span class="fl">0.5</span>,</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">42</span>,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.segment.length =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">"mm"</span>),</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.colour =</span> text_col,         <span class="co"># Change segment color</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.size =</span> <span class="fl">0.3</span>,                <span class="co"># Adjust line thickness</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">segment.alpha =</span> <span class="dv">1</span>,                 <span class="co"># Adjust transparency</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">box.padding =</span> <span class="fl">0.5</span>, </span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">style =</span> marquee<span class="sc">::</span><span class="fu">classic_style</span>(</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">weight      =</span> <span class="st">"light"</span>,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">width       =</span> <span class="st">"condensed"</span>,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">base_size   =</span> bts <span class="sc">/</span> <span class="dv">16</span>,</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">lineheight  =</span> <span class="fl">0.5</span>,</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">color       =</span> text_hil,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">background  =</span> <span class="cn">NA</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">align       =</span> <span class="st">"center"</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin      =</span> marquee<span class="sc">::</span><span class="fu">trbl</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">padding     =</span> marquee<span class="sc">::</span><span class="fu">trbl</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"richtext"</span>,</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="fl">8.3</span>,</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">51.5</span>,</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="fu">paste0</span>(</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts, <span class="st">"pt;'&gt;"</span>,</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Met Station"</span>, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts, <span class="st">"pt;'&gt; ("</span>, </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Year Opened"</span>, <span class="st">")&lt;/span&gt;&lt;br&gt;"</span>,</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#D9565CFF;'&gt;"</span>,</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Max. Recorded Temp."</span>, <span class="st">"&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;span style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt;'&gt;&lt;/span&gt;"</span>,</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#1BB6AFFF;'&gt;"</span>,</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Min. Recorded Temp."</span>, <span class="st">"&lt;/b&gt;"</span>,</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;br&gt;"</span>,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;b style='font-size:"</span>, bts<span class="sc">/</span><span class="fl">1.5</span>, <span class="st">"pt; color:#0076C0FF;'&gt;"</span>,</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Max. Recorded Rainfall"</span>, <span class="st">"&lt;/b&gt;"</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.7</span>,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_col,</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NA</span>,</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">label.size =</span> <span class="cn">NA</span>,</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="fl">0.5</span>,</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add plot_title and plot_subtitle</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="fl">12.5</span>,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">60.3</span>,</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span>,</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> plot_title,</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> bts  <span class="sc">/</span> <span class="fl">1.8</span>,</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.3</span>,</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"body_font"</span>,</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil,</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">"text"</span>,</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="sc">-</span><span class="dv">12</span>,</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="dv">59</span>,</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="dv">0</span>,</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">vjust =</span> <span class="dv">1</span>,</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> plot_subtitle,</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> bts  <span class="sc">/</span> <span class="fl">4.5</span>,</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">lineheight =</span> <span class="fl">0.3</span>,</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">"body_font"</span>,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> text_hil,</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">fontface =</span> <span class="st">"bold"</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">crs =</span> <span class="st">"EPSG:27700"</span>,</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">default_crs =</span> <span class="st">"EPSG:4326"</span>,</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">3</span>),</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">clip =</span> <span class="st">"off"</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">48</span>, <span class="dv">62</span>, <span class="at">by =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> plot_caption,</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> bts <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overall</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">text =</span> <span class="fu">element_text</span>(</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> text_col,</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>      <span class="at">lineheight =</span> <span class="fl">0.3</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Grid Lines and Axes Text</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">0.3</span>,</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="dv">1</span>,</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">alpha</span>(text_hil, <span class="fl">0.3</span>)</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.length =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_markdown</span>(</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="st">"caption_font"</span>,</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">hjust =</span> <span class="dv">1</span>,</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="fu">margin</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">0</span>, <span class="st">"mm"</span>),</span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>      <span class="at">colour =</span> text_hil,</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> bts <span class="sc">/</span> <span class="dv">3</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title.position =</span> <span class="st">"plot"</span>,</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">5</span>, <span class="st">"mm"</span>)</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> here<span class="sc">::</span><span class="fu">here</span>(</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data_vizs"</span>,</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tidy_uk_meteorological_data2.png"</span></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot =</span> g,</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>  <span class="at">width =</span> <span class="dv">400</span>,</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">height =</span> <span class="dv">500</span>,</span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">units =</span> <span class="st">"mm"</span>,</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">bg =</span> bg_col</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tidy_uk_meteorological_data2.png" class="img-fluid figure-img"></p>
<figcaption>This map displays historic meteorological data from 37 UK Met Office weather stations spanning 1853-2025. Each station is labeled with its name and opening year, followed by three key climate extremes: the highest temperature ever recorded (shown in red), the lowest temperature ever recorded (shown in teal), and the maximum rainfall in a 24-hour period (shown in blue). Notable patterns emerge across the geography: southern England recorded the hottest temperatures (exceeding 40°C at Heathrow in 2022), Scotland’s highlands experienced the coldest conditions (below -27°C at Braemar and Altnaharra), and western coastal regions saw the highest rainfall totals (over 300mm in places like Seathwaite). This visualization demonstrates how modern R packages—{ggplot2}, {ggrepel}, {marquee}, and {ggtext}—can be combined to create information-dense yet readable maps that reveal spatial patterns in long-term climate data.</figcaption>
</figure>
</div>


</section>
</section>
</section>
<section class="level1">
<h1>Links</h1>
<ul>
<li><a href="https://www.metoffice.gov.uk/">UK Met Office</a></li>
<li><a href="https://www.metoffice.gov.uk/research/climate/maps-and-data/historic-station-data">historic station data collection</a></li>
<li><a href="https://www.metoffice.gov.uk/">Met Office</a></li>
<li><a href="https://epsg.io/4326">EPSG:4326 format</a></li>
<li><a href="https://github.com/jack-davison">Jack Davison</a></li>
<li><a href="https://github.com/rfordatascience/tidytuesday">#TidyTuesday</a></li>
<li><a href="https://github.com/slowkow/ggrepel/tree/0bbdee8174712929f297da6f0e4170059b0a9344/R">ggrepel R directory</a></li>
<li><a href="https://github.com/teunbrand">teunbrand</a></li>
<li><a href="https://github.com/slowkow/ggrepel"><code>geom_marquee_repel()</code></a></li>
<li><a href="https://github.com/r-lib/marquee"><code>marquee::marquee_glue()</code></a></li>
<li><a href="https://github.com/r-lib/marquee"><code>marquee::classic_style()</code></a></li>
<li><a href="https://ggplot2.tidyverse.org/reference/ggsf.html"><code>ggplot2::geom_sf()</code></a></li>
<li><a href="https://github.com/wilkelab/ggtext"><code>ggtext::element_markdown()</code></a></li>
<li><a href="https://ggplot2.tidyverse.org/reference/annotate.html"><code>annotate()</code></a></li>
<li><a href="https://github.com/r-lib/marquee"><strong>{marquee}</strong></a></li>
<li><a href="https://github.com/slowkow/ggrepel"><strong>{ggrepel}</strong></a></li>
<li><a href="https://ggplot2.tidyverse.org/"><strong>{ggplot2}</strong></a></li>
</ul>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/aditya-dahiya\.github\.io\/projects_presentations\/projects\.html");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="Aditya-Dahiya/projects_presentations" data-repo-id="R_kgDOKfYMKg" data-category="General" data-category-id="DIC_kwDOKfYMKs4Cjtbe" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/Aditya-Dahiya/projects_presentations/edit/main/data_vizs/tidy_uk_meteorological_data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/Aditya-Dahiya/projects_presentations/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><div class="page-columns page-rows-contents page-layout-article"><div class="social-share"><a href="https://twitter.com/share?url=https://aditya-dahiya.github.io/projects_presentations/data_vizs.html&amp;text=UK Weather Extremes: A Century of Records" target="_blank" class="twitter"><i class="fab fa-twitter fa-fw fa-lg"></i></a><a href="https://www.linkedin.com/shareArticle?url=https://aditya-dahiya.github.io/projects_presentations/data_vizs.html&amp;title=UK Weather Extremes: A Century of Records" target="_blank" class="linkedin"><i class="fa-brands fa-linkedin-in fa-fw fa-lg"></i></a>  <a href="mailto:?subject=UK Weather Extremes: A Century of Records&amp;body=Check out this link:https://aditya-dahiya.github.io/projects_presentations/data_vizs.html" target="_blank" class="email"><i class="fa-solid fa-envelope fa-fw fa-lg"></i></a><a href="javascript:void(0);" onclick="var mastodon_instance=prompt('Mastodon Instance / Server Name?'); if(typeof mastodon_instance==='string' &amp;&amp; mastodon_instance.length){this.href='https://'+mastodon_instance+'/share?text=UK Weather Extremes: A Century of Records https://aditya-dahiya.github.io/projects_presentations/data_vizs.html'}else{return false;}" target="_blank" class="mastodon"><i class="fa-brands fa-mastodon fa-fw fa-lg"></i></a></div></div>




</body></html>